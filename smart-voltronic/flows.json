[{"id":"6cc971c47e7a3b59","type":"tab","label":"‚öôÔ∏è Config","disabled":false,"info":""},{"id":"7f91cc5ad88a7cf9","type":"tab","label":"üîå Voltronic","disabled":false,"info":""},{"id":"0f637b517ebf7066","type":"tab","label":"üì° MQTT","disabled":false,"info":""},{"id":"860d5c4e8609e907","type":"tab","label":"Config","disabled":true,"info":"","env":[]},{"id":"a75e6cc9dd444ba5","type":"tab","label":"mqtt_ha","disabled":true,"info":"Definir la correspondance avec ha","env":[]},{"id":"23fac679e003f079","type":"tab","label":"Voltronic","disabled":true,"info":""},{"id":"c315db128200ad39","type":"group","z":"23fac679e003f079","name":"Boucle d'acquisition des donn√©es de l'onduleur.","style":{"stroke":"#0070c0","label":true,"color":"#0070c0"},"nodes":["2b05956ffa6b4a84","e0e8dda3858d970d","b72693f388145808","6544a153845b273e","d14faaffe9623ee2","e7d8b9a3ef633c6f","3dc894e5057e376a","b76bdfb2968680e4","314bda3f05581f75","62bfa1620ae32998","f0bc5109d49ccdbd"],"x":574,"y":-21,"w":552,"h":222},{"id":"334bc0f1b0993a0a","type":"group","z":"23fac679e003f079","name":"Analyse des r√©ponses provenant de l'onduleur","style":{"stroke":"#0070c0","label":true,"color":"#0070c0"},"nodes":["ba7280d2d277b1ad","aee9639d9e60f5e8","cc8cf2352fce7583","1f82fe719a9f5c56","0f8ef052cd286465","3b2067bc6f66ea6f","51cd001b037a10fa","2c3ddb001437c672","560db185d5319340","507ec00ee8a2ec38"],"x":34,"y":659,"w":1092,"h":242},{"id":"f47960d36038d6ab","type":"group","z":"860d5c4e8609e907","name":"mqtt connect","style":{"label":true},"nodes":["7cde8836021a122e","e7978b594a2ba601","e31d2afc75db6e57","92ce5c0daa108b5e","6f7a976318f3f122","5473c4b21f7c5529","8dc998ce14051b15","3f926d588614512c","2b7e2663dafc533e","4ee71da3f395283e"],"x":14,"y":279,"w":1092,"h":222},{"id":"2dd6bd7d1ec3df70","type":"group","z":"860d5c4e8609e907","name":"Copie du config.json pour la version node red","style":{"label":true},"nodes":["05d2344dbcd22c18","5b93e8225e649888"],"x":14,"y":171.5,"w":1092,"h":97},{"id":"507284d7df5c5d3a","type":"group","z":"23fac679e003f079","name":"Retour mqtt","style":{"label":true},"nodes":["74b9f6c0a52fa743","d890192e3f53421b","823de09da16f4b38","1b601085884ce90b","4a430c5f47a7c3b0","35f0b0ecfdf45c73","3b47f0fb176cb423","2c30668d470b346d"],"x":34,"y":959,"w":1092,"h":122},{"id":"8328309f0d2809d0","type":"group","z":"23fac679e003f079","name":"Requ√™te + Firmware. 1 fois au d√©marrage de NR","style":{"stroke":"#0070c0","label":true,"color":"#0070c0"},"nodes":["03d1b46d68726112","ea3cb00df028aa79","963af7f967767a27","755d8ce91f40ed9d"],"x":34,"y":-1,"w":522,"h":82},{"id":"20319798fb911621","type":"group","z":"23fac679e003f079","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["e1e94763050c5990","f4d4e1d53c2686eb","53b2b762901c8fbe","f73f8d60181cb3ab","6968828185f8ede8","dc48ab8181332f18","a136e3043da3957f","ae23efe98dbf4861","ad531d1dc075be41","27a565eacdb5c7fa","cf58391695c08e47","9c2fbc7c91220f5a","d38feb3754bfe16a","014f259b95c7699f","6eaf61501f158c84","8710a130a740b04a"],"x":374,"y":359,"w":752,"h":282},{"id":"021aca70c76e5e8e","type":"group","z":"860d5c4e8609e907","name":"Configuration des serials","style":{"label":true},"nodes":["9d446c660ae43340","83bb99f3a60d51e3","4a715e5c6917c9e0","cc2917a77b6cd1f1","5402f5af22372444","8f1237b869c14ea1","8555e5bb36cc62d7","6f2d5d63ff8a1996","e6814947783104d0","6f8d921dbbde0f9b","702384d56cbcae73","eab61bd9398d6404","3c0cc6ecf43cc696","24e6d36d354142dc","a22ecc7b93d0d1e7","526384e443060a46","3d583a0afa7c3bf9","a9e014a7f18a4aa2","784ff393358ed198"],"x":14,"y":519,"w":1092,"h":282},{"id":"64c5ac6c0424061a","type":"group","z":"860d5c4e8609e907","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["25d5b6b56574fc7d","c695bee4d439be37","4356850d9cb67b91"],"x":14,"y":1019,"w":1092,"h":82},{"id":"1a4e378ad246919d","type":"group","z":"a75e6cc9dd444ba5","name":"Onduleur","style":{"label":true,"stroke":"#ffbfbf","fill":"#ffbfbf","fill-opacity":"0.5"},"nodes":["a3557245e092b263","0b85c8e85d257ed5","3bbb09fd75d4dac2","3cec1b2e07a5270d","71fdceed8c229052","3e480f13bec09ad4","4345bf1803993c24","29ace0eb1724946e","0aa48cfc8610dc17","3e9f7fa1329725af","9a22828b2b245873","a1a1d92bf37b70c1","c8870c9f0ef4e1cf"],"x":18,"y":213,"w":1068,"h":728},{"id":"07984b471c8206fe","type":"group","z":"a75e6cc9dd444ba5","name":"Config","style":{"label":true},"nodes":["c1f27b019f2b162d","2f880ae1f7af646f","2a75a681802ec1b2","4f3505c5edd531d1","9288eb4f7f914c95","7b023de548513584","03252685a38cb7c8","df3ae9e51097969c","4a70884bd190b1ae"],"x":24,"y":79,"w":1052,"h":122},{"id":"0b85c8e85d257ed5","type":"group","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"select","style":{"label":true},"nodes":["6dabbcf4fa89e32f","da77f62a0e0b2d07","26d935d1f1c88c85","62233f54e0322608"],"x":44,"y":579,"w":722,"h":82},{"id":"3bbb09fd75d4dac2","type":"group","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"sensor","style":{"label":true},"nodes":["d01723e538d41be2","5794af442715a4f1","717d8ea229eec645","a55dea0751634bf1","9a4bc966849d6517","894c3ada9d213ed0","a98daf18f2b7c53e","fa5efaca50dc48b7","8626e3e7f27b61bb","af76dae58fd6e040","2963aa6a856673ee"],"x":44,"y":239,"w":722,"h":362},{"id":"3e480f13bec09ad4","type":"group","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"Button","style":{"label":true},"nodes":["a09c7c808def6025","b3524695f7b5c3d3","d71e5964f9c19d3d"],"x":44,"y":679,"w":522,"h":82},{"id":"29ace0eb1724946e","type":"group","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"text","style":{"label":true},"nodes":["c01a1336eb929025","e12d24b3d57ae8c8","aa9083275d3a7a7e"],"x":44,"y":779,"w":522,"h":82},{"id":"mqtt_broker","type":"mqtt-broker","name":"HA MQTT Broker","broker":"core-mosquitto","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"c546b54ae425b9d2","type":"serial-port","serialport":"/dev/serial/by-id/usb-Prolific_Technology_Inc._ATEN_USB_to_Serial_Bridge_EDBNl117620-if00-port0","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"3000"},{"id":"55a40ce3e960db15","type":"serial-port","serialport":"/dev/serial/by-id/usb-Prolific_Technology_Inc._ATEN_USB_to_Serial_Bridge_FNDCb113318-if00-port0","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"3000"},{"id":"a70fef526976f555","type":"global-config","env":[],"modules":{"node-red-node-serialport":"2.0.3"}},{"id":"3f128fc7b3eaf075","type":"serial-port","name":"","serialport":"/dev/tty-onduleur","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"900"},{"id":"7eb926b832168904","type":"mqtt-broker","name":"MQTT-Onduleur","broker":"localhost","port":"1883","clientid":"","autoConnect":false,"usetls":false,"compatmode":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"1","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"8f8f04570bb20a6b","type":"serial-port","name":"","serialport":"/dev/tty-onduleur2","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"900"},{"id":"e9cc506ca82e0dcd","type":"serial-port","name":"","serialport":"/dev/tty-onduleur3","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"900"},{"id":"7e4f5bc8b4fd8bf3","type":"serial-port","name":"","serialport":"/dev/tty-onduleur4","serialbaud":"2400","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\r","bin":"false","out":"char","addchar":"","responsetimeout":"900"},{"id":"2f656901c2de4368","type":"mqtt-broker","name":"","broker":"MQTT Interne","port":"1883","clientid":"","autoConnect":false,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"7ed2d98a2bc494c9","type":"inject","z":"6cc971c47e7a3b59","name":"‚è∞ Au d√©marrage","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":150,"y":100,"wires":[["6e137315d3bda30d"]]},{"id":"6e137315d3bda30d","type":"function","z":"6cc971c47e7a3b59","name":"üìö Helpers Library","func":"function crc16(str, crc = 0, xorout = 0) {\n    for (let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return (crc ^ xorout) & 0xFFFF;\n}\n\nfunction buildVoltronicCommand(command, option = \"\") {\n    const fullCommand = `${command}${option}`;\n\n    // payload ASCII\n    const payload = Buffer.from(fullCommand, \"ascii\");\n\n    // CRC16 (2 bytes big-endian)\n    const crc = crc16(fullCommand);\n    const crcBuf = Buffer.alloc(2);\n    crcBuf.writeUInt16BE(crc, 0);\n\n    // CR\n    const cr = Buffer.from([0x0D]);\n\n    // payload + crc + CR\n    return Buffer.concat([payload, crcBuf, cr]);\n}\n\nfunction parseVoltronicResponse(input) {\n    if (input == null) return null;\n\n    // Buffer ou String -> Buffer\n    let buf = Buffer.isBuffer(input) ? input : Buffer.from(String(input), \"binary\");\n\n    // Retirer les fins CR/LF\n    while (buf.length && (buf[buf.length - 1] === 0x0D || buf[buf.length - 1] === 0x0A)) {\n        buf = buf.slice(0, -1);\n    }\n\n    // Minimum: \"(\" + CRC(2) ou \"NAK\" + CRC(2)\n    if (buf.length < 3) return null;\n\n    // Retirer CRC (2 derniers octets)\n    if (buf.length >= 2) buf = buf.slice(0, -2);\n\n    // Convertir en ASCII (les r√©ponses Voltronic sont ASCII)\n    let s = buf.toString(\"ascii\").trim();\n\n    // Enlever '(' si pr√©sent\n    if (s.startsWith(\"(\")) s = s.slice(1);\n\n    s = s.trim();\n    return s || null;\n}\n\nglobal.set(\"helpers\", {\n    crc16,\n    buildVoltronicCommand,\n    parseVoltronicResponse\n});\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"Helpers OK (Voltronic CRC/parse)\" });\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":100,"wires":[["8479d7d8ded0a7d0"]]},{"id":"8479d7d8ded0a7d0","type":"link out","z":"6cc971c47e7a3b59","name":"link out 2","mode":"link","links":["3653237078e0be1a"],"x":575,"y":100,"wires":[]},{"id":"b8cd878b662dad6e","type":"inject","z":"6cc971c47e7a3b59","name":"init config","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":220,"wires":[["aaf11df621b6164d"]]},{"id":"aaf11df621b6164d","type":"file in","z":"6cc971c47e7a3b59","name":"","filename":"/data/options.json","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":330,"y":220,"wires":[["af6fa52379fdb919"]]},{"id":"af6fa52379fdb919","type":"function","z":"6cc971c47e7a3b59","name":"parse options","func":"let opts;\ntry {\n  opts = JSON.parse(msg.payload);\n} catch (e) {\n  node.error(\"options.json invalide: \" + e.toString(), msg);\n  node.status({ fill: \"red\", shape: \"ring\", text: \"options.json invalide\" });\n  return null;\n}\n\nconst serialPorts = (opts.serial_ports || [])\n  .filter(p => typeof p === \"string\")\n  .map(p => p.trim())\n  .filter(p => p.length > 0);\n\n// ‚úÖ s√©curit√©: ne pas √©craser une config existante avec une liste vide\nif (serialPorts.length === 0) {\n  const existing = global.get(\"config.serialPorts\") || [];\n  global.set(\"config.invertersCount\", existing.length); // ‚úÖ important\n  node.warn(\"Init: serial_ports vide -> on ne remplace pas la config existante (\" + existing.length + \" port(s))\");\n  node.status({ fill: \"yellow\", shape: \"ring\", text: `serial_ports vide (garde ${existing.length})` });\n  msg.payload = { inverters: existing.length, serialPorts: existing, skipped: true };\n  return msg;\n}\n\nconst mqttConfig = {\n  baseTopic: opts.mqtt_prefix || \"voltronic\",\n  discoveryPrefix: \"homeassistant\",\n  deviceName: \"Onduleur Voltronic\",\n  broker: opts.mqtt_host || \"core-mosquitto\",\n  port: opts.mqtt_port || 1883\n};\n\n// ‚úÖ polling fast robuste\nconst fastSecRaw = (opts.polling_fast ?? opts.polling?.fast ?? 5);\nconst fastSec = Number(fastSecRaw);\nconst pollingFastMs = (Number.isFinite(fastSec) && fastSec > 0 ? fastSec : 5) * 1000;\n\n// ‚úÖ √©crire la config globale\nglobal.set(\"config.serialPorts\", serialPorts);\nglobal.set(\"config.mqtt\", mqttConfig);\nglobal.set(\"config.pollingFastMs\", pollingFastMs);\n\n// ‚úÖ nettoyer d'anciens slots si le nombre de ports a diminu√©\nconst prevCount = global.get(\"config.invertersCount\") || 0;\nfor (let i = serialPorts.length + 1; i <= prevCount; i++) {\n  global.set(`inverter_${i}.port`, null);\n  global.set(`inverter_${i}.data`, {});\n  global.set(`inverter_${i}.lastUpdate`, 0);\n}\nglobal.set(\"config.invertersCount\", serialPorts.length);\n\n// ‚úÖ initialiser autant d'onduleurs que de ports\nfor (let i = 0; i < serialPorts.length; i++) {\n  const inverterNum = i + 1;\n  global.set(`inverter_${inverterNum}.port`, serialPorts[i]);\n  if (!global.get(`inverter_${inverterNum}.data`)) global.set(`inverter_${inverterNum}.data`, {});\n  global.set(`inverter_${inverterNum}.lastUpdate`, 0);\n}\n\nnode.status({\n  fill: \"green\",\n  shape: \"dot\",\n  text: `Config OK (${serialPorts.length} port(s))`\n});\n\nmsg.payload = {\n  inverters: serialPorts.length,\n  serialPorts,\n  mqtt: { broker: mqttConfig.broker, port: mqttConfig.port, baseTopic: mqttConfig.baseTopic },\n  pollingFastMs\n};\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":220,"wires":[["24668416a2be99f6"]]},{"id":"24668416a2be99f6","type":"debug","z":"6cc971c47e7a3b59","name":"debug 2","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":700,"y":140,"wires":[]},{"id":"90819568b0ef542e","type":"inject","z":"7f91cc5ad88a7cf9","name":"‚è±Ô∏è Poll QPIGS (5s)","props":[{"p":"payload"}],"repeat":"1.5","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":120,"y":60,"wires":[["d453962b8538e2fc","7f2df65a070bf567"]]},{"id":"d453962b8538e2fc","type":"function","z":"7f91cc5ad88a7cf9","name":"requetes ","func":"const serialPorts = global.get(\"config.serialPorts\") || [];\nif (!serialPorts.length) return null;\n\nconst now = Date.now();\nconst ACTIVE_WINDOW_MS = 30000;\nconst out = [];\n\n// --- Mode: commande impos√©e (stats) ou polling (QPIGS/QPIGS2) ---\nconst forcedCmd = (msg.command || msg._cmd || \"\").toString().trim().toUpperCase();\nconst isForced = forcedCmd.length > 0;\n\n// Whitelist\nconst ALLOWED = new Set([\"QPIGS\", \"QPIGS2\", \"QED\", \"QLD\", \"QEM\", \"QLM\", \"QEY\", \"QLY\", \"QET\", \"QLT\"]);\nif (isForced && !ALLOWED.has(forcedCmd)) {\n  node.status({ fill: \"yellow\", shape: \"ring\", text: `Commande ignor√©e: ${forcedCmd}` });\n  return null;\n}\n\nconst FORCE_ALL_FOR_STATS = true;\n\n// TTL lockout (doit matcher ton NAK manager)\nconst LOCKOUT_TTL_MS = 24 * 60 * 60 * 1000;\nfunction isLocked(inv, cmd) {\n  // compat ancien lockout QPIGS2 si tu l‚Äôas encore\n  if (cmd === \"QPIGS2\" && flow.get(`inv${inv}_qpigs2_lockout`)) return true;\n\n  const lock = flow.get(`inv${inv}_opt_lockout_${cmd}`);\n  if (!lock || !lock.ts) return false;\n  return (Date.now() - lock.ts) < LOCKOUT_TTL_MS;\n}\n\nfor (let idx = 0; idx < serialPorts.length; idx++) {\n  const inverterNum = idx + 1;\n  const port = serialPorts[idx];\n\n  if (flow.get(`serial_busy_${inverterNum}`)) continue;\n\n  const last = global.get(`inverter_${inverterNum}.lastUpdate`) || 0;\n  const active = (now - last) < ACTIVE_WINDOW_MS;\n\n  // INV1 toujours, INV2+ seulement si actifs (sauf stats forc√©es)\n  if (!isForced) {\n    if (inverterNum !== 1 && !active) continue;\n  } else {\n    if (!FORCE_ALL_FOR_STATS) {\n      if (inverterNum !== 1 && !active) continue;\n    }\n  }\n\n  let cmdToSend;\n\n  if (isForced) {\n    cmdToSend = forcedCmd;\n\n    // ‚úÖ ne pas spam une commande lockout (unsupported)\n    if (isLocked(inverterNum, cmdToSend)) continue;\n\n  } else {\n    // Polling QPIGS/QPIGS2\n    let next = (flow.get(`inv${inverterNum}_next_cmd`) || \"QPIGS\").toString().toUpperCase();\n\n    // ‚úÖ si QPIGS2 lockout -> forcer QPIGS\n    if (next === \"QPIGS2\" && isLocked(inverterNum, \"QPIGS2\")) next = \"QPIGS\";\n\n    const nextAfter = (next === \"QPIGS\") ? \"QPIGS2\" : \"QPIGS\";\n    flow.set(`inv${inverterNum}_next_cmd`, nextAfter);\n\n    cmdToSend = next;\n  }\n\n  flow.set(`serial_busy_${inverterNum}`, true);\n  flow.set(`pending_since_${inverterNum}`, now);\n\n  out.push({\n    inverterNum,\n    port,\n    command: cmdToSend,\n    _cmd: cmdToSend,\n    payload: cmdToSend,\n    topic: `inv${inverterNum}`,\n    _src: isForced ? \"stats\" : \"polling\",\n    _ts: now\n  });\n}\n\nif (!out.length) return null;\nreturn [out];\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":100,"wires":[["7504adcf69fa35cc","36316993d7367a67"]]},{"id":"7504adcf69fa35cc","type":"function","z":"7f91cc5ad88a7cf9","name":"üîß Construire commande","func":"const helpers = global.get(\"helpers\");\n\nif (!helpers || typeof helpers.buildVoltronicCommand !== \"function\") {\n    node.error(\"helpers.buildVoltronicCommand introuvable (global.helpers)\");\n    return null;\n}\n\n// r√©cup√©rer la commande depuis msg.command (priorit√©) ou msg._cmd\nlet cmd = (msg.command || msg._cmd || \"\").toString().trim().toUpperCase();\n\nif (!cmd) {\n    node.error(\"Pas de commande (msg.command vide)\");\n    return null;\n}\n\n// S√©curit√©: √©viter d'envoyer n'importe quoi (espaces, timestamps, etc.)\nif (!/^[A-Z0-9]+$/.test(cmd)) {\n    node.warn(`Commande invalide ignor√©e: \"${cmd}\"`);\n    return null;\n}\n\n// IMPORTANT : garder la commande envoy√©e\nmsg.command = cmd;\nmsg._cmd = cmd;\n\n// M√©moriser la derni√®re commande par onduleur (utile RX/timeout)\nif (msg.inverterNum != null) {\n    flow.set(`inv${msg.inverterNum}_last_cmd`, cmd);\n    flow.set(`inv${msg.inverterNum}_last_cmd_ts`, Date.now());\n}\n\n// Construire la trame (Buffer)\nconst commandBuffer = helpers.buildVoltronicCommand(cmd);\n\n// Payload = Buffer √† envoyer sur Serial Out\nmsg.payload = commandBuffer;\n\n// Trace optionnelle\nmsg._tx_ts = Date.now();\nmsg._tx_ascii = cmd;\nmsg._tx_hex = commandBuffer.toString(\"hex\");\n\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `${cmd} ‚Üí Onduleur ${msg.inverterNum ?? \"?\"}`\n});\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":40,"wires":[["3b7ab94810dd3246","02d759a9ee17a2d1","73babdb06024e92d"]]},{"id":"3b7ab94810dd3246","type":"function","z":"7f91cc5ad88a7cf9","name":"üîñ Tag onduleur 1","func":"msg.inverterNum = 1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":400,"wires":[["ba4b0198f39ebfcd"]]},{"id":"02d759a9ee17a2d1","type":"function","z":"7f91cc5ad88a7cf9","name":"üîñ Tag onduleur 2","func":"msg.inverterNum = 2;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":440,"wires":[["ba4b0198f39ebfcd"]]},{"id":"73babdb06024e92d","type":"function","z":"7f91cc5ad88a7cf9","name":"üîñ Tag onduleur 3","func":"msg.inverterNum = 3;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":480,"wires":[["ba4b0198f39ebfcd"]]},{"id":"ba4b0198f39ebfcd","type":"switch","z":"7f91cc5ad88a7cf9","name":"üîÄ Router","property":"inverterNum","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":400,"y":440,"wires":[["fcd6e39f92a69e01"],["9d732cba82b41210"],[]]},{"id":"fcd6e39f92a69e01","type":"serial out","z":"7f91cc5ad88a7cf9","name":"üì§ Serial Out 1","serial":"c546b54ae425b9d2","x":570,"y":380,"wires":[]},{"id":"9d732cba82b41210","type":"serial out","z":"7f91cc5ad88a7cf9","name":"üì§ Serial Out 2","serial":"55a40ce3e960db15","x":570,"y":440,"wires":[]},{"id":"dcbb2687028dc9fb","type":"serial in","z":"7f91cc5ad88a7cf9","name":"üì• Serial In 1","serial":"c546b54ae425b9d2","x":130,"y":560,"wires":[["b38b46f458fd1b40"]]},{"id":"763b5e81a163bf4d","type":"serial in","z":"7f91cc5ad88a7cf9","name":"üì• Serial In 2","serial":"55a40ce3e960db15","x":130,"y":640,"wires":[["b38b46f458fd1b40"]]},{"id":"1852f756c36875f9","type":"function","z":"7f91cc5ad88a7cf9","name":"üîç Parser voltronic","func":"const helpers = global.get(\"helpers\");\nconst serialPorts = global.get(\"config.serialPorts\") || [];\n\n// ---- Utils pr√©cision ----\nconst f = (v, d = 2) => {\n    const n = Number.parseFloat(v);\n    if (!Number.isFinite(n)) return 0;\n    const m = Math.pow(10, d);\n    return Math.round(n * m) / m;\n};\n\nconst i = (v) => {\n    const n = Number.parseInt(v, 10);\n    return Number.isFinite(n) ? n : 0;\n};\n\nfunction release(inv) {\n    if (inv) {\n        flow.set(`serial_busy_${inv}`, false);\n        flow.set(`pending_since_${inv}`, 0);\n    } else {\n        // fallback (√©vite deadlock si on ne sait pas quel INV)\n        flow.set(\"serial_busy\", false);\n    }\n}\n\nif (!helpers || typeof helpers.parseVoltronicResponse !== \"function\") {\n    node.error(\"helpers.parseVoltronicResponse introuvable (global.helpers)\");\n    release(msg.inverterNum);\n    return null;\n}\n\n// --- D√©terminer le port r√©el de provenance ---\nlet port =\n    msg.port ||\n    msg.serialport ||\n    (msg._session && msg._session.type === \"serial\" ? msg._session.serialport : null) ||\n    msg.topic ||\n    \"\";\n\nif (typeof port !== \"string\") port = String(port || \"\");\n\n// Si topic = inv2 etc.\nif (!msg.inverterNum && /^inv\\d+$/i.test(port)) {\n    msg.inverterNum = Number(String(port).replace(/[^0-9]/g, \"\")) || 0;\n}\n\n// Si on n'a pas encore l'inverterNum, on le d√©duit du port s√©rie\nif (!msg.inverterNum) {\n    const portIndex = serialPorts.findIndex(p => p === port);\n    if (portIndex >= 0) msg.inverterNum = portIndex + 1;\n    else {\n        node.warn(\"Port non configur√©: \" + (port || \"<vide>\"));\n        release(0);\n        return null;\n    }\n}\n\nconst inverterNum = msg.inverterNum;\n\n// --- Commande associ√©e √† cette r√©ponse ---\nconst cmdU = String(\n    msg._cmd ||\n    msg.command ||\n    flow.get(`inv${inverterNum}_last_cmd`) ||\n    \"QPIGS\"\n).trim().toUpperCase();\n\n// --- R√©ponse brute en buffer ---\nlet rawBuf = msg.payload;\nif (!Buffer.isBuffer(rawBuf)) rawBuf = Buffer.from(String(rawBuf ?? \"\"), \"latin1\");\n\n// --- D√©tection NAK (s√©curit√©) ---\nconst rawAscii = rawBuf.toString(\"ascii\");\nif (msg._nak === true || rawAscii.includes(\"NAK\")) {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: `Onduleur ${inverterNum}: NAK (${cmdU})` });\n    release(inverterNum);\n    return null;\n}\n\n// --- Parser standard Voltronic (retire '(' / CRC / CR) ---\nconst data = helpers.parseVoltronicResponse(rawBuf);\nif (!data) {\n    release(inverterNum);\n    return null;\n}\n\nconst fields = data.split(\" \").filter(Boolean);\n\n// ============================================================================\n// 0) COMMANDES OPTIONNELLES (QED/QLD/QEM/QLM/QEY/QLY/QET/QLT)\n// ============================================================================\n\nfunction parseGenericOptional(fieldsArr) {\n    const nums = fieldsArr.map(v => Number.parseFloat(v)).filter(n => Number.isFinite(n));\n    if (fieldsArr.length === 1) {\n        const one = Number.parseFloat(fieldsArr[0]);\n        return {\n            value: Number.isFinite(one) ? one : fieldsArr[0],\n            raw: fieldsArr[0],\n            fields: fieldsArr,\n            nums\n        };\n    }\n    return {\n        fields: fieldsArr,\n        nums,\n        raw: fieldsArr.join(\" \")\n    };\n}\n\nconst OPTIONAL_PARSERS = {\n    QED: (arr) => parseGenericOptional(arr),\n    QLD: (arr) => parseGenericOptional(arr),\n    QEM: (arr) => parseGenericOptional(arr),\n    QLM: (arr) => parseGenericOptional(arr),\n    QEY: (arr) => parseGenericOptional(arr),\n    QLY: (arr) => parseGenericOptional(arr),\n    QET: (arr) => parseGenericOptional(arr),\n    QLT: (arr) => parseGenericOptional(arr),\n};\n\nif (OPTIONAL_PARSERS[cmdU]) {\n    const opt = OPTIONAL_PARSERS[cmdU](fields);\n\n    const base = global.get(`inverter_${inverterNum}.data`) || {};\n    const merged = {\n        ...base,\n        optional: {\n            ...(base.optional || {}),\n            [cmdU]: opt\n        },\n        ...(opt && Object.prototype.hasOwnProperty.call(opt, \"value\") ? { [cmdU.toLowerCase()]: opt.value } : {})\n    };\n\n    global.set(`inverter_${inverterNum}.data`, merged);\n    global.set(`inverter_${inverterNum}.lastUpdate`, Date.now());\n\n    msg.payload = {\n        inverterNum,\n        command: cmdU,\n        data: merged,\n        optional: opt,\n        timestamp: new Date().toISOString()\n    };\n\n    node.status({ fill: \"green\", shape: \"dot\", text: `Onduleur ${inverterNum}: OK (${cmdU})` });\n    release(inverterNum);\n    return msg;\n}\n\n// =====================\n// 1) BRANCHE QPIGS2\n// =====================\nif (cmdU === \"QPIGS2\") {\n    if (fields.length >= 5) {\n        const p = fields;\n\n        const pv2 = {\n            pv2_input_current: f(p[0], 2),\n            pv2_input_voltage: f(p[1], 1),\n            pv2_charging_power: i(p[2]),     // W\n            pv2_battery_voltage: f(p[3], 2),\n            pv2_reserved: p[4] || \"\"\n        };\n\n        pv2.pv2_power = pv2.pv2_charging_power;\n\n        const base = global.get(`inverter_${inverterNum}.data`) || {};\n        const merged = { ...base, ...pv2 };\n\n        global.set(`inverter_${inverterNum}.data`, merged);\n        global.set(`inverter_${inverterNum}.lastUpdate`, Date.now());\n\n        msg.payload = {\n            inverterNum,\n            command: cmdU,\n            data: merged,\n            timestamp: new Date().toISOString()\n        };\n\n        node.status({ fill: \"green\", shape: \"dot\", text: `Onduleur ${inverterNum}: OK (QPIGS2)` });\n        release(inverterNum);\n        return msg;\n    } else {\n        node.status({ fill: \"yellow\", shape: \"ring\", text: `Onduleur ${inverterNum}: QPIGS2 invalide (${fields.length})` });\n        release(inverterNum);\n        return null;\n    }\n}\n\n// =====================\n// 2) BRANCHE QPIGS\n// =====================\nif (fields.length < 20) {\n    release(inverterNum);\n    return null;\n}\n\nconst p = fields;\n\nconst parsed = {\n    // AC / R√©seau\n    grid_voltage: f(p[0], 1),\n    grid_frequency: f(p[1], 2),\n    ac_output_voltage: f(p[2], 1),\n    ac_output_frequency: f(p[3], 2),\n\n    // Puissances\n    ac_output_apparent_power: i(p[4]),\n    ac_output_active_power: i(p[5]),\n\n    // Load/bus/temp\n    output_load_percent: i(p[6]),\n    bus_voltage: i(p[7]),\n    inverter_heat_sink_temp: i(p[11]),\n\n    // Batterie\n    battery_voltage: f(p[8], 2),\n    battery_charging_current: f(p[9], 2),\n    battery_capacity: i(p[10]),\n    battery_voltage_scc: f(p[14], 2),\n    battery_discharge_current: f(p[15], 2),\n\n    // PV1\n    pv1_input_current: f(p[12], 2),\n    pv1_input_voltage: f(p[13], 1),\n\n    // Status\n    device_status: p[16] || \"\",\n\n    // PV charge power : W\n    pv1_charging_power: i(p[19])\n};\n\n// Power PV1 (0.1W)\nparsed.pv1_power = Math.round(parsed.pv1_input_voltage * parsed.pv1_input_current * 10) / 10;\n\n// Power Batterie (0.1W)\nparsed.battery_power = Math.round(\n    parsed.battery_voltage * (parsed.battery_charging_current - parsed.battery_discharge_current) * 10\n) / 10;\n\n// --- Fusion globale: IMPORTANT pour garder optional + pv2 ---\nconst oldAll = global.get(`inverter_${inverterNum}.data`) || {};\nconst mergedAll = { ...oldAll, ...parsed };\nif (oldAll.optional) mergedAll.optional = oldAll.optional; // pr√©server optional\n\nglobal.set(`inverter_${inverterNum}.data`, mergedAll);\nglobal.set(`inverter_${inverterNum}.lastUpdate`, Date.now());\n\n// --- Sortie ---\nmsg.payload = {\n    inverterNum,\n    command: cmdU,\n    data: mergedAll,\n    timestamp: new Date().toISOString()\n};\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `Onduleur ${inverterNum}: OK (QPIGS)` });\n\nrelease(inverterNum);\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":600,"wires":[["45ad5735a53e5f9f"]]},{"id":"45ad5735a53e5f9f","type":"link out","z":"7f91cc5ad88a7cf9","name":"link out 1","mode":"link","links":["1759b38d548c5cff"],"x":675,"y":680,"wires":[]},{"id":"3653237078e0be1a","type":"link in","z":"7f91cc5ad88a7cf9","name":"link in 2","links":["8479d7d8ded0a7d0"],"x":405,"y":100,"wires":[["d453962b8538e2fc"]]},{"id":"b38b46f458fd1b40","type":"function","z":"7f91cc5ad88a7cf9","name":"NAK manager","func":"const serialPorts = global.get(\"config.serialPorts\") || [];\n\n// --- D√©terminer inverterNum si manquant ---\nlet port =\n    msg.port ||\n    msg.serialport ||\n    (msg._session && msg._session.type === \"serial\" ? msg._session.serialport : null) ||\n    msg.topic ||\n    \"\";\n\nif (typeof port !== \"string\") port = String(port || \"\");\n\n// Astuce: parfois msg.topic vaut \"inv1\"\nif (!msg.inverterNum && /^inv\\d+$/i.test(port)) {\n    msg.inverterNum = Number(String(port).replace(/[^0-9]/g, \"\")) || 0;\n}\n\nif (!msg.inverterNum) {\n    const portIndex = serialPorts.findIndex(p => p === port);\n    if (portIndex >= 0) msg.inverterNum = portIndex + 1;\n}\n\nconst inverterNum = msg.inverterNum ?? 0;\n\n// --- Commande associ√©e ---\nconst cmdRaw =\n    msg._cmd ||\n    msg.command ||\n    (inverterNum ? flow.get(`inv${inverterNum}_last_cmd`) : null) ||\n    \"QPIGS\";\n\nconst cmd = String(cmdRaw).toUpperCase();\n\n// garde trace (debug)\nif (inverterNum) flow.set(`inv${inverterNum}_last_rx_cmd`, cmd);\n\n// --- Payload en buffer + string ---\nlet rawBuf = msg.payload;\nif (!Buffer.isBuffer(rawBuf)) rawBuf = Buffer.from(String(rawBuf ?? \"\"), \"latin1\");\n\nconst s = rawBuf.toString(\"ascii\").trim();\nconst isNAK = s.includes(\"NAK\");\n\n// --- lib√©ration busy ---\nfunction release(inv) {\n    if (inv) {\n        flow.set(`serial_busy_${inv}`, false);\n        flow.set(`pending_since_${inv}`, 0);\n    } else {\n        flow.set(\"serial_busy\", false);\n    }\n}\n\n// ============================================================================\n// ‚úÖ Gestion NAK \"commandes optionnelles\" (peuvent √™tre unsupported)\n// ============================================================================\n\nconst optionalCmds = new Set([\n    \"QPIGS2\",\n    \"QED\", \"QLD\",\n    \"QEM\", \"QLM\",\n    \"QEY\", \"QLY\",\n    \"QET\", \"QLT\",\n]);\n\nconst NAK_THRESHOLD = 2;\nconst LOCKOUT_TTL_MS = 24 * 60 * 60 * 1000;\n\nfunction key(inv, name, c) {\n    const safeCmd = String(c || \"\").toUpperCase();\n    return inv ? `inv${inv}_${name}_${safeCmd}` : `${name}_${safeCmd}`;\n}\n\nconst isOptional = optionalCmds.has(cmd);\n\n// --- Si optional + d√©j√† lockout actif => on ignore ---\nif (isOptional && inverterNum) {\n    const keyLock = key(inverterNum, \"opt_lockout\", cmd);\n    const lock = flow.get(keyLock);\n\n    if (lock && lock.ts && (Date.now() - lock.ts) < LOCKOUT_TTL_MS) {\n        msg._nak = true;\n        msg._cmd = cmd;\n        msg._raw = s;\n        msg._lockout = true;\n        msg._ignored = true;\n\n        node.status({ fill: \"red\", shape: \"ring\", text: `INV${inverterNum} ${cmd} OFF (lockout)` });\n\n        release(inverterNum);\n        return msg; // ou return null si tu veux vraiment drop\n    } else if (lock && lock.ts) {\n        flow.set(keyLock, null); // TTL expir√©\n    }\n}\n\n// --- Si NAK sur optional => compteur + lockout √©ventuel ---\nif (isOptional && isNAK) {\n\n    if (inverterNum) {\n        const keyCount = key(inverterNum, \"opt_nak_count\", cmd);\n        const keyLock = key(inverterNum, \"opt_lockout\", cmd);\n\n        const n = (flow.get(keyCount) || 0) + 1;\n        flow.set(keyCount, n);\n\n        if (n >= NAK_THRESHOLD) {\n            flow.set(keyLock, { ts: Date.now(), reason: \"NAK\" });\n            node.status({ fill: \"red\", shape: \"dot\", text: `INV${inverterNum} ${cmd} OFF (NAK)` });\n        } else {\n            node.status({ fill: \"yellow\", shape: \"ring\", text: `INV${inverterNum} ${cmd} NAK (${n})` });\n        }\n    } else {\n        node.status({ fill: \"yellow\", shape: \"ring\", text: `${cmd} NAK` });\n    }\n\n    msg._nak = true;\n    msg._cmd = cmd;\n    msg._raw = s;\n\n    release(inverterNum);\n    return msg;\n}\n\n// --- Si optional r√©pond OK => reset compteur ---\nif (isOptional && !isNAK) {\n    if (inverterNum) {\n        flow.set(key(inverterNum, \"opt_nak_count\", cmd), 0);\n        node.status({ fill: \"green\", shape: \"dot\", text: `INV${inverterNum} ${cmd} OK` });\n    } else {\n        node.status({ fill: \"green\", shape: \"dot\", text: `${cmd} OK` });\n    }\n}\n\n// ============================================================================\n// ‚úÖ R√©ponse OK (QPIGS ou autre)\n// ============================================================================\nmsg._nak = false;\nmsg._cmd = cmd;\nmsg._raw = s;\n\nrelease(inverterNum);\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":600,"wires":[["1852f756c36875f9"]]},{"id":"7f2df65a070bf567","type":"function","z":"7f91cc5ad88a7cf9","name":"timeout watchdog","func":"const invertersCount = global.get(\"config.invertersCount\") || 0;\nconst now = Date.now();\n\nfor (let i = 1; i <= invertersCount; i++) {\n\n  const busy = flow.get(`serial_busy_${i}`);\n  if (!busy) continue;\n\n  const since = flow.get(`pending_since_${i}`) || 0;\n\n  if (now - since > 1700) {\n    node.status({\n      fill: \"yellow\",\n      shape: \"ring\",\n      text: `Timeout INV${i} ‚Üí release`\n    });\n\n    flow.set(`serial_busy_${i}`, false);\n  }\n}\n\nreturn null;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":40,"wires":[["d453962b8538e2fc"]]},{"id":"4be4eca07a6cccf1","type":"inject","z":"7f91cc5ad88a7cf9","name":"startup","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"20","topic":"startup","x":80,"y":100,"wires":[["800c40a98ecc2dbb"]]},{"id":"67ca2d579d30bc5e","type":"inject","z":"7f91cc5ad88a7cf9","name":"QED-QLD","props":[{"p":"topic","vt":"str"}],"repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"topic":"hourly","x":90,"y":140,"wires":[["800c40a98ecc2dbb"]]},{"id":"7d7fb453c3f470ac","type":"inject","z":"7f91cc5ad88a7cf9","name":"QEM-QLM","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"05 00 * * *","once":false,"onceDelay":0.1,"topic":"daily","x":90,"y":180,"wires":[["800c40a98ecc2dbb"]]},{"id":"2be6f721a0b84195","type":"inject","z":"7f91cc5ad88a7cf9","name":"QEY-T_QLY-T","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"10 00 * * *","once":false,"onceDelay":0.1,"topic":"monthly_check","x":100,"y":220,"wires":[["800c40a98ecc2dbb"]]},{"id":"800c40a98ecc2dbb","type":"function","z":"7f91cc5ad88a7cf9","name":"Stats Scheduler","func":"const serialPorts = global.get(\"config.serialPorts\") || [];\nif (!serialPorts.length) return null;\n\nconst mode = (msg.topic || \"\").toString();\n\n// TTL doit matcher ton NAK manager\nconst LOCKOUT_TTL_MS = 24 * 60 * 60 * 1000;\n\nfunction isLocked(inv, cmd) {\n  const key = `inv${inv}_opt_lockout_${cmd}`;\n  const lock = flow.get(key);\n  if (!lock || !lock.ts) return false;\n  return (Date.now() - lock.ts) < LOCKOUT_TTL_MS;\n}\n\nfunction pack(list) {\n\n  const filtered = list.filter(cmd => {\n\n    // Si au moins 1 onduleur peut encore r√©pondre -> on garde\n    for (let i = 0; i < serialPorts.length; i++) {\n      const inv = i + 1;\n      if (!isLocked(inv, cmd)) return true;\n    }\n\n    // Tous lockout -> on ignore\n    node.status({ fill: \"grey\", shape: \"ring\", text: `${cmd} ignor√© (lockout global)` });\n    return false;\n  });\n\n  if (!filtered.length) return null;\n\n  const msgs = filtered.map(c => ({\n    command: c,\n    _src: mode\n  }));\n\n  return [msgs];\n}\n\nif (mode === \"startup\") {\n  return pack([\"QED\", \"QLD\", \"QEM\", \"QLM\", \"QEY\", \"QLY\", \"QET\", \"QLT\"]);\n}\n\nif (mode === \"hourly\") {\n  return pack([\"QED\", \"QLD\"]);\n}\n\nif (mode === \"daily\") {\n  return pack([\"QEM\", \"QLM\"]);\n}\n\nif (mode === \"monthly_check\") {\n  const d = new Date();\n  if (d.getDate() !== 1) return null;\n  return pack([\"QEY\", \"QLY\", \"QET\", \"QLT\"]);\n}\n\nreturn null;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":120,"wires":[["9f89323e64987d54","9531530ba1f7080d"]]},{"id":"9f89323e64987d54","type":"delay","z":"7f91cc5ad88a7cf9","name":"limite message pour prod et load","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":370,"y":180,"wires":[["d453962b8538e2fc"]]},{"id":"36316993d7367a67","type":"debug","z":"7f91cc5ad88a7cf9","name":"debug 1","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":770,"y":160,"wires":[]},{"id":"9531530ba1f7080d","type":"debug","z":"7f91cc5ad88a7cf9","name":"debug 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":590,"y":220,"wires":[]},{"id":"e8b7087f49d079c3","type":"function","z":"0f637b517ebf7066","name":"üì§ Publier √©tats","func":"const mqttConfig = global.get(\"config.mqtt\");\n\nif (!msg.payload || !msg.payload.data) return null;\n\nconst inverterNum = msg.payload.inverterNum;\nconst data = msg.payload.data;\n\nif (!inverterNum || typeof data !== \"object\") return null;\n\n// ---- Calcul PV total s√©curis√©\ndata.pv_total_power =\n    (Number(data.pv1_power) || 0) +\n    (Number(data.pv2_power) || 0);\n\n// ---- Topic √©tat\nconst stateTopic = `${mqttConfig.baseTopic}/${inverterNum}/state`;\n\nconst stateMsg = {\n    topic: stateTopic,\n    payload: JSON.stringify(data),\n    retain: false\n};\n\nconst availMsg = {\n    topic: `${mqttConfig.baseTopic}/${inverterNum}/availability`,\n    payload: \"online\",\n    retain: true\n};\n\nreturn [stateMsg, availMsg];\n","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":200,"wires":[["93d1d391ea432e7e"],["93d1d391ea432e7e"]]},{"id":"921867dc7e0442a0","type":"function","z":"0f637b517ebf7066","name":"üîç Auto-discovery QPIGS","func":"const mqttConfig = global.get(\"config.mqtt\");\nconst serialPorts = global.get(\"config.serialPorts\") || [];\nconst numInverters = serialPorts.length;\nconst messages = [];\n\nfunction sensorConfig({ deviceId, deviceName, inverterNum, device, sensor }) {\n    const cfg = {\n        name: `${deviceName} ${sensor.name}`,\n        unique_id: `${deviceId}_${sensor.key}`,\n        state_topic: `${mqttConfig.baseTopic}/${inverterNum}/state`,\n\n        // ‚úÖ conversion directement dans HA (Wh -> kWh si kwhDivisor d√©fini)\n        value_template: sensor.kwhDivisor\n            ? `{{ (value_json.${sensor.key} | float / ${sensor.kwhDivisor}) | round(${sensor.precision ?? 3}) }}`\n            : `{{ value_json.${sensor.key} }}`,\n\n        icon: sensor.icon,\n        device: device,\n        force_update: true\n    };\n\n    if (sensor.state_class) cfg.state_class = sensor.state_class;\n    if (sensor.device_class) cfg.device_class = sensor.device_class;\n\n    if (sensor.unit) cfg.unit_of_measurement = sensor.unit;\n    if (sensor.precision !== undefined) cfg.suggested_display_precision = sensor.precision;\n\n    // ‚úÖ AVAILABILITY: align√© sur ton publisher\n    // Publisher envoie: `${mqttConfig.baseTopic}/${inverterNum}/availability` payload \"online\"\n    cfg.availability_topic = `${mqttConfig.baseTopic}/${inverterNum}/availability`;\n    cfg.payload_available = \"online\";\n    cfg.payload_not_available = \"offline\";\n\n    return cfg;\n}\n\nfor (let inverterNum = 1; inverterNum <= numInverters; inverterNum++) {\n    const deviceId = `voltronic_${inverterNum}`;\n    const deviceName = `Onduleur Voltronic ${inverterNum}`;\n\n    const device = {\n        identifiers: [deviceId],\n        name: deviceName,\n        manufacturer: \"Voltronic\",\n        model: \"Ultra 11kW\"\n    };\n\n    const sensors = [\n        // GRID / INPUT\n        { key: \"grid_voltage\", name: \"Tension R√©seau\", unit: \"V\", device_class: \"voltage\", state_class: \"measurement\", precision: 1, icon: \"mdi:transmission-tower\" },\n        { key: \"grid_frequency\", name: \"Fr√©quence R√©seau\", unit: \"Hz\", device_class: \"frequency\", state_class: \"measurement\", precision: 2, icon: \"mdi:sine-wave\" },\n\n        // AC OUTPUT\n        { key: \"ac_output_voltage\", name: \"Tension Sortie AC\", unit: \"V\", device_class: \"voltage\", state_class: \"measurement\", precision: 1, icon: \"mdi:power-plug\" },\n        { key: \"ac_output_frequency\", name: \"Fr√©quence Sortie AC\", unit: \"Hz\", device_class: \"frequency\", state_class: \"measurement\", precision: 2, icon: \"mdi:sine-wave\" },\n        { key: \"ac_output_active_power\", name: \"Puissance Sortie AC\", unit: \"W\", device_class: \"power\", state_class: \"measurement\", precision: 0, icon: \"mdi:lightning-bolt\" },\n        { key: \"ac_output_apparent_power\", name: \"Puissance Apparente AC\", unit: \"VA\", state_class: \"measurement\", precision: 0, icon: \"mdi:flash\" },\n\n        { key: \"output_load_percent\", name: \"Charge Sortie\", unit: \"%\", state_class: \"measurement\", precision: 0, icon: \"mdi:gauge\" },\n\n        // BATTERIE\n        { key: \"battery_voltage\", name: \"Tension Batterie\", unit: \"V\", device_class: \"voltage\", state_class: \"measurement\", precision: 2, icon: \"mdi:battery\" },\n        { key: \"battery_capacity\", name: \"SoC Batterie\", unit: \"%\", state_class: \"measurement\", precision: 0, icon: \"mdi:battery-80\" },\n        { key: \"battery_power\", name: \"Puissance Batterie\", unit: \"W\", device_class: \"power\", state_class: \"measurement\", precision: 1, icon: \"mdi:battery-charging\" },\n        { key: \"battery_charging_current\", name: \"Courant Charge Batterie\", unit: \"A\", device_class: \"current\", state_class: \"measurement\", precision: 2, icon: \"mdi:current-dc\" },\n        { key: \"battery_discharge_current\", name: \"Courant D√©charge Batterie\", unit: \"A\", device_class: \"current\", state_class: \"measurement\", precision: 2, icon: \"mdi:current-dc\" },\n\n        // PV1\n        { key: \"pv1_input_voltage\", name: \"Tension PV1\", unit: \"V\", device_class: \"voltage\", state_class: \"measurement\", precision: 1, icon: \"mdi:solar-power\" },\n        { key: \"pv1_input_current\", name: \"Courant PV1\", unit: \"A\", device_class: \"current\", state_class: \"measurement\", precision: 2, icon: \"mdi:current-dc\" },\n        { key: \"pv1_power\", name: \"Puissance PV1\", unit: \"W\", device_class: \"power\", state_class: \"measurement\", precision: 1, icon: \"mdi:solar-power\" },\n\n        // PV2\n        { key: \"pv2_input_voltage\", name: \"Tension PV2\", unit: \"V\", device_class: \"voltage\", state_class: \"measurement\", precision: 1, icon: \"mdi:solar-power\" },\n        { key: \"pv2_input_current\", name: \"Courant PV2\", unit: \"A\", device_class: \"current\", state_class: \"measurement\", precision: 2, icon: \"mdi:current-dc\" },\n        { key: \"pv2_power\", name: \"Puissance PV2\", unit: \"W\", device_class: \"power\", state_class: \"measurement\", precision: 1, icon: \"mdi:solar-power\" },\n\n        // PV TOTAL\n        { key: \"pv_total_power\", name: \"Puissance PV Totale\", unit: \"W\", device_class: \"power\", state_class: \"measurement\", precision: 1, icon: \"mdi:solar-power\" },\n\n        // TEMP\n        { key: \"inverter_heat_sink_temp\", name: \"Temp√©rature\", unit: \"¬∞C\", device_class: \"temperature\", state_class: \"measurement\", precision: 1, icon: \"mdi:thermometer\" },\n\n        // =========================\n        // ‚úÖ NOUVEAUX CAPTEURS √âNERGIE (en kWh)\n        // =========================\n        // Si ton firmware renvoie d√©j√† des kWh, mets kwhDivisor: 1 (ou supprime la cl√©)\n        { key: \"qed\", name: \"√ânergie Jour (QED)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n        { key: \"qld\", name: \"√ânergie Load Jour (QLD)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n\n        { key: \"qem\", name: \"√ânergie Mois (QEM)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n        { key: \"qlm\", name: \"√ânergie Load Mois (QLM)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n\n        { key: \"qey\", name: \"√ânergie Ann√©e (QEY)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n        { key: \"qly\", name: \"√ânergie Load Ann√©e (QLY)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n\n        { key: \"qet\", name: \"√ânergie Totale (QET)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n        { key: \"qlt\", name: \"√ânergie Load Totale (QLT)\", unit: \"kWh\", device_class: \"energy\", state_class: \"total_increasing\", precision: 3, icon: \"mdi:counter\", kwhDivisor: 1000 },\n    ];\n\n    for (const sensor of sensors) {\n        const config = sensorConfig({ deviceId, deviceName, inverterNum, device, sensor });\n\n        messages.push({\n            topic: `${mqttConfig.discoveryPrefix}/sensor/${deviceId}/${sensor.key}/config`,\n            payload: JSON.stringify(config),\n            retain: true\n        });\n    }\n}\n\nnode.status({\n    fill: \"green\",\n    shape: \"dot\",\n    text: `Discovery HA OK : ${numInverters} onduleur(s) / ${messages.length} capteur(s)`\n});\n\nreturn [messages];\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":100,"wires":[["93d1d391ea432e7e"]]},{"id":"93d1d391ea432e7e","type":"mqtt out","z":"0f637b517ebf7066","name":"üì° MQTT Out","topic":"","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"mqtt_broker","x":650,"y":150,"wires":[]},{"id":"01cb9ef46af2f555","type":"inject","z":"0f637b517ebf7066","name":"‚è∞ Au d√©marrage","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":"2","topic":"","payload":"","payloadType":"date","x":150,"y":100,"wires":[["921867dc7e0442a0"]]},{"id":"1759b38d548c5cff","type":"link in","z":"0f637b517ebf7066","name":"link in 1","links":["45ad5735a53e5f9f"],"x":145,"y":200,"wires":[["e8b7087f49d079c3"]]},{"id":"d6230a5101e5b706","type":"inject","z":"860d5c4e8609e907","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":130,"y":80,"wires":[["4c05c4c718b7e7e7"]]},{"id":"4c05c4c718b7e7e7","type":"file in","z":"860d5c4e8609e907","name":"","filename":"/data/options.json","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":390,"y":80,"wires":[["8c655eb1ec500df5"]]},{"id":"8c655eb1ec500df5","type":"json","z":"860d5c4e8609e907","name":"","property":"payload","action":"","pretty":false,"x":590,"y":80,"wires":[["b88267c377864be3","221163ae33050426"]]},{"id":"b88267c377864be3","type":"function","z":"860d5c4e8609e907","name":"Config global variable","func":"let count = msg.payload.listonduleur.length //compte le nombre de usb\nglobal.set('countUSBOnduleur', count); //nombre d'onduleur\n\n//ajoute les config onduleur au globals\nfor (let i = 0; i < count; i++) {\n  let j = i + 1; //ajoute +1 pour demarrer a 1\n  let chemin = msg.payload.listonduleur[i].chemin;\n  let type = msg.payload.listonduleur[i].type\n  let onduleur = msg.payload.listonduleur[i].onduleur\n  let qpgs = (msg.payload.listonduleur[i].multionduleur == undefined) ? true : msg.payload.listonduleur[i].multionduleur;\n  let full = (msg.payload.listonduleur[i].full == undefined) ? true : msg.payload.listonduleur[i].full;\n  let battTension = (msg.payload.listonduleur[i].battTension == undefined) ? 48 : msg.payload.listonduleur[i].battTension\n\n  if (msg.payload.listonduleur[i].chemin != \"false\") {\n    //futur config\n    global.set('onduleurs.onduleur_' + j + '.active', true);\n    global.set('onduleurs.onduleur_' + j + '.id', j);\n    global.set('onduleurs.onduleur_' + j + '.chemin', chemin);\n    global.set('onduleurs.onduleur_' + j + '.ComType', type);\n    global.set('onduleurs.onduleur_' + j + '.type', onduleur);\n    global.set('onduleurs.onduleur_' + j + '.qpgs', qpgs);\n    global.set('onduleurs.onduleur_' + j + '.full', full);\n    global.set('onduleurs.onduleur_' + j + '.battTension', battTension);\n  }\n}\n\n//Parametre g√©n√©raux\nglobal.set(\"parametre.Version\", msg.payload.version);\nglobal.set(\"parametre.config.interval\", msg.payload.interval); //2 secondes\nglobal.set(\"parametre.config.intervalBatt\", msg.payload.intervalBatt); // 7000 ms pour 7 secondes\nglobal.set(\"parametre.config.debug\", msg.payload.debug);\n\n//Nom Personalis√© Onduleur\nglobal.set(\"name.Onduleur\", msg.payload.nameEntities.nameOnduleur);\nglobal.set(\"name.PV\", msg.payload.nameEntities.namePV);\nglobal.set(\"name.PV2\", msg.payload.nameEntities.namePV2);\nglobal.set(\"name.Batt_charge\", msg.payload.nameEntities.nameBatt_charge);\nglobal.set(\"name.Batt_batt_decharge\", msg.payload.nameEntities.nameBatt_batt_decharge);\nglobal.set(\"name.Batt_batt_chargedecharge\", msg.payload.nameEntities.nameBatt_batt_chargedecharge);\nglobal.set(\"name.Conso_maison\", msg.payload.nameEntities.nameConso_maison);\nglobal.set(\"name.conso_grid\", msg.payload.nameEntities.nameGrid_power);\nglobal.set(\"name.GridTension\", msg.payload.nameEntities.nameGridTension);\nglobal.set(\"name.BattTensiont\", msg.payload.nameEntities.nameBattTensiont);\nglobal.set(\"name.PvTensiont\", msg.payload.nameEntities.namePvTensiont);\nglobal.set(\"name.Pv2Tensiont\", msg.payload.nameEntities.namePv2Tensiont);\nglobal.set(\"name.OnduleurTension\", msg.payload.nameEntities.nameOnduleurTension);\nglobal.set(\"name.PvIntensite\", msg.payload.nameEntities.namePvIntensite);\nglobal.set(\"name.Pv2Intensite\", msg.payload.nameEntities.namePv2Intensite);\nglobal.set(\"name.BattChargeIntensite\", msg.payload.nameEntities.nameBattChargeIntensite);\nglobal.set(\"name.BattDechargeIntensite\", msg.payload.nameEntities.nameBattDechargeIntensite);\nglobal.set(\"name.OnduleurFrequency\", msg.payload.nameEntities.nameOnduleurFrequency);\nglobal.set(\"name.DataFrequency\", msg.payload.nameEntities.nameDataFrequency);\nglobal.set(\"name.BattCapacite\", msg.payload.nameEntities.nameBattCapacite);\nglobal.set(\"name.Mode\", msg.payload.nameEntities.nameMode);\nglobal.set(\"name.Temp\", msg.payload.nameEntities.nameTemp);\nglobal.set(\"name.Param01\", msg.payload.nameEntities.nameParam01);\nglobal.set(\"name.Param02\", msg.payload.nameEntities.nameParam02);\nglobal.set(\"name.Param05\", msg.payload.nameEntities.nameParam05);\nglobal.set(\"name.Param11\", msg.payload.nameEntities.nameParam11);\nglobal.set(\"name.Param12\", msg.payload.nameEntities.nameParam12);\nglobal.set(\"name.Param13\", msg.payload.nameEntities.nameParam13);\nglobal.set(\"name.Param16\", msg.payload.nameEntities.nameParam16);\nglobal.set(\"name.Param26\", msg.payload.nameEntities.nameParam26);\nglobal.set(\"name.Param27\", msg.payload.nameEntities.nameParam27);\nglobal.set(\"name.Param29\", msg.payload.nameEntities.nameParam29);\n\n//lovelace\nglobal.set(\"lovelace.lovelace\", msg.payload.lovelace); //Lovelace true/false\nglobal.set(\"lovelace.panneaux\", msg.payload.panneaux); //Lovelace nom panneau\nglobal.set(\"lovelace.batteries\", msg.payload.batteries); //Lovelace nom batteries\n\n//mqtt patrametre\nglobal.set(\"parametre.mqtt.Adresse\", msg.payload.mqtt.mqttadresse); //type d'batterie\nglobal.set(\"parametre.mqtt.Port\", msg.payload.mqtt.mqttport); //type d'batterie\nglobal.set(\"parametre.mqtt.Login\", msg.payload.mqtt.mqttuser); //type d'batterie\nglobal.set(\"parametre.mqtt.Password\", msg.payload.mqtt.mqttpass); //type d'batterie\nglobal.set(\"parametre.mqtt.DirSmart\", \"smartphoton\");\n\nif (msg.payload.mqtt.mqttInterne != undefined) {\n  global.set(\"mqttInterne\", msg.payload.mqtt.mqttInterne);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":80,"wires":[["35d0569c6faccc86"]]},{"id":"35d0569c6faccc86","type":"debug","z":"860d5c4e8609e907","name":"debug 97","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1000,"y":80,"wires":[]},{"id":"754bbd80b8f8cf0c","type":"file in","z":"860d5c4e8609e907","name":"Fichier exemple de config","filename":"/media/smartphotonOptionsExemple.json","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":370,"y":120,"wires":[["8c655eb1ec500df5","6fe60941453c699e"]]},{"id":"7cde8836021a122e","type":"inject","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"connect","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":120,"y":320,"wires":[["e7978b594a2ba601"]]},{"id":"e7978b594a2ba601","type":"function","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"function 2","func":"msg.action = \"connect\";\nmsg.broker = '{\"broker\":\"' + global.get(\"parametre.mqtt.Adresse\")+'\",'\n    + '\"port\":\"' + global.get(\"parametre.mqtt.Port\")+'\",'\n    + '\"username\":\"' + global.get(\"parametre.mqtt.Login\")+'\",'\n    + '\"password\":\"' + global.get(\"parametre.mqtt.Password\")+'\"'\n    +'}';\nreturn msg\n\n//NOLAK\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":320,"wires":[["6f7a976318f3f122"]]},{"id":"e31d2afc75db6e57","type":"mqtt out","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"MQTT external broker","topic":"","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"7eb926b832168904","x":980,"y":360,"wires":[]},{"id":"92ce5c0daa108b5e","type":"inject","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"disconnect","props":[{"p":"payload"},{"p":"action","v":"disconnect","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":130,"y":360,"wires":[["e31d2afc75db6e57"]]},{"id":"6f7a976318f3f122","type":"json","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"","property":"broker","action":"","pretty":false,"x":710,"y":320,"wires":[["e31d2afc75db6e57"]]},{"id":"5473c4b21f7c5529","type":"link in","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"vers mqtt","links":["7b023de548513584","1f82fe719a9f5c56","3cec1b2e07a5270d"],"x":725,"y":400,"wires":[["e31d2afc75db6e57","8dc998ce14051b15"]]},{"id":"05d2344dbcd22c18","type":"exec","z":"860d5c4e8609e907","d":true,"g":"2dd6bd7d1ec3df70","command":"cp /data/options.json /media/smartphotonOptionsExemple.json","addpay":"","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":850,"y":220,"wires":[[],[],[]]},{"id":"5b93e8225e649888","type":"inject","z":"860d5c4e8609e907","g":"2dd6bd7d1ec3df70","name":"R√©cup√©ration config dans addon","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":220,"wires":[["05d2344dbcd22c18"]]},{"id":"221163ae33050426","type":"debug","z":"860d5c4e8609e907","name":"debug 164","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":770,"y":120,"wires":[]},{"id":"25d5b6b56574fc7d","type":"inject","z":"860d5c4e8609e907","g":"64c5ac6c0424061a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1060,"wires":[["c695bee4d439be37"]]},{"id":"c695bee4d439be37","type":"function","z":"860d5c4e8609e907","g":"64c5ac6c0424061a","name":"Purge variable","func":"global.set(\"onduleurs\", undefined);\nglobal.set(\"batteries\", undefined);\n\nglobal.set(\"qpig\", undefined);\nglobal.set(\"qpigs2\", undefined);\nglobal.set(\"qbeqi\", undefined);\nglobal.set(\"qflag\", undefined);\nglobal.set(\"qpiws\", undefined);\nglobal.set(\"QID\", undefined);\nglobal.set(\"QSID\", undefined);\nglobal.set(\"QVFW\", undefined);\nglobal.set('onduleurs', undefined);\n\n\nfor (let i = 0; i <= 50; i++) {\n\n    for (let q = 0; q < 10; q++) {\n     global.set(i + 'qpgs' + q, undefined);\n     msg.payload = i + 'qpgs' + q;\n     node.send(msg);\n    }\n\n    global.set('qpgs' + i, undefined);\n    global.set('onduleur' + i, undefined);\n    global.set('onduleurqpgs' + i, undefined);\n    global.set('onduleurUsbPort' + i, undefined);\n    global.set('onduleurComType' + i, undefined);\n    global.set('onduleurType' + i, undefined);\n\n\n    global.set('batterie' + i, undefined);\n    global.set('batterieComType' + i, undefined);\n    global.set('batterieComType' + i, undefined);\n    global.set('battTension' + i, undefined);\n\n\n}\n\n\n//Nom Personalis√© Onduleur a suppr\nglobal.set(\"nameOnduleur\", undefined); \nglobal.set(\"namePV\", undefined);\nglobal.set(\"namePV2\", undefined);\nglobal.set(\"nameBatt_charge\", undefined);\nglobal.set(\"nameBatt_batt_decharge\", undefined);\nglobal.set(\"nameBatt_batt_chargedecharge\", undefined);\nglobal.set(\"nameConso_maison\", undefined);\nglobal.set(\"nameGridTension\", undefined);\nglobal.set(\"nameBattTensiont\", undefined);\nglobal.set(\"namePvTensiont\", undefined);\nglobal.set(\"namePv2Tensiont\", undefined);\nglobal.set(\"nameOnduleurTension\", undefined);\nglobal.set(\"namePvIntensite\", undefined);\nglobal.set(\"namePv2Intensite\", undefined);\nglobal.set(\"nameBattChargeIntensite\", undefined);\nglobal.set(\"nameBattDechargeIntensite\", undefined);\nglobal.set(\"nameOnduleurFrequency\", undefined);\nglobal.set(\"nameDataFrequency\", undefined);\nglobal.set(\"nameBattCapacite\", undefined);\nglobal.set(\"nameMode\", undefined);\nglobal.set(\"nameTemp\", undefined);\nglobal.set(\"nameParam01\", undefined);\nglobal.set(\"nameParam02\", undefined);\nglobal.set(\"nameParam05\", undefined);\nglobal.set(\"nameParam11\", undefined);\nglobal.set(\"nameParam12\", undefined);\nglobal.set(\"nameParam13\", undefined);\nglobal.set(\"nameParam16\", undefined);\nglobal.set(\"nameParam26\", undefined);\nglobal.set(\"nameParam27\", undefined);\nglobal.set(\"nameParam29\", undefined);\n\n//A suppr\nglobal.set(\"onduleurType\", msg.payload.onduleur); //A suppr\nglobal.set(\"onduleurType\", undefined); //A suppr\nglobal.set(\"onduleurComType\", undefined); //A suppr\nglobal.set(\"onduleurUsbPort\", undefined); //A suppr\nglobal.set(\"qpigs2\", undefined); //A suppr\n\nglobal.set(\"mqttAdresse\", undefined); //A suppr\nglobal.set(\"mqttPort\", undefined); //A suppr\nglobal.set(\"mqttLogin\", undefined); //A suppr\nglobal.set(\"mqttPassword\", undefined); //A suppr\nglobal.set(\"mqttDirSmart\", undefined);\n//A suppr","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":1060,"wires":[["4356850d9cb67b91"]]},{"id":"4356850d9cb67b91","type":"debug","z":"860d5c4e8609e907","g":"64c5ac6c0424061a","name":"debug 168","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":990,"y":1060,"wires":[]},{"id":"9d446c660ae43340","type":"inject","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"1.3","topic":"","payload":"","payloadType":"date","x":130,"y":760,"wires":[["4a715e5c6917c9e0","8555e5bb36cc62d7","702384d56cbcae73","a22ecc7b93d0d1e7"]]},{"id":"83bb99f3a60d51e3","type":"serial control","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"","serial":"3f128fc7b3eaf075","x":630,"y":560,"wires":[["5402f5af22372444"]]},{"id":"4a715e5c6917c9e0","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"serial onduleur","func":"if (global.get(\"onduleurs.onduleur_1.ComType\") == \"serial\" && global.get(\"onduleurs.onduleur_1.type\") == \"voltronic\"){\n    msg.payload = {\n    \"serialport\": global.get(\"onduleurs.onduleur_1.chemin\"),\n    \"serialbaud\": 2400,\n    \"databits\": 8,\n    \"parity\": \"none\",\n    \"stopbits\": 1,\n    \"enabled\": true\n    }\n\n    node.send(msg);\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":560,"wires":[["83bb99f3a60d51e3"]]},{"id":"cc2917a77b6cd1f1","type":"debug","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"debug 162","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":560,"wires":[]},{"id":"5402f5af22372444","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"function 61","func":"msg.payload = \"Changement \" + global.get(\"onduleurs.onduleur_1.type\") + \" 1 sur serial \" + global.get(\"onduleurs.onduleur_1.chemin\"); //NOLAK\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":560,"wires":[["cc2917a77b6cd1f1"]]},{"id":"8f1237b869c14ea1","type":"serial control","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"","serial":"8f8f04570bb20a6b","x":630,"y":600,"wires":[["e6814947783104d0"]]},{"id":"8555e5bb36cc62d7","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"serial onduleur","func":"if (global.get(\"onduleurs.onduleur_2.ComType\") == \"serial\" && global.get(\"onduleurs.onduleur_2.type\") == \"voltronic\") {\n    msg.payload = {\n        \"serialport\": global.get(\"onduleurs.onduleur_2.chemin\"),\n        \"serialbaud\": 2400,\n        \"databits\": 8,\n        \"parity\": \"none\",\n        \"stopbits\": 1,\n        \"enabled\": true\n    }\n\n    node.send(msg);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":600,"wires":[["8f1237b869c14ea1"]]},{"id":"6f2d5d63ff8a1996","type":"debug","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"debug 165","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":600,"wires":[]},{"id":"e6814947783104d0","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"function 63","func":"msg.payload = \"Changement \" + global.get(\"onduleurs.onduleur_2.type\") + \" 2 sur serial \" + global.get(\"onduleurs.onduleur_2.chemin\"); //NOLAK\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":600,"wires":[["6f2d5d63ff8a1996"]]},{"id":"6f8d921dbbde0f9b","type":"serial control","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"","serial":"e9cc506ca82e0dcd","x":630,"y":640,"wires":[["3c0cc6ecf43cc696"]]},{"id":"702384d56cbcae73","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"serial onduleur","func":"if (global.get(\"onduleurs.onduleur_3.ComType\") == \"serial\" && global.get(\"onduleurs.onduleur_3.type\") == \"voltronic\") {\n    msg.payload = {\n        \"serialport\": global.get(\"onduleurs.onduleur_3.chemin\"),\n        \"serialbaud\": 2400,\n        \"databits\": 8,\n        \"parity\": \"none\",\n        \"stopbits\": 1,\n        \"enabled\": true\n    }\n\n    node.send(msg);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":640,"wires":[["6f8d921dbbde0f9b"]]},{"id":"eab61bd9398d6404","type":"debug","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"debug 166","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":640,"wires":[]},{"id":"3c0cc6ecf43cc696","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"function 64","func":"msg.payload = \"Changement \" + global.get(\"onduleurs.onduleur_3.type\") + \" 3 sur serial \" + global.get(\"onduleurs.onduleur_3.chemin\"); //NOLAK\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":640,"wires":[["eab61bd9398d6404"]]},{"id":"24e6d36d354142dc","type":"serial control","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"","serial":"7e4f5bc8b4fd8bf3","x":630,"y":680,"wires":[["3d583a0afa7c3bf9"]]},{"id":"a22ecc7b93d0d1e7","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"serial onduleur","func":"if (global.get(\"onduleurs.onduleur_4.ComType\") == \"serial\" && global.get(\"onduleurs.onduleur_4.type\") == \"voltronic\") {\n    msg.payload = {\n        \"serialport\": global.get(\"onduleurs.onduleur_4.chemin\"),\n        \"serialbaud\": 2400,\n        \"databits\": 8,\n        \"parity\": \"none\",\n        \"stopbits\": 1,\n        \"enabled\": true\n    }\n\n    node.send(msg);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":680,"wires":[["24e6d36d354142dc"]]},{"id":"526384e443060a46","type":"debug","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"debug 167","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":680,"wires":[]},{"id":"3d583a0afa7c3bf9","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"function 65","func":"msg.payload = \"Changement \" + global.get(\"onduleurs.onduleur_4.type\") + \" 4 sur serial \" + global.get(\"onduleurs.onduleur_4.chemin\"); //NOLAK\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":680,"wires":[["526384e443060a46"]]},{"id":"8dc998ce14051b15","type":"mqtt out","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"MQTT Interne","topic":"","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"2f656901c2de4368","x":960,"y":460,"wires":[]},{"id":"3f926d588614512c","type":"inject","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"connect","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":120,"y":460,"wires":[["2b7e2663dafc533e"]]},{"id":"2b7e2663dafc533e","type":"function","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"function 84","func":"if(global.get(\"mqttInterne\") == true){\n\n    msg.action = \"connect\";\n    msg.broker = '{\"broker\":\"mosquitto\",'\n        +'\"port\":\"1883\",'\n        +'\"username\":\"smartphoton\",'\n        +'\"password\":\"smartphoton\"'\n        +'}';\n    return msg\n\n}\n//NOLAK\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":460,"wires":[["4ee71da3f395283e"]]},{"id":"4ee71da3f395283e","type":"json","z":"860d5c4e8609e907","g":"f47960d36038d6ab","name":"","property":"broker","action":"","pretty":false,"x":710,"y":460,"wires":[["8dc998ce14051b15"]]},{"id":"9219bd0a7653b324","type":"catch","z":"860d5c4e8609e907","name":"","scope":["83bb99f3a60d51e3","8f1237b869c14ea1","6f8d921dbbde0f9b","24e6d36d354142dc","aadd5b24995a151c"],"uncaught":false,"x":120,"y":1120,"wires":[["5e15d285874f7f55","3ad931b2f912264b"]]},{"id":"5e15d285874f7f55","type":"function","z":"860d5c4e8609e907","name":"function 93","func":"// Dans le n≈ìud function\nreturn null;  // Cela √©vitera l'affichage dans les logs","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1120,"wires":[[]]},{"id":"3ad931b2f912264b","type":"debug","z":"860d5c4e8609e907","name":"debug 198","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":300,"y":1180,"wires":[]},{"id":"a9e014a7f18a4aa2","type":"link in","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"Reco onduleur","links":[],"x":65,"y":620,"wires":[["784ff393358ed198"]]},{"id":"784ff393358ed198","type":"function","z":"860d5c4e8609e907","g":"021aca70c76e5e8e","name":"function 94","func":"if (msg.voltronicNum == 1 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial') {\n\n    node.send([msg, , ,]);\n\n}\n\nif (msg.voltronicNum == 2 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial'){\n\n    node.send([,msg,,]);\n\n}\n\nif (msg.voltronicNum == 3 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial'){\n\n    node.send([,,msg,]);       \n          \n}\n\nif (msg.voltronicNum == 4 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial') {\n\n    node.send([,,,msg]);\n          \n}","outputs":4,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":620,"wires":[["4a715e5c6917c9e0"],["8555e5bb36cc62d7"],["702384d56cbcae73"],["a22ecc7b93d0d1e7"]]},{"id":"6fe60941453c699e","type":"debug","z":"860d5c4e8609e907","name":"debug 202","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":560,"y":140,"wires":[]},{"id":"a7ff0f399614846c","type":"inject","z":"a75e6cc9dd444ba5","name":"start","props":[{"p":"model","v":"VERSION","vt":"env"},{"p":"manufacturer","v":"Smartphoton","vt":"str"},{"p":"value","v":"{{value}}","vt":"str"},{"p":"configuration_url","v":"https://domosimple.eu","vt":"str"}],"repeat":"300","crontab":"","once":true,"onceDelay":"20","topic":"","x":110,"y":40,"wires":[["25528db1773055b4"]]},{"id":"05c55b3eaea766d1","type":"comment","z":"a75e6cc9dd444ba5","name":"A remplacer par le dernier noeud","info":"","x":1310,"y":280,"wires":[]},{"id":"17db98b4ff2cf91b","type":"debug","z":"a75e6cc9dd444ba5","name":"debug 169","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":1000,"wires":[]},{"id":"611d3590f5f0b946","type":"function","z":"a75e6cc9dd444ba5","name":"chemin","func":"\n\n    msg.chemin = '/homeassistant/.storage/lovelace_dashboards'\n    node.send(msg);\n\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":1000,"wires":[["f81ee4d888d0d015"]]},{"id":"f81ee4d888d0d015","type":"file in","z":"a75e6cc9dd444ba5","name":"","filename":"chemin","filenameType":"msg","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":470,"y":1000,"wires":[["805c01d290f5c9b0"]]},{"id":"dd5837a6ec676da4","type":"inject","z":"a75e6cc9dd444ba5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1000,"wires":[["611d3590f5f0b946"]]},{"id":"805c01d290f5c9b0","type":"json","z":"a75e6cc9dd444ba5","name":"","property":"payload","action":"","pretty":false,"x":610,"y":1000,"wires":[["9811d6099e3d4124","2da66cc3079f9a1a"]]},{"id":"9811d6099e3d4124","type":"function","z":"a75e6cc9dd444ba5","name":"function 69","func":"\n\n\n\n// Add a new object to the array \nmsg.payload.data.items.push({ \"id\": \"dashboard_smartphoton\", \"show_in_sidebar\": true, \"title\": \"Smartphoton\", \"require_admin\": false, \"mode\": \"storage\", \"url_path\": \"dashboard_smartphoton\" });\n\nnode.send(msg);\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":1000,"wires":[["81652f14412f24b6"]]},{"id":"2da66cc3079f9a1a","type":"debug","z":"a75e6cc9dd444ba5","name":"debug 170","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":770,"y":1040,"wires":[]},{"id":"81652f14412f24b6","type":"file","z":"a75e6cc9dd444ba5","name":"","filename":"chemin","filenameType":"msg","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":960,"y":1000,"wires":[["17db98b4ff2cf91b"]]},{"id":"25528db1773055b4","type":"link out","z":"a75e6cc9dd444ba5","name":"link out 31","mode":"link","links":["9288eb4f7f914c95","af76dae58fd6e040","26d935d1f1c88c85","d71e5964f9c19d3d","aa9083275d3a7a7e","0aa48cfc8610dc17"],"x":285,"y":40,"wires":[]},{"id":"a3557245e092b263","type":"template","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"homeassistant/{{type_ha}}/{{onduleurType}}_{{ha_num_onduleur}}{{ha_num_qpgs}}/{{onduleurType}}_{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}/config","output":"str","x":880,"y":400,"wires":[["3cec1b2e07a5270d"]]},{"id":"6dabbcf4fa89e32f","type":"template","z":"a75e6cc9dd444ba5","g":"0b85c8e85d257ed5","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \n  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}} {{ha_name_topic}}\", \n  \"object_id\":\"{{onduleurType}}__{{ha_num_onduleur}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}__{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  \"command_topic\": \"{{global.parametre.mqtt.DirSmart}}/Modification-{{onduleurType}}/{{numOnduleur}}/Param{{ha_num_param}}\",\n  \"command_template\": \"{{value}}\",\n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{numOnduleur}}/{{ha_state_topic}}\", \n  \"value_template\": \"{{ value }}\",\n  \"options\":  [ {{{ha_select}}} ],\n  \"device\":{\n    \"manufacturer\":\"{{manufacturer}}\",\n  \t\"name\":\"{{global.name.Onduleur}} {{ha_num_onduleur}}\", \n  \t\"model\":\"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n  \t\"identifiers\":[\"{{onduleurType}}_{{ha_num_onduleur}}\"]\n\t}\n}","output":"str","x":680,"y":620,"wires":[["a3557245e092b263"]]},{"id":"da77f62a0e0b2d07","type":"function","z":"a75e6cc9dd444ba5","g":"0b85c8e85d257ed5","name":"Select","func":"msg.type_ha = 'select' ;\n\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n    if (global.get(\"onduleurs.onduleur_\" + i + \".active\") == true) {\n        msg.numOnduleur = i;\n        msg.onduleurType = global.get(\"onduleurs.onduleur_\" + i + \".type\");\n        msg.ha_num_onduleur = msg.numOnduleur;\n        node.send(msg);\n    }\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":620,"wires":[["62233f54e0322608"]]},{"id":"26d935d1f1c88c85","type":"link in","z":"a75e6cc9dd444ba5","g":"0b85c8e85d257ed5","name":"link in 14","links":["25528db1773055b4"],"x":85,"y":620,"wires":[["da77f62a0e0b2d07"]]},{"id":"d01723e538d41be2","type":"template","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\n  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}}{{ha_num_qpgs}} {{ha_name_topic}}\",\n  {{{ha_device_class}}} \n  {{{ha_unit_of_measurement}}}\n  {{{entity_category}}}\n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{ha_num_onduleur}}/{{ha_state_topic}}\", \n  {{{attribut}}}\n  \"value_template\": \"{{ value }}\",\n  \"object_id\": \"{{onduleurType}}_{{ha_num_onduleur}}{{ha_num_qpgs}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}_{{ha_num_onduleur}}{{ha_num_qpgs}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  {{{ha_icon}}}\n  \"device\":{\n    \"manufacturer\": \"{{manufacturer}}\",\n\t  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}}{{ha_num_qpgs}}\",\n\t  \"model\": \"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n\t  \"identifiers\": [\"{{onduleurType}}_{{ha_num_onduleur}}{{ha_num_qpgs}}\"]\n\t}\n}","output":"str","x":680,"y":400,"wires":[["a3557245e092b263"]]},{"id":"5794af442715a4f1","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"Puissance watt.....","func":"\n/*-------------------------------------------------*/\n//Puissance \n/*-------------------------------------------------*/\n\n msg.ha_device_class = '\"device_class\": \"power\",';\n msg.ha_unit_of_measurement = '\"unit_of_measurement\": \"W\",';\n msg.ha_nom_unit = 'watt';\n\t\n\t/*-------------------------------------------------*/\n\t//PV Puissance (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.PV\");\n\t msg.ha_type_topic = 'pv';\n\t msg.ha_icon = '\"icon\": \"mdi:solar-power-variant\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_19' :\n\t\t\t\t\t      (msg.onduleurType == \"easun\") ? '265' :\n\t\t\t\t\t\t  (msg.onduleurType == \"GrowattSPH\") ? '' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t/*-------------------------------------------------*/\n\t//Batt Charge (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.Batt_charge\");\n\t msg.ha_type_topic = 'batt_charge';\n\t msg.ha_icon = '\"icon\": \"mdi:battery-arrow-up-outline\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\")? 'custom_1' :\n\t\t\t\t    \t  (msg.onduleurType == \"easun\") ? '270' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\t\n\t/*-------------------------------------------------*/\n\t//Batt decharge (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.Batt_batt_decharge\");\n\t msg.ha_type_topic = 'batt_decharge';\n\t msg.ha_icon = '\"icon\": \"mdi:battery-arrow-down-outline\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'custom_2' :\n\t\t\t\t\t      (msg.onduleurType == \"easun\") ? '270' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\t\n\t/*-------------------------------------------------*/\n\t//Batt charge Decharge sens (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.Batt_batt_chargedecharge\");\n\t msg.ha_type_topic = 'batt_charge_decharge';\n\t msg.ha_icon = '\"icon\": \"mdi:battery-arrow-down-outline\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'custom_3' :\n\t\t\t\t\t      (msg.onduleurType == \"easun\") ? '270' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t/*-------------------------------------------------*/\n\t//Conso Maison (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.Conso_maison\");\n\t msg.ha_type_topic = 'conso_maison';\n\t msg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt-outline\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_5' :\n\t\t\t\t\t      (msg.onduleurType == \"easun\") ? '539' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t/*-------------------------------------------------*/\n\t//Conso Grid (Watt)\n\t/*-------------------------------------------------*/\n\t msg.ha_name_topic = global.get(\"name.conso_grid\");\n\t msg.ha_type_topic = 'conso_grid';\n\t msg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt-outline\",';\n\t\n\t msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_24' :\n\t\t\t\t\t      'Erreur';\n\t\t\t\t\t\t \n\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t/*-------------------------------------------------*/\n\t//si qpigs2 (2√®me string) est diff√©rent de NAK\n\t/*-------------------------------------------------*/\n\tif (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpigs2') != 'NAK'){\n\n\t\t/*-------------------------------------------------*/\n\t\t//PV Puissance 2 (Watt)\n\t\t/*-------------------------------------------------*/\n\t\tmsg.ha_name_topic = global.get(\"name.PV2\");\n\t\tmsg.ha_type_topic = 'pv2';\n\t\tmsg.ha_icon = '\"icon\": \"mdi:solar-power-variant\",';\n\t\t\n\t\tmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpigs2_2' :\n\t\t\t\t\t\t\t(msg.onduleurType == \"easun\") ? '' :\n\t\t\t\t\t\t\t'Erreur';\n\t\t\t\t\t\t\t\n\t\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t}\n\n\t/*-------------------------------------------------*/\n\t//si plusieur onduleur (qpgsx) est diff√©rent de NAK\n\t/*-------------------------------------------------*/\n\t\n\t/*\n\tif (global.get(\"qpgs1\") != 'NAK'){\n\n\t}\n\t*/\n\n\tif (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpgs') != false) {\n\t\tfor (let i = 2; i <= 8; i++) {\n\t\t\tlet topic = 'onduleurs.onduleur_' + msg.numOnduleur + '.qpgs_' + i;\n\t\t\tif (global.get(topic) == true) {\n\t\t\t\t\n\t\t\t\tmsg.ha_num_qpgs = '_' + i;\n\n\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\t//Batt Charge (Watt) qpgs\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\tmsg.ha_name_topic = global.get(\"name.Batt_charge\") + ' via maitre';\n\t\t\t\tmsg.ha_type_topic = 'batt_charge_qpgs';\n\t\t\t\tmsg.ha_icon = '\"icon\": \"mdi:battery-arrow-up-outline\",';\n\n\t\t\t\tmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'custom_' + i + '01' :\n\t\t\t\t\t\t'Erreur';\n\n\t\t\t\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\t\t\t\t\n\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\t//Batt decharge (Watt) qpgs\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\tmsg.ha_name_topic = global.get(\"name.Batt_batt_decharge\") + ' via maitre';\n\t\t\t\tmsg.ha_type_topic = 'batt_decharge_qpgs';\n\t\t\t\tmsg.ha_icon = '\"icon\": \"mdi:battery-arrow-down-outline\",';\n\n\t\t\t\tmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'custom_' + i + '02' :\n\t\t\t\t\t\t'Erreur';\n\n\t\t\t\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\t//Batt charge Decharge sens (Watt) qpgs\n\t\t\t\t/*-------------------------------------------------*/\n\t\t\t\tmsg.ha_name_topic = global.get(\"name.Batt_batt_chargedecharge\") + ' via maitre';\n\t\t\t\tmsg.ha_type_topic = 'batt_charge_decharge_qpgs';\n\t\t\t\tmsg.ha_icon = '\"icon\": \"mdi:battery-arrow-down-outline\",';\n\n\t\t\t\tmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'custom_' + i + '03' :\n\t\t\t\t\t\t'Erreur';\n\n\t\t\t\tif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":280,"wires":[["d01723e538d41be2"]]},{"id":"717d8ea229eec645","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"Tension volt ..........","func":"\n/*-------------------------------------------------*/\n//Tension \n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"voltage\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"V\",';\nmsg.ha_nom_unit = 'volt';\n\n    /*-------------------------------------------------*/\n    //Grid Tension (Volt)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.GridTension\");\n    msg.ha_type_topic = 'grid_tension';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_0' :\n        (msg.onduleurType == \"easun\") ? '531' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //Batterie Voltage (Volt)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.BattTensiont\");\n    msg.ha_type_topic = 'batt';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_8' :\n        (msg.onduleurType == \"easun\") ? '257' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //PV Voltage (Volt)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.PvTensiont\");\n    msg.ha_type_topic = 'pv';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_13' :\n                         (msg.onduleurType == \"easun\") ? '263' :\n                         'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //Onduleur Tension (Volt)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.OnduleurTension\");\n    msg.ha_type_topic = 'onduleur_tension';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_2' :\n                         (msg.onduleurType == \"easun\") ? '534' :\n                         'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\n    /*-------------------------------------------------*/\n    //si qpigs2 (2√®me string) est diff√©rent de NAK\n    /*-------------------------------------------------*/\n\n    if (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpigs2') != 'NAK'){\n\n        /*-------------------------------------------------*/\n        //PV2 Voltage (Volt)\n        /*-------------------------------------------------*/\n        msg.ha_name_topic = global.get(\"name.Pv2Tensiont\");\n        msg.ha_type_topic = 'pv2';\n        msg.ha_icon = '';\n\n        msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpigs2_1' :\n                'Erreur';\n\n        if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n    }\n    \n    /*-------------------------------------------------*/\n    //Si plusieurs onduleurs\n    /*-------------------------------------------------*/\n\tif (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpgs') != false) {\n\t\tfor (let i = 2; i <= 8; i++) {\n\t\t\tlet topic = 'onduleurs.onduleur_' + msg.numOnduleur + '.qpgs_' + i;\n\t\t\tif (global.get( topic ) == true){\n\n                msg.ha_num_qpgs = '_' + i;\n\n                /*-------------------------------------------------*/\n                //PV Voltage (Volt) qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.PvTensiont\") + ' via maitre';\n                msg.ha_type_topic = 'pv_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_14' :\n                                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n                /*-------------------------------------------------*/\n                //Grid Tension (Volt) qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.GridTension\") + ' via maitre';\n                msg.ha_type_topic = 'grid_tension_qpgs';\n                msg.ha_icon = '';\n\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_4' :\n                                     'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n                /*-------------------------------------------------*/\n                //Onduleur Tension (Volt) qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.OnduleurTension\") + ' via maitre';\n                msg.ha_type_topic = 'onduleur_tension_qpgs';\n                msg.ha_icon = '';\n\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_6' :\n                                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n            }\n        }\n    }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":360,"wires":[["d01723e538d41be2"]]},{"id":"a55dea0751634bf1","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"intensit√© Ampere","func":"\n/*-------------------------------------------------*/\n//courant\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"current\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"A\",';\nmsg.ha_nom_unit = 'current';\n\n    /*-------------------------------------------------*/\n    //Pv Intensite (Amp)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.PvIntensite\");\n    msg.ha_type_topic = 'pv_intensite';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_12' :\n        (msg.onduleurType == \"easun\") ? '264' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //Grid intensite (Amp)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Grid Intensite (Amp)';\n    msg.ha_type_topic = 'grid_intensite';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"easun\") ? '532' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //Batt Charge (Amp)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.BattChargeIntensite\");\n    msg.ha_type_topic = 'batt_charge_intensite';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_9' :\n        (msg.onduleurType == \"easun\") ? '258' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    /*-------------------------------------------------*/\n    //Batt Decharge (Amp)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.BattDechargeIntensite\");\n    msg.ha_type_topic = 'batt_decharge_intensite';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_15' :\n        (msg.onduleurType == \"easun\") ? '' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n\n    /*-------------------------------------------------*/\n    //si qpigs2 (2√®me string) est diff√©rent de NAK\n    /*-------------------------------------------------*/\n    if (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpigs2') != 'NAK'){\n\n        /*-------------------------------------------------*/\n        //Pv 2 Intensite (Amp)\n        /*-------------------------------------------------*/\n        msg.ha_name_topic = global.get(\"name.Pv2Intensite\");\n        msg.ha_type_topic = 'pv2_intensite';\n        msg.ha_icon = '';\n\n        msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpigs2_0' :\n                'Erreur';\n\n        if (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n    }\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":400,"wires":[["d01723e538d41be2"]]},{"id":"9a4bc966849d6517","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"Frequence Hz.....","func":"\n/*-------------------------------------------------*/\n// Frequence\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"frequency\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"Hz\",';\nmsg.ha_nom_unit = 'frequency';\n\n    /*-------------------------------------------------*/\n    //Data-Frequency (Hz)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.DataFrequency\");\n    msg.ha_type_topic = 'data';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_1' :\n        (msg.onduleurType == \"easun\") ? '533' :\n            'Erreur';\n\n    node.send(msg)\n\n    /*-------------------------------------------------*/\n    //Onduleur-Frequency (Hz)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.OnduleurFrequency\");\n    msg.ha_type_topic = 'onduleur_frequency';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_3' :\n        (msg.onduleurType == \"easun\") ? '536' :\n            'Erreur';\n\n    node.send(msg)\n\n\tif (global.get( 'onduleurqpgs' + msg.numOnduleur ) != false){\n\t\tfor (let i = 2; i <= 8; i++) {\n\t\t\tlet topic =  msg.numOnduleur + 'qpgs' + i ;\n\t\t\tif (global.get( topic ) == true){\n\n                msg.ha_num_qpgs = '_' + i;\n                \n                /*-------------------------------------------------*/\n                //Data-Frequency (Hz)\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.DataFrequency\") + ' via maitre';\n                msg.ha_type_topic = 'data_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_5' :\n                                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n                /*-------------------------------------------------*/\n                //Onduleur-Frequency (Hz) qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.OnduleurFrequency\") + ' via maitre';\n                msg.ha_type_topic = 'onduleur_frequency_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_7' :\n                                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n\n            }\n\n\n        }\n    }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":440,"wires":[["d01723e538d41be2"]]},{"id":"894c3ada9d213ed0","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"%........................","func":"\n/*-------------------------------------------------*/\n// %\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"battery\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"%\",';\nmsg.ha_nom_unit = 'battery';\n\n    /*-------------------------------------------------*/\n    //Batterie Capacit√©\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.BattCapacite\");\n    msg.ha_type_topic = 'batt';\n    // msg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt-outline\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_10' :\n        (msg.onduleurType == \"easun\") ? '256' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":480,"wires":[["d01723e538d41be2"]]},{"id":"a98daf18f2b7c53e","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"Autre....................","func":"\n/*-------------------------------------------------*/\n// Mode\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '';\nmsg.ha_unit_of_measurement = '';\nmsg.ha_nom_unit = 'info';\n\n    /*-------------------------------------------------*/\n    //Mode Solar\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.Mode\");\n    msg.ha_type_topic = 'mode';\n    msg.ha_icon = '';\n    msg.entity_category = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qmod_0' :\n        (msg.onduleurType == \"easun\") ? 'setup1_4' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n    /*-------------------------------------------------*/\n    //Date\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Date\";\n    msg.ha_type_topic = 'date';\n    msg.ha_icon = '';\n    msg.entity_category = '';\n\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'date_0_date' :\n                         (msg.onduleurType == \"easun\") ? '' :\n                            'Erreur';\n\n    //ajout le topic attribut\n    if (msg.onduleurType == \"voltronic\") {\n        msg.chemAttrib = global.get(\"parametre.mqtt.DirSmart\") + \"/\" + msg.onduleurType + \"_\" + msg.ha_num_onduleur + \"/date_0\";\n        msg.attribut = '\"json_attributes_topic\": \"' + msg.chemAttrib + '\",';   \n    }                 \n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n\n    msg.attribut = \"\";\n\n    /*-------------------------------------------------*/\n    //Erreur code Onduleur\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Code Erreur';\n    msg.ha_type_topic = 'code_erreur';\n    msg.ha_icon = '';\n    msg.entity_category = '\"entity_category\": \"diagnostic\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpiws_0_code' :\n                          'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n    /*-------------------------------------------------*/\n    //Erreur Onduleur\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Info Erreur';\n    msg.ha_type_topic = 'info_erreur';\n    msg.ha_icon = '';\n    msg.entity_category = '\"entity_category\": \"diagnostic\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpiws_0' :\n                          'Erreur';\n\n    //ajout le topic attribut\n    if (msg.onduleurType == \"voltronic\") {\n        msg.chemAttrib = global.get(\"parametre.mqtt.DirSmart\") + \"/\" + msg.onduleurType + \"_\" + msg.ha_num_onduleur + \"/qpiws_0_attrib\";\n        msg.attribut = '\"json_attributes_topic\": \"' + msg.chemAttrib + '\",';   \n    }  \n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n    msg.attribut = \"\";\n\n    /*-------------------------------------------------*/\n    //Version Firmware\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Version Firmware';\n    msg.ha_type_topic = 'info_firm';\n    msg.ha_icon = '';\n    msg.entity_category = '\"entity_category\": \"diagnostic\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'QVFW_0' :\n                          'Erreur';\n\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n    /*-------------------------------------------------*/\n    //Version Firmware\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Num√©ro de s√©rie';\n    msg.ha_type_topic = 'info_N_serie';\n    msg.ha_icon = '';\n    msg.entity_category = '\"entity_category\": \"diagnostic\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'QID_0' :\n                          'Erreur';\n\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n    /*-------------------------------------------------*/\n    //Mod√®le\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Mod√®le';\n    msg.ha_type_topic = 'info_model';\n    msg.ha_icon = '';\n    msg.entity_category = '\"entity_category\": \"diagnostic\",';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'QMN_0' :\n                          'Erreur';\n\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n\n    if (global.get(\"battNb\") != '0') {\n\n        /*-------------------------------------------------*/\n        //Total batterie\n        /*-------------------------------------------------*/\n        msg.ha_name_topic = \"Total batterie\";\n        msg.ha_type_topic = 'total_batterie';\n        msg.ha_icon = '';\n        msg.entity_category = '';\n\n        msg.ha_state_topic = \"totalbatt\";\n\n        if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n    }\n\n\n\tif (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qpgs') != false) {\n\t\tfor (let i = 2; i <= 8; i++) {\n\t\t\tlet topic = 'onduleurs.onduleur_' + msg.numOnduleur + '.qpgs_' + i;\n\t\t\tif (global.get( topic ) == true){\n                \n                msg.ha_num_qpgs = '_' + i;\n\n                /*-------------------------------------------------*/\n                // Mode qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = global.get(\"name.Mode\") + ' via maitre';\n                msg.ha_type_topic = 'mode_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_2' :\n                                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n                /*-------------------------------------------------*/\n                // Code d'erreur qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = \"Code erreur\" + ' via maitre';\n                msg.ha_type_topic = 'erreur_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_3' :\n                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n                /*-------------------------------------------------*/\n                // serial number qpgs\n                /*-------------------------------------------------*/\n                msg.ha_name_topic = \"Serial\" + ' via maitre';\n                msg.ha_type_topic = 'serial_qpgs';\n                msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpgs' + i + '_1' :\n                    'Erreur';\n\n                if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n            }\n        }\n    }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":560,"wires":[["d01723e538d41be2"]]},{"id":"fa5efaca50dc48b7","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"Temp√©rature C.......","func":"\n/*-------------------------------------------------*/\n// Temperature\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"temperature\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"¬∞C\",';\nmsg.ha_nom_unit = 'temperature';\n\n    /*-------------------------------------------------*/\n    //Temperature (¬∞C)\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = global.get(\"name.Temp\");\n    msg.ha_type_topic = 'temp';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'qpig_11' :\n        (msg.onduleurType == \"easun\") ? '546' :\n            'Erreur';\n\n    if (msg.ha_state_topic != 'Erreur'){node.send(msg);}\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":520,"wires":[["d01723e538d41be2"]]},{"id":"8626e3e7f27b61bb","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"sensor","func":"msg.type_ha = 'sensor' ;\n\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n    if (global.get(\"onduleurs.onduleur_\" + i + \".active\") == true) {\n        msg.numOnduleur = i;\n        msg.onduleurType = global.get(\"onduleurs.onduleur_\" + i + \".type\");\n        msg.ha_num_onduleur = msg.numOnduleur;\n        node.send(msg);\n    }\n\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":400,"wires":[["5794af442715a4f1","717d8ea229eec645","a55dea0751634bf1","9a4bc966849d6517","894c3ada9d213ed0","fa5efaca50dc48b7","a98daf18f2b7c53e","2963aa6a856673ee"]]},{"id":"af76dae58fd6e040","type":"link in","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"link in 13","links":["25528db1773055b4"],"x":85,"y":400,"wires":[["8626e3e7f27b61bb"]]},{"id":"3cec1b2e07a5270d","type":"link out","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"MQTT-External-broker-ou","mode":"link","links":["5473c4b21f7c5529"],"x":1035,"y":400,"wires":[]},{"id":"c1f27b019f2b162d","type":"function","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"sensor smart","func":"\nmsg.type_ha = 'sensor';\nmsg.onduleurType = 'config';\n\nnode.send(msg);","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":120,"wires":[["2f880ae1f7af646f"]]},{"id":"2f880ae1f7af646f","type":"function","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"Autre","func":"\n/*-------------------------------------------------*/\n// Mode\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '';\nmsg.ha_unit_of_measurement = '';\nmsg.ha_nom_unit = 'info';\n\n    /*-------------------------------------------------*/\n    //Nombre de connexion usb\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Nombre de connexion onduleur ';\n    msg.ha_type_topic = 'nb_onduleur';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = 'nbconnexionOnduleur';\n\n    node.send(msg)\n\n    /*-------------------------------------------------*/\n    //Version\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Version';\n    msg.ha_type_topic = 'model';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = 'version';\n\n    node.send(msg)\n    \n    /*-------------------------------------------------*/\n    //Version\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Version';\n    msg.ha_type_topic = 'model';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = 'version';\n\n    node.send(msg)\n\n    /*-------------------------------------------------*/\n    //Total batterie\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Total batterie\";\n    msg.ha_type_topic = 'total_batterie';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = \"totalbatt\";\n\n    node.send(msg);\n    \n\n    // Valeur diff√©rente connexion onduleur\n    let count = global.get(\"countUSBOnduleur\")\n    for (let i = 1; i <= count; i++) {\n\n                //Chemin\n                msg.ha_name_topic = \"Onduleur \" + i + \" Chemin\";\n                msg.ha_type_topic = 'onduleur' + i + 'Chemin';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'onduleur' + i + 'Chemin';\n\n                node.send(msg);\n        \n                //Type \n                msg.ha_name_topic = \"Onduleur \" + i + \" Type\";\n                msg.ha_type_topic = 'onduleur' + i + 'Type';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'onduleur' + i + 'Type';\n\n                node.send(msg);\n\n                //TypeCom (ip ou serial)\n                msg.ha_name_topic = \"Onduleur \" + i + \" TypeCom\";\n                msg.ha_type_topic = 'onduleur' + i + 'TypeCom';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'onduleur' + i + 'TypeCom';\n\n                node.send(msg);\n            \n                //Tension des batterie\n                msg.ha_name_topic = \"Onduleur \" + i + \" Tension\";\n                msg.ha_type_topic = 'onduleur' + i + 'Tension';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'onduleur' + i + 'Tension';\n\n                node.send(msg);\n\n                //Status de communication\n                msg.ha_name_topic = \"Onduleur \" + i + \" Communication\";\n                msg.ha_type_topic = 'onduleur' + i + 'Communication';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'onduleur' + i + '_status';\n\n                node.send(msg);\n\n\n    }\n\n    // Valeur diff√©rente connexion onduleur\n    count = global.get(\"countUSBBatterie\")\n    for (let i = 1; i <= count; i++) {\n\n                //Chemin\n                msg.ha_name_topic = \"Batterie \" + i + \" Chemin\";\n                msg.ha_type_topic = 'batterie' + i + 'Chemin';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'batterie' + i + 'Chemin';\n\n                node.send(msg);\n        \n                //Type \n                msg.ha_name_topic = \"Batterie \" + i + \" Type\";\n                msg.ha_type_topic = 'batterie' + i + 'Type';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'batterie' + i + 'Type';\n\n                node.send(msg);\n\n                //TypeCom (ip ou serial)\n                msg.ha_name_topic = \"Batterie \" + i + \" TypeCom\";\n                msg.ha_type_topic = 'batterie' + i + 'TypeCom';\n                msg.ha_icon = '';\n                msg.ha_state_topic = 'batterie' + i + 'TypeCom';\n\n                node.send(msg);\n\n    }\n\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":120,"wires":[["2a75a681802ec1b2"]]},{"id":"2a75a681802ec1b2","type":"template","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\n  \"name\": \"{{ha_name_topic}}\",\n  {{{ha_device_class}}} \n  {{{ha_unit_of_measurement}}}\n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}{{ha_num_onduleur}}/{{ha_state_topic}}\", \n  \"value_template\": \"{{ value }}\",\n  \"object_id\": \"{{onduleurType}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  {{{ha_icon}}}\n  \"device\":{\n    \"manufacturer\": \"{{manufacturer}}\",\n\t  \"name\": \"Smartphoton\",\n\t  \"model\": \"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n\t  \"identifiers\": [\"{{onduleurType}}\"]\n\t}\n}","output":"str","x":680,"y":120,"wires":[["a3557245e092b263","4f3505c5edd531d1"]]},{"id":"4f3505c5edd531d1","type":"function","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"valeurConfig","func":"//Message a mqtt\n\n//Nombre de connexion\nmsg.topic = 'smartphoton/config/nbconnexionOnduleur';\nmsg.payload = global.get(\"countUSBOnduleur\");\n\nnode.send(msg);\n\n//Nombre de connexion\nmsg.topic = 'smartphoton/config/version';\nmsg.payload = msg.model;\n\nnode.send(msg);\n\n// Valeur diff√©rente connexion onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n        //Chemin\n        msg.topic = 'smartphoton/config/onduleur' + i + 'Chemin';\n        msg.payload = global.get('onduleurs.onduleur_' + i + '.chemin');\n\n        node.send(msg);\n\n        //Type\n        msg.topic = 'smartphoton/config/onduleur' + i + 'Type';\n        msg.payload = global.get('onduleurs.onduleur_' + i + '.type');\n\n        node.send(msg);\n\n        //TypeCom (ip ou serial)\n        msg.topic = 'smartphoton/config/onduleur' + i + 'TypeCom';\n        msg.payload = global.get('onduleurs.onduleur_' + i + '.ComType');\n\n        node.send(msg);\n\n\n        //Tension des batterie\n        msg.topic = 'smartphoton/config/onduleur' + i + 'Tension';\n        msg.payload = global.get('onduleurs.onduleur_' + i + '.battTension');\n\n        node.send(msg);\n\n\n}\n\n// Valeur diff√©rente connexion Batterie\ncount = global.get(\"countUSBBatterie\")\nfor (let i = 1; i <= count; i++) {\n\n        //Chemin\n        msg.topic = 'smartphoton/config/batterie' + i + 'Chemin';\n        msg.payload = global.get('batteries.batterie_' + i + '.chemin');\n\n        node.send(msg);\n\n        //Type \n        msg.topic = 'smartphoton/config/batterie' + i + 'Type';\n        msg.payload = global.get('batteries.batterie_' + i + '.type');\n\n        node.send(msg);\n\n        //TypeCom (ip ou serial)\n        msg.topic = 'smartphoton/config/batterie' + i + 'TypeCom';\n        msg.payload = global.get('batteries.batterie_' + i + '.ComType');\n\n        node.send(msg);\n\n        //Total Batterie\n        msg.topic = 'smartphoton/config/totalbatt';\n        msg.payload = global.get('batteries.batterie_' + i + '.battNb');\n\n        node.send(msg);\n\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":120,"wires":[["7b023de548513584"]]},{"id":"9288eb4f7f914c95","type":"link in","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"link in 12","links":["25528db1773055b4"],"x":65,"y":120,"wires":[["c1f27b019f2b162d","df3ae9e51097969c"]]},{"id":"7b023de548513584","type":"link out","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"MQTT-External-broker-ou","mode":"link","links":["5473c4b21f7c5529"],"x":1035,"y":120,"wires":[]},{"id":"03252685a38cb7c8","type":"function","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"Autre","func":"\n/*-------------------------------------------------*/\n// Mode\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '';\nmsg.ha_unit_of_measurement = '';\nmsg.ha_nom_unit = 'info';\n\n    /*-------------------------------------------------*/\n    //Nombre de connexion usb\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = 'Cr√©ation des capteurs ';\n    msg.ha_type_topic = 'nb_onduleur';\n    msg.ha_icon = '';\n\n    msg.ha_state_topic = 'nbconnexionOnduleur';\n\n    /*node.send(msg)*/\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":160,"wires":[["4a70884bd190b1ae"]]},{"id":"df3ae9e51097969c","type":"function","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"button","func":"\n\n\nmsg.type_ha = 'button';\nmsg.onduleurType = 'config';\n\nnode.send(msg);","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":160,"wires":[["03252685a38cb7c8"]]},{"id":"4a70884bd190b1ae","type":"template","z":"a75e6cc9dd444ba5","g":"07984b471c8206fe","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \n  \"name\": \"{{ha_name_topic}}\", \n  \"object_id\":\"{{onduleurType}}__{{ha_num_onduleur}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}__{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  \"command_topic\": \"{{global.parametre.mqtt.DirSmart}}/Modification-{{onduleurType}}/templateSensor\",\n  \"command_template\": \"{{value}}\",\n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{numOnduleur}}/{{ha_state_topic}}\", \n  \"value_template\": \"{{ value }}\",\n  \"options\":  [ {{{ha_select}}} ],\n  \"device\":{\n    \"manufacturer\": \"{{manufacturer}}\",\n\t  \"name\": \"Smartphoton\",\n\t  \"model\": \"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n\t  \"identifiers\": [\"{{onduleurType}}\"]\n\t}\n}","output":"str","x":680,"y":160,"wires":[["a3557245e092b263"]]},{"id":"71fdceed8c229052","type":"template","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \n  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}} {{ha_name_topic}}\", \n  \"object_id\": \"{{onduleurType}}_{{ha_num_onduleur}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}_{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{numOnduleur}}/{{command}}\", \n  \"command_topic\": \"{{global.parametre.mqtt.DirSmart}}/Modification-{{onduleurType}}/{{numOnduleur}}/ParamDate\",\n  \"device\": {\n    \"manufacturer\": \"{{manufacturer}}\", \n    \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}}\", \n    \"model\": \"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n    \"identifiers\": [\"{{onduleurType}}_{{ha_num_onduleur}}\"] \n  }\n}","output":"str","x":680,"y":720,"wires":[["a3557245e092b263"]]},{"id":"a09c7c808def6025","type":"function","z":"a75e6cc9dd444ba5","g":"3e480f13bec09ad4","name":"function parametre","func":"/*-------------------------------------------------*/\n//Date\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"R√®gler la date\";\nmsg.ha_type_topic = 'date';\nmsg.ha_num_param = '0';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'date'  \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '' \n        \n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":720,"wires":[["71fdceed8c229052"]]},{"id":"b3524695f7b5c3d3","type":"function","z":"a75e6cc9dd444ba5","g":"3e480f13bec09ad4","name":"button","func":"msg.type_ha = 'button' ;\n\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n    if (global.get(\"onduleurs.onduleur_\" + i + \".active\") == true) {\n        msg.numOnduleur = i;\n        msg.onduleurType = global.get(\"onduleurs.onduleur_\" + i + \".type\");\n        msg.ha_num_onduleur = msg.numOnduleur;\n        node.send(msg);\n    }\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":720,"wires":[["a09c7c808def6025"]]},{"id":"d71e5964f9c19d3d","type":"link in","z":"a75e6cc9dd444ba5","g":"3e480f13bec09ad4","name":"link in 19","links":["25528db1773055b4"],"x":85,"y":720,"wires":[["b3524695f7b5c3d3"]]},{"id":"4345bf1803993c24","type":"template","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \n  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}} {{ha_name_topic}}\", \n  \"object_id\": \"{{onduleurType}}_{{ha_num_onduleur}}_{{ha_type_topic}}\",\n  \"unique_id\": \"{{onduleurType}}_{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{numOnduleur}}/command\", \n  \"command_topic\": \"{{global.parametre.mqtt.DirSmart}}/Modification-{{onduleurType}}/{{numOnduleur}}/ParamCom\",\n  \"device\": {\n    \"manufacturer\": \"{{manufacturer}}\", \n    \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}}\", \n    \"model\": \"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n    \"identifiers\": [\"{{onduleurType}}_{{ha_num_onduleur}}\"] \n  }\n}","output":"str","x":680,"y":820,"wires":[["a3557245e092b263"]]},{"id":"c01a1336eb929025","type":"function","z":"a75e6cc9dd444ba5","g":"29ace0eb1724946e","name":"function parametre","func":"/*-------------------------------------------------*/\n//Date\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"Commande\";\nmsg.ha_type_topic = 'com';\nmsg.ha_num_param = '0';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'com'  \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '' \n        \n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":820,"wires":[["4345bf1803993c24"]]},{"id":"e12d24b3d57ae8c8","type":"function","z":"a75e6cc9dd444ba5","g":"29ace0eb1724946e","name":"Commande","func":"msg.type_ha = 'text' ;\n\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n    if (global.get(\"onduleurs.onduleur_\" + i + \".active\") == true) {\n        msg.numOnduleur = i;\n        msg.onduleurType = global.get(\"onduleurs.onduleur_\" + i + \".type\");\n        msg.ha_num_onduleur = msg.numOnduleur;\n        node.send(msg);\n    }\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":820,"wires":[["c01a1336eb929025"]]},{"id":"aa9083275d3a7a7e","type":"link in","z":"a75e6cc9dd444ba5","g":"29ace0eb1724946e","name":"link in 20","links":["25528db1773055b4"],"x":85,"y":820,"wires":[["e12d24b3d57ae8c8"]]},{"id":"0aa48cfc8610dc17","type":"link in","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"link in 3","links":["25528db1773055b4"],"x":85,"y":900,"wires":[["3e9f7fa1329725af"]]},{"id":"3e9f7fa1329725af","type":"function","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"number","func":"msg.type_ha = 'number' ;\n\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\nfor (let i = 1; i <= count; i++) {\n\n    if (global.get(\"onduleurs.onduleur_\" + i + \".active\") == true) {\n        msg.numOnduleur = i;\n        msg.onduleurType = global.get(\"onduleurs.onduleur_\" + i + \".type\");\n        msg.ha_num_onduleur = msg.numOnduleur;\n        node.send(msg);\n    }\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":900,"wires":[["9a22828b2b245873"]]},{"id":"9a22828b2b245873","type":"function","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"function parametre","func":"if (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qdop') != 'NAK'){\n    /*-------------------------------------------------*/\n    //QDOP\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Capacit√© de recharge de la batterie\";\n    msg.ha_type_topic = 'Battery_max_charging';\n    msg.ha_num_param = 'qdop8';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qdop_8' \n            msg.min = 5;\n            msg.max = 95;\n            msg.step = 1;\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            \n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n\n    msg.ha_name_topic = \"Capacit√© de re-d√©charge de la batterie\";\n    msg.ha_type_topic = 'Battery_max_discharging';\n    msg.ha_num_param = 'qdop9';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qdop_9' \n            msg.min = 10;\n            msg.max = 100;\n            msg.step = 1;\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            \n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n\n    msg.ha_name_topic = \"Capacit√© insuffisante de la batterie\";\n    msg.ha_type_topic = 'battery_under_capacity';\n    msg.ha_num_param = 'qdop10';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qdop_10' \n            msg.min = 0;\n            msg.max = 90;\n            msg.step = 1;\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            \n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":900,"wires":[["a1a1d92bf37b70c1"]]},{"id":"a1a1d92bf37b70c1","type":"template","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \n  \"name\": \"{{global.name.Onduleur}} {{ha_num_onduleur}} {{ha_name_topic}}\", \n  \"object_id\":\"{{onduleurType}}_{{ha_num_onduleur}}_{{ha_type_topic}}_{{ha_nom_unit}}\",\n  \"unique_id\": \"{{onduleurType}}_{{ha_num_onduleur}}_{{type_ha}}_{{ha_type_topic}}_{{ha_nom_unit}}\", \n  \"command_topic\": \"{{global.parametre.mqtt.DirSmart}}/Modification-{{onduleurType}}/{{numOnduleur}}/Param{{ha_num_param}}\",\n  \"command_template\": \"{{value}}\",\n  \"state_topic\": \"{{global.parametre.mqtt.DirSmart}}/{{onduleurType}}_{{numOnduleur}}/{{ha_state_topic}}\", \n  \"value_template\": \"{{ value }}\",\n  \"unit_of_measurement\": \"%\",\n  \"mode\": \"box\",\n  \"min\": {{min}},\n  \"max\": {{max}},\n  \"step\": {{step}},\n  \"device\":{\n    \"manufacturer\":\"{{manufacturer}}\",\n  \t\"name\":\"{{global.name.Onduleur}} {{ha_num_onduleur}}\", \n  \t\"model\":\"{{model}}\",\n    \"configuration_url\": \"{{{configuration_url}}}\",\n  \t\"identifiers\":[\"{{onduleurType}}_{{ha_num_onduleur}}\"]\n\t}\n}","output":"str","x":680,"y":900,"wires":[["a3557245e092b263"]]},{"id":"62233f54e0322608","type":"function","z":"a75e6cc9dd444ba5","g":"0b85c8e85d257ed5","name":"function parametre","func":"/*-------------------------------------------------*/\n//Param√®tre 01\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param01\");\nmsg.ha_type_topic = 'param01';\nmsg.ha_num_param = '01';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_16' \n        msg.ha_select = '\"UTI\", \"SOL\", \"SBU\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57860' \n        msg.ha_select = '\"UTI\", \"SOL\", \"SBU\"'\n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n/*-------------------------------------------------*/\n//Param√®tre 02\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param02\");\nmsg.ha_type_topic = 'param02';\nmsg.ha_num_param = '02';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_14' \n\n        // option((max, min, increment, decimal, prefixe, suffixe));\n         msg.ha_select = option(90, 10, 10, 0, '0', '') + ',\"100\",\"110\",\"120\",\"130\",\"140\",\"150\"' ;\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57866' \n\n        // option((max, min, increment, decimal, prefixe, suffixe));\n        msg.ha_select = option(80, 10, 10, 0, '', '');\n\n    }                      \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n/*-------------------------------------------------*/\n//Param√®tre 05\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param05\");\nmsg.ha_type_topic = 'param05';\nmsg.ha_num_param = '05';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_12' \n        msg.ha_select = '\"AGM\",\"Flooded\",\"User\",\"Pylon\",\"Weco\",\"Soltaro\",\"Lib\",\"Lic\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57348' \n        msg.ha_select = '\"USE\",\"SLD\",\"FLD\",\"GEL\",\"LIFEPO4X14\",\"LIFEPO4X15\",\"LIFEPO4X16\",\"LIFEPO4X7\",\"LIFEPO4X8\",\"LIFEPO4X9\",\"TERNARYIX7\",\"TERNARYIX8\",\"TERNARYIX13\",\"TERNARYIX14\"'\n\n    }\n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n\n/*-------------------------------------------------*/\n//Param√®tre 11\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param11\");\nmsg.ha_type_topic = 'param11';\nmsg.ha_num_param = '11';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_13' \n        let tableau = global.get(\"onduleurs.onduleur_\" + msg.ha_num_onduleur + \".param11\");\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '\"02\",' + option(60, 10, 10, 0, '', '') :\n                        //(global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? '\"02\",' + option(140, 10, 10, 0, '', '') :\n\t\t\t\t\t    (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? tableau.map(x => `\"${x}\"`).join(\",\") :\n                        'Erreur'; \n\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57861'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? '\"02\",' + option(60, 10, 10, 0, '', '') :\n\t\t\t\t\t    'Erreur'; \n        \n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 12\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param12\");\nmsg.ha_type_topic = 'param12';\nmsg.ha_num_param = '12';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_8' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(25.5, 22, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(51, 44, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57371'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(25.5, 25.5, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                      \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 13\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param13\");\nmsg.ha_type_topic = 'param13';\nmsg.ha_num_param = '13';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_22' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(58, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57378'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 16\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param16\");\nmsg.ha_type_topic = 'param16';\nmsg.ha_num_param = '16';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_17' \n        msg.ha_select = '\"CUE\",\"CSO\",\"SNU\",\"OSO\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57871' \n        msg.ha_select = '\"CSO\",\"CUB\",\"SNU\",\"OSO\"'\n\n    }\n    if( msg.ha_state_topic != '') {node.send(msg)}\n\n/*-------------------------------------------------*/\n//Param√®tre 26\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param26\");\nmsg.ha_type_topic = 'param26';\nmsg.ha_num_param = '26';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_10' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(32, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(64.1, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57354'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                     \n    if( msg.ha_state_topic != '') {node.send(msg)}\n\n/*-------------------------------------------------*/\n//Param√®tre 27\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param27\");\nmsg.ha_type_topic = 'param27';\nmsg.ha_num_param = '27';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_11' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(58.1, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57351'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 29\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param29\");\nmsg.ha_type_topic = 'param29';\nmsg.ha_num_param = '29';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_9' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(24, 21, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(48.1, 42, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57357'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n       \n\n    }                   \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//fonction calcul incr√©mentation\n/*-------------------------------------------------*/\nfunction option(max, min, increment, decimal, prefixe, suffixe) {\n    let str = '';\n    for (let i = min; i <= max; i += increment) {\n\n        str = str + '\"' + prefixe + i.toFixed(decimal) + suffixe + '\",';\n        \n\n    }\n    //on enleve la virgule\n    str = str.slice(0, -1);\n  return str;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":620,"wires":[["6dabbcf4fa89e32f"]]},{"id":"c8870c9f0ef4e1cf","type":"function","z":"a75e6cc9dd444ba5","g":"1a4e378ad246919d","name":"ancien function parametre","func":"/*-------------------------------------------------*/\n//Param√®tre 01\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param01\");\nmsg.ha_type_topic = 'param01';\nmsg.ha_num_param = '01';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_16' \n        msg.ha_select = '\"UTI\", \"SOL\", \"SBU\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57860' \n        msg.ha_select = '\"UTI\", \"SOL\", \"SBU\"'\n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n/*-------------------------------------------------*/\n//Param√®tre 02\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param02\");\nmsg.ha_type_topic = 'param02';\nmsg.ha_num_param = '02';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_14' \n\n        // option((max, min, increment, decimal, prefixe, suffixe));\n         msg.ha_select = option(90, 10, 10, 0, '0', '') + ',\"100\",\"110\",\"120\",\"130\",\"140\",\"150\"' ;\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57866' \n\n        // option((max, min, increment, decimal, prefixe, suffixe));\n        msg.ha_select = option(80, 10, 10, 0, '', '');\n\n    }                      \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n/*-------------------------------------------------*/\n//Param√®tre 05\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param05\");\nmsg.ha_type_topic = 'param05';\nmsg.ha_num_param = '05';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_12' \n        msg.ha_select = '\"AGM\",\"Flooded\",\"User\",\"Pylon\",\"Weco\",\"Soltaro\",\"Lib\",\"Lic\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57348' \n        msg.ha_select = '\"USE\",\"SLD\",\"FLD\",\"GEL\",\"LIFEPO4X14\",\"LIFEPO4X15\",\"LIFEPO4X16\",\"LIFEPO4X7\",\"LIFEPO4X8\",\"LIFEPO4X9\",\"TERNARYIX7\",\"TERNARYIX8\",\"TERNARYIX13\",\"TERNARYIX14\"'\n\n    }\n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n\n/*-------------------------------------------------*/\n//Param√®tre 11\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param11\");\nmsg.ha_type_topic = 'param11';\nmsg.ha_num_param = '11';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_13' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '\"02\",' + option(60, 10, 10, 0, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? '\"02\",' + option(120, 10, 10, 0, '', '') :\n\t\t\t\t\t    'Erreur'; \n\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57861'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? '\"02\",' + option(60, 10, 10, 0, '', '') :\n\t\t\t\t\t    'Erreur'; \n        \n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 12\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param12\");\nmsg.ha_type_topic = 'param12';\nmsg.ha_num_param = '12';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_8' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(25.5, 22, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(51, 44, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57371'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(25.5, 25.5, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                      \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 13\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param13\");\nmsg.ha_type_topic = 'param13';\nmsg.ha_num_param = '13';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_22' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(58, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57378'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 16\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param16\");\nmsg.ha_type_topic = 'param16';\nmsg.ha_num_param = '16';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_17' \n        msg.ha_select = '\"CUE\",\"CSO\",\"SNU\",\"OSO\"'\n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57871' \n        msg.ha_select = '\"CSO\",\"CUB\",\"SNU\",\"OSO\"'\n\n    }\n    if( msg.ha_state_topic != '') {node.send(msg)}\n\n/*-------------------------------------------------*/\n//Param√®tre 26\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param26\");\nmsg.ha_type_topic = 'param26';\nmsg.ha_num_param = '26';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_10' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(32, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(64.1, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57354'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                     \n    if( msg.ha_state_topic != '') {node.send(msg)}\n\n/*-------------------------------------------------*/\n//Param√®tre 27\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param27\");\nmsg.ha_type_topic = 'param27';\nmsg.ha_num_param = '27';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_11' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(58.1, 48, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57351'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(29, 24, 0.1, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n\n    }                 \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\n/*-------------------------------------------------*/\n//Param√®tre 29\n/*-------------------------------------------------*/\nmsg.ha_name_topic = global.get(\"name.Param29\");\nmsg.ha_type_topic = 'param29';\nmsg.ha_num_param = '29';\n\n    if (msg.onduleurType == \"voltronic\"){\n\n        msg.ha_state_topic = 'qpiri_9' \n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? option(24, 21, 0.5, 1, '', '') :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(48.1, 42, 0.1, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n        \n\n    }else if (msg.onduleurType == \"easun\"){\n\n        msg.ha_state_topic = '57357'\n\n        //function option(max, min, increment, decimal, prefixe, suffixe);\n        msg.ha_select = (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 12) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 24) ? '' :\n                        (global.get(\"onduleurs.onduleur_\" + msg.numOnduleur + \".battTension\") == 48) ? option(60, 40, 0.4, 1, '', '') :\n\t\t\t\t\t    'Erreur';\n       \n\n    }                   \n    if (msg.ha_state_topic != '') { node.send(msg) }\n\n\nif (global.get('onduleurs.onduleur_' + msg.numOnduleur + '.qled') != 'NAK'){\n    /*-------------------------------------------------*/\n    //Param√®tre 92 Luminosit√© Led\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Luminosit√© des LEDs\";\n    msg.ha_type_topic = 'param92';\n    msg.ha_num_param = '92';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qled_3' \n            msg.ha_select = '\"Faible\", \"Moyen\", \"Haut\"'\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            msg.ha_select = '\"Faible\", \"Moyen\", \"Haut\"'\n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 93 Vitesse Led\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Vitesse des LEDs\";\n    msg.ha_type_topic = 'param93';\n    msg.ha_num_param = '93';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qled_1' \n            msg.ha_select = '\"Faible\", \"Moyen\", \"Rapide\"'\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            msg.ha_select = '\"Faible\", \"Moyen\", \"Rapide\"'\n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 94 Effet Led\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Effet des LEDs\";\n    msg.ha_type_topic = 'param94';\n    msg.ha_num_param = '94';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qled_2' \n            msg.ha_select = '\"Circulaire\", \"Roue\", \"Chasing\", \"Fixe\"'\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            msg.ha_select = '\"Circulaire\", \"Roue\", \"Chasing\", \"Fixe\"'\n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 95 Effet Led\n    /*-------------------------------------------------*/\n    msg.ha_name_topic = \"Donn√©es des LEDs\";\n    msg.ha_type_topic = 'param95';\n    msg.ha_num_param = '95';\n\n        if (msg.onduleurType == \"voltronic\"){\n\n            msg.ha_state_topic = 'qled_4' \n            msg.ha_select = '\"Puissance PV\", \"SoC Batterie\", \"Pourcentage de charge\", \"Source\", \"Charge Decharge\"'\n\n        }else if (msg.onduleurType == \"easun\"){\n\n            msg.ha_state_topic = '' \n            msg.ha_select = '\"Puissance PV\", \"SoC Batterie\", \"Pourcentage de charge\", \"Source\", \"Charge Decharge\"'\n\n        }                 \n        if (msg.ha_state_topic != '') { node.send(msg) }\n}\n\n/*-------------------------------------------------*/\n//fonction calcul incr√©mentation\n/*-------------------------------------------------*/\nfunction option(max, min, increment, decimal, prefixe, suffixe) {\n    let str = '';\n    for (let i = min; i <= max; i += increment) {\n\n        str = str + '\"' + prefixe + i.toFixed(decimal) + suffixe + '\",';\n        \n\n    }\n    //on enleve la virgule\n    str = str.slice(0, -1);\n  return str;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":620,"wires":[[]]},{"id":"2963aa6a856673ee","type":"function","z":"a75e6cc9dd444ba5","g":"3bbb09fd75d4dac2","name":"√ânergies PV et Load","func":"/*-------------------------------------------------*/\n// √âNERGIES PV ET LOAD - MQTT Discovery Auto (kWh)\n/*-------------------------------------------------*/\n\nmsg.ha_device_class = '\"device_class\": \"energy\",';\nmsg.ha_unit_of_measurement = '\"unit_of_measurement\": \"kWh\",';\nmsg.ha_nom_unit = 'kwh';\n\n/*-------------------------------------------------*/\n// PV Production Jour (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"PV Production Jour\";\nmsg.ha_type_topic = 'energie_pv_jour';\nmsg.ha_icon = '\"icon\": \"mdi:solar-power\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_pv_jour' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// PV Production Mois (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"PV Production Mois\";\nmsg.ha_type_topic = 'energie_pv_mois';\nmsg.ha_icon = '\"icon\": \"mdi:solar-power\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_pv_mois' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// PV Production Ann√©e (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"PV Production Ann√©e\";\nmsg.ha_type_topic = 'energie_pv_annee';\nmsg.ha_icon = '\"icon\": \"mdi:solar-power\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_pv_annee' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// PV Production Totale (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"PV Production Totale\";\nmsg.ha_type_topic = 'energie_pv_total';\nmsg.ha_icon = '\"icon\": \"mdi:solar-power-variant\",';\nmsg.ha_state_class = '\"state_class\": \"total_increasing\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_pv_total' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// Load Consommation Jour (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"Load Consommation Jour\";\nmsg.ha_type_topic = 'energie_load_jour';\nmsg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_load_jour' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// Load Consommation Mois (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"Load Consommation Mois\";\nmsg.ha_type_topic = 'energie_load_mois';\nmsg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_load_mois' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// Load Consommation Ann√©e (kWh)\n/*-------------------------------------------------*/\n// ‚ö†Ô∏è NOTE: Cette commande peut retourner NAK sur certains onduleurs\n// Le capteur sera cr√©√© mais pourrait rester sans valeur si NAK\nmsg.ha_name_topic = \"Load Consommation Ann√©e\";\nmsg.ha_type_topic = 'energie_load_annee';\nmsg.ha_icon = '\"icon\": \"mdi:home-lightning-bolt\",';\nmsg.ha_state_class = '\"state_class\": \"total\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_load_annee' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}\n\n/*-------------------------------------------------*/\n// Load Consommation Totale (kWh)\n/*-------------------------------------------------*/\nmsg.ha_name_topic = \"Load Consommation Totale\";\nmsg.ha_type_topic = 'energie_load_total';\nmsg.ha_icon = '\"icon\": \"mdi:transmission-tower\",';\nmsg.ha_state_class = '\"state_class\": \"total_increasing\",';\n\nmsg.ha_state_topic = (msg.onduleurType == \"voltronic\") ? 'energie_load_total' :\n                      'Erreur';\n\nif (msg.ha_state_topic != 'Erreur'){node.send(msg)}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":320,"wires":[["d01723e538d41be2"]]},{"id":"e1e94763050c5990","type":"serial request","z":"23fac679e003f079","g":"20319798fb911621","name":"","serial":"3f128fc7b3eaf075","x":670,"y":400,"wires":[["53b2b762901c8fbe","f4d4e1d53c2686eb"]]},{"id":"53b2b762901c8fbe","type":"debug","z":"23fac679e003f079","g":"20319798fb911621","name":"onduleur","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":900,"y":420,"wires":[]},{"id":"ba7280d2d277b1ad","type":"link in","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"Parsing-response-in","links":["f4d4e1d53c2686eb","dc48ab8181332f18","ad531d1dc075be41","9c2fbc7c91220f5a"],"x":75,"y":780,"wires":[["51cd001b037a10fa"]]},{"id":"f4d4e1d53c2686eb","type":"link out","z":"23fac679e003f079","g":"20319798fb911621","name":"Parsing-response-ou","mode":"link","links":["ba7280d2d277b1ad"],"x":1085,"y":400,"wires":[]},{"id":"aee9639d9e60f5e8","type":"function","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"Tri Q...","func":"/* PARSER TRI Q... MODIFI√â - AVEC SUPPORT √âNERGIES + kWh (1 d√©cimale) */\n\nif (msg.topic == \"command\") {\n   msg.type = msg.topic;\n  msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/command';\n  node.send(msg);\n\n  \n} else if(msg.topic == \"qmchgcr\"){\n  // Nettoyage et cr√©ation du tableau\n    msg.payload = msg.payload.slice(1, -3);\n    msg.payload = msg.payload.trim().split(/\\s+/);\n\n    // Stocker dans le contexte global\n    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + \".param11\", msg.payload);\n\n/* ==================== NOUVEAU: PARSER √âNERGIES (EN kWh) ==================== */\n\n} else if (msg.topic == \"qed\" || msg.topic == \"qem\" || msg.topic == \"qey\" || msg.topic == \"qet\" ||\n           msg.topic == \"qld\" || msg.topic == \"qlm\" || msg.topic == \"qly\" || msg.topic == \"qlt\") {\n    \n    // Parser les r√©ponses d'√©nergies\n    // Format: (NNNNNNNN<CRC><cr>\n    \n    // Extraire la valeur (8 chiffres)\n    let response = msg.payload.toString('utf8');\n    let match = response.match(/\\(([0-9]{1,8})/);\n    \n    if (match && match[1]) {\n        let energieWh = parseInt(match[1]);\n        \n        // Conversion en kWh avec 1 d√©cimale\n        let energieKwh = (energieWh / 1000).toFixed(1);\n        \n        // Mapper les topics aux noms lisibles\n        let energieMap = {\n            'qed': 'energie_pv_jour',\n            'qem': 'energie_pv_mois',\n            'qey': 'energie_pv_annee',\n            'qet': 'energie_pv_total',\n            'qld': 'energie_load_jour',\n            'qlm': 'energie_load_mois',\n            'qly': 'energie_load_annee',\n            'qlt': 'energie_load_total'\n        };\n        \n        let energieName = energieMap[msg.topic] || msg.topic;\n        \n        // Stocker dans le contexte global (en kWh)\n        global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + \".\" + energieName, parseFloat(energieKwh));\n        \n        // Pr√©parer pour MQTT\n        msg.payload = parseFloat(energieKwh); // kWh avec 1 d√©cimale\n        msg.type = msg.topic;\n        msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + \n                    global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + \n                    msg.voltronicNum + '/' + energieName;\n        \n        node.status({\n            fill: \"green\",\n            shape: \"dot\",\n            text: energieName + \": \" + energieKwh + \" kWh\"\n        });\n        \n        node.send(msg);\n    } else {\n        node.warn(\"R√©ponse √©nergie invalide: \" + response);\n    }\n\n/* ==================== FIN PARSER √âNERGIES ==================== */\n\n} else if ( msg.payload != \"ACK\"){\n  msg.payload = msg.payload.slice(1, -3);\n  msg.payload = msg.payload.split(' ');\n  \n  // Si NAK on l'enregistre variable flow\n  if (msg.payload == \"NAK\"){\n\n    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + \".\" + msg.topic, \"NAK\");\n\n  }\n\n    // msg.payload.length\n    //Nomage pr√©fix\n    var name = msg.topic + '_';\n    msg.type = msg.topic;\n    var payload = msg.payload\n    var count = msg.payload.length\n\n    for (let i = 0; i <= count; i++) {\n      \n      msg.payload = payload[i];\n      \n      //v√©rification si c'est le qpig_24 (consomation r√©seaux)\n      if ( name + i == \"qpig_24\"){\n\n\n          msg.payload = parseFloat( msg.payload);// transformation valeur string en number\n\n          if (msg.payload <= 35000){\n            //si en dessous de 35000 on laisse passer la valeur \n            msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i;\n            node.send(msg);\n            \n          }\n\n      }else{\n\n        msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i;\n        node.send(msg);\n\n      }\n      \n    \n\n  }\n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":820,"wires":[["0f8ef052cd286465"]]},{"id":"cc8cf2352fce7583","type":"function","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"Calcul","func":"msg.payload = msg.payload.slice(1, -3);\nmsg.payload = msg.payload.split(' ');\nlet name = 'custom_'; //pr√©fix custom\n\nif (msg.topic == \"qpig\") {\n\n    //num√©ro du calcul\n    let tab = [\"1_battChargeWatt\", \"2_battDechargeWatt\", \"3_battChargeDechargeWatt\"]\n\n\n    let payload = msg.payload\n    let count = tab.length //compte le nombre du tableau \n\n\n    for (let i = 1; i <= count; i++) {\n\n        /*-------------------------------------------------*/\n        //1 Batterie charge en watt\n        /*-------------------------------------------------*/\n        if (i == 1) {\n\n            //calcul\n            let charge = payload[9] * payload[8];\n            msg.payload = charge.toFixed(2);\n        }\n\n        /*-------------------------------------------------*/\n        //2 Batterie Decharge en watt\n        /*-------------------------------------------------*/\n        if (i == 2) {\n\n            //calcul\n            let decharge = payload[15] * payload[8];\n            msg.payload = decharge.toFixed(2);\n        }\n\n        //nouveau Parametre pour mqtt en custom\n        msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i;\n        node.send(msg);\n\n        /*-------------------------------------------------*/\n        //3 Batterie charge positive, Decharge n√©gative en watt\n        /*-------------------------------------------------*/\n        if (i == 3) {\n\n            let charge = payload[9] * payload[8];\n            let decharge = payload[15] * payload[8];\n            \n            if (charge >= 0 && decharge == 0) {\n\n                msg.payload = charge.toFixed(2);\n                \n            }else if (charge == 0 && decharge >= 0){\n\n                decharge = -decharge;\n                msg.payload = decharge.toFixed(2);\n\n            }else{\n\n                msg.payload = 0;\n\n            }\n\n        }\n        //nouveau Parametre pour mqtt en custom\n        msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i;\n        node.send(msg);\n    }\n\n\n\n   \n\n/*qpgsn*/\n}else{\n\n    \n    for (let i = 2; i <= 8; i++) {\n            let topic = \"qpgs\" + i;\n            if (global.get( '' + topic + '' ) != 'false' && msg.topic == topic){\n                \n                let payload = msg.payload\n                \n                /*-------------------------------------------------*/\n                //1 Batterie charge en watt qpgs\n                /*-------------------------------------------------*/\n\n                let charge = payload[11] * payload[12];\n                msg.payload = charge.toFixed(2);\n\n                msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i + '01';\n                node.send(msg);\n\n\n\n                /*-------------------------------------------------*/\n                //2 Batterie Decharge en watt qpgs\n                /*-------------------------------------------------*/\n                charge = payload[11] * payload[26];\n                msg.payload = charge.toFixed(2);\n\n                msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i + '02';\n                node.send(msg);\n\n\n\n                /*-------------------------------------------------*/\n                //3 Batterie charge positive, Decharge n√©gative en watt qpgs\n                /*-------------------------------------------------*/\n\n                charge = payload[11] * payload[12];\n                let decharge = payload[11] * payload[26];;\n\n                if (charge >= 0 && decharge == 0) {\n\n                    msg.payload = charge.toFixed(2);\n\n                } else if (charge == 0 && decharge >= 0) {\n\n                    decharge = -decharge;\n                    msg.payload = decharge.toFixed(2);\n\n                } else {\n\n                    msg.payload = 0;\n\n                }\n\n                msg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/' + name + i + '03';\n                node.send(msg);\n\n                \n\n            }\n    }\n\n\n}\n\nmsg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/config/onduleur' + msg.voltronicNum + '_status';\nmsg.payload = msg.status;\nnode.send(msg);","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":780,"wires":[["1f82fe719a9f5c56"]]},{"id":"1f82fe719a9f5c56","type":"link out","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"link out 12","mode":"link","links":["5473c4b21f7c5529"],"x":1085,"y":780,"wires":[]},{"id":"74b9f6c0a52fa743","type":"mqtt in","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"mqtt in dynamique","topic":"","qos":"2","datatype":"auto-detect","broker":"7eb926b832168904","nl":false,"rap":true,"rh":0,"inputs":1,"x":510,"y":1000,"wires":[["2c30668d470b346d"]]},{"id":"d890192e3f53421b","type":"function","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"function 30","func":"msg.action = \"subscribe\";\nmsg.topic = global.get(\"parametre.mqtt.DirSmart\") + '/Modification-voltronic/#';\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":1000,"wires":[["74b9f6c0a52fa743","3b47f0fb176cb423"]]},{"id":"823de09da16f4b38","type":"inject","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":150,"y":1000,"wires":[["d890192e3f53421b"]]},{"id":"1b601085884ce90b","type":"link out","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"link out 2","mode":"link","links":["40a3c6d2dc446b56"],"x":1085,"y":1000,"wires":[]},{"id":"03d1b46d68726112","type":"function","z":"23fac679e003f079","g":"8328309f0d2809d0","name":"function 43","func":"setTimeout(function () {\n    msg.topic = \"QSID\";\n    msg.payload = new Buffer([81, 83, 73, 68, 187, 5, 13]);\n    node.send(msg);\n}, 20000);\n\nsetTimeout(function () {\n    msg.topic = \"QID\";\n    msg.payload = new Buffer([81, 73, 68, 214, 234, 13]);\n    node.send(msg);\n}, 21000);\n\nsetTimeout(function () {\n    msg.topic = \"QVFW\";\n    msg.payload = new Buffer([81, 86, 70, 87, 98, 153, 13]);\n    node.send(msg);\n}, 22000);\n\nsetTimeout(function () {\n    msg.topic = \"QMN\";\n    msg.payload = new Buffer([81, 77, 78, 187, 100, 13]);\n    node.send(msg);\n}, 23000);\n\nif (global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".full\") === true) {\n    setTimeout(function () {\n        msg.topic = \"qpigs2\";\n        msg.payload = new Buffer([81, 80, 73, 71, 83, 50, 104, 45, 13]);\n        node.send(msg);\n    }, 100);\n}\n\n/* ==================== FONCTION CRC (√† placer AVANT les setTimeout) ==================== */\n\nfunction createMessage(command) {\n    // Fonction CRC16 XModem\n    function crc16(str, crc = 0, xorout = 0) {\n        for (let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n            t = (crc >> 8) ^ str.charCodeAt(i);\n            t ^= t >> 4;\n            crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n        }\n        return crc ^ xorout;\n    }\n\n    // Encode la commande en HEX et ajoute le CRC\n    let commandHex = Buffer.from(command).toString('hex');\n    let crcHex = crc16(command).toString(16).padStart(4, '0');\n    let messageHex = commandHex + crcHex + \"0D\";\n    return Buffer.from(messageHex, \"hex\");\n}\n\n/* ==================== √âNERGIES PV (Mois, Ann√©e, Total) ==================== */\n\n// ‚ö†Ô∏è IMPORTANT: Capturer msg pour les setTimeout\nconst msgCapture = msg;\nconst voltronicNum = msg.voltronicNum;\n\n// QEM - √ânergie PV du mois\nsetTimeout(function () {\n    const now = new Date();\n    const year = now.getFullYear().toString();\n    const month = (now.getMonth() + 1).toString().padStart(2, '0');\n    const dateStr = year + month;\n\n    const newMsg = {\n        topic: \"qem\",\n        payload: createMessage(\"QEM\" + dateStr),\n        energieDate: dateStr,\n        voltronicNum: voltronicNum\n    };\n    node.send(newMsg);\n}, 24000);\n\n// QEY - √ânergie PV de l'ann√©e\nsetTimeout(function () {\n    const year = new Date().getFullYear().toString();\n\n    const newMsg = {\n        topic: \"qey\",\n        payload: createMessage(\"QEY\" + year),\n        energieDate: year,\n        voltronicNum: voltronicNum\n    };\n    node.send(newMsg);\n}, 25000);\n\n// QET - √ânergie PV totale\nsetTimeout(function () {\n    const newMsg = {\n        topic: \"qet\",\n        payload: createMessage(\"QET\"),\n        voltronicNum: voltronicNum\n    };\n    node.send(newMsg);\n}, 26000);\n\n/* ==================== √âNERGIES LOAD (Mois, Ann√©e, Total) ==================== */\n\n// QLM - √ânergie Load du mois\nsetTimeout(function () {\n    const now = new Date();\n    const year = now.getFullYear().toString();\n    const month = (now.getMonth() + 1).toString().padStart(2, '0');\n    const dateStr = year + month;\n\n    const newMsg = {\n        topic: \"qlm\",\n        payload: createMessage(\"QLM\" + dateStr),\n        energieDate: dateStr,\n        voltronicNum: voltronicNum\n    };\n    node.send(newMsg);\n}, 27000);\n\n// QLY - √ânergie Load de l'ann√©e (avec gestion NAK)\nif (global.get('onduleurs.onduleur_' + voltronicNum + '.qly') !== \"NAK\") {\n    setTimeout(function () {\n        const year = new Date().getFullYear().toString();\n\n        const newMsg = {\n            topic: \"qly\",\n            payload: createMessage(\"QLY\" + year),\n            energieDate: year,\n            voltronicNum: voltronicNum\n        };\n        node.send(newMsg);\n    }, 28000);\n}\n\n// QLT - √ânergie Load totale\nsetTimeout(function () {\n    const newMsg = {\n        topic: \"qlt\",\n        payload: createMessage(\"QLT\"),\n        voltronicNum: voltronicNum\n    };\n    node.send(newMsg);\n}, 29000);\n\n/* ==================== MULTI-ONDULEURS (QPGS) ==================== */\n\nif (global.get('onduleurs.onduleur_' + voltronicNum + '.qpgs') != false) {\n    let seconde = 30000; // Commence apr√®s les √©nergies\n    for (let i = 1; i <= 8; i++) {\n        (function (index) {\n            setTimeout(function () {\n                const newMsg = {\n                    topic: \"qpgs\" + index,\n                    payload: (index == 1 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_1\") != false) ? new Buffer([81, 80, 71, 83, 49, 47, 251, 13]) :\n                        (index == 2 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_2\") != false) ? new Buffer([81, 80, 71, 83, 50, 31, 152, 13]) :\n                            (index == 3 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_3\") != false) ? new Buffer([81, 80, 71, 83, 51, 15, 185, 13]) :\n                                (index == 4 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_4\") != false) ? new Buffer([81, 80, 71, 83, 52, 127, 94, 13]) :\n                                    (index == 5 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_5\") != false) ? new Buffer([81, 80, 71, 83, 53, 111, 127, 13]) :\n                                        (index == 6 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_6\") != false) ? new Buffer([81, 80, 71, 83, 54, 95, 28, 13]) :\n                                            (index == 7 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_7\") != false) ? new Buffer([81, 80, 71, 83, 55, 79, 61, 13]) :\n                                                (index == 8 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_8\") != false) ? new Buffer([81, 80, 71, 83, 56, 190, 210, 13]) :\n                                                    (index == 9 && global.get(\"onduleurs.onduleur_\" + voltronicNum + \".qpgs_9\") != false) ? new Buffer([81, 80, 71, 83, 57, 174, 243, 13]) :\n                                                        'Erreur',\n                    voltronicNum: voltronicNum\n                };\n                node.send(newMsg);\n            }, seconde + index * 1200);\n        })(i);\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":40,"wires":[["963af7f967767a27"]]},{"id":"ea3cb00df028aa79","type":"inject","z":"23fac679e003f079","g":"8328309f0d2809d0","name":"start","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"43200","crontab":"","once":true,"onceDelay":"3","topic":"","payload":"","payloadType":"date","x":130,"y":40,"wires":[["755d8ce91f40ed9d"]]},{"id":"963af7f967767a27","type":"link out","z":"23fac679e003f079","g":"8328309f0d2809d0","name":"To-serial-ou","mode":"link","links":["40a3c6d2dc446b56"],"x":515,"y":40,"wires":[]},{"id":"f73f8d60181cb3ab","type":"serial request","z":"23fac679e003f079","g":"20319798fb911621","name":"","serial":"8f8f04570bb20a6b","x":670,"y":460,"wires":[["6968828185f8ede8","dc48ab8181332f18"]]},{"id":"6968828185f8ede8","type":"debug","z":"23fac679e003f079","g":"20319798fb911621","name":"onduleur","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":900,"y":480,"wires":[]},{"id":"dc48ab8181332f18","type":"link out","z":"23fac679e003f079","g":"20319798fb911621","name":"Parsing-response-ou","mode":"link","links":["ba7280d2d277b1ad"],"x":1085,"y":460,"wires":[]},{"id":"a136e3043da3957f","type":"serial request","z":"23fac679e003f079","g":"20319798fb911621","name":"","serial":"e9cc506ca82e0dcd","x":670,"y":520,"wires":[["ae23efe98dbf4861","ad531d1dc075be41"]]},{"id":"ae23efe98dbf4861","type":"debug","z":"23fac679e003f079","g":"20319798fb911621","name":"onduleur","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":900,"y":540,"wires":[]},{"id":"ad531d1dc075be41","type":"link out","z":"23fac679e003f079","g":"20319798fb911621","name":"Parsing-response-ou","mode":"link","links":["ba7280d2d277b1ad"],"x":1085,"y":520,"wires":[]},{"id":"27a565eacdb5c7fa","type":"serial request","z":"23fac679e003f079","g":"20319798fb911621","name":"","serial":"7e4f5bc8b4fd8bf3","x":670,"y":580,"wires":[["cf58391695c08e47","9c2fbc7c91220f5a"]]},{"id":"cf58391695c08e47","type":"debug","z":"23fac679e003f079","g":"20319798fb911621","name":"onduleur","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":900,"y":600,"wires":[]},{"id":"9c2fbc7c91220f5a","type":"link out","z":"23fac679e003f079","g":"20319798fb911621","name":"Parsing-response-ou","mode":"link","links":["ba7280d2d277b1ad"],"x":1085,"y":580,"wires":[]},{"id":"755d8ce91f40ed9d","type":"function","z":"23fac679e003f079","g":"8328309f0d2809d0","name":"true","func":"\n    // nombre d'entr√©e onduleur\n    let count = global.get(\"countUSBOnduleur\")\n    for (let i = 1; i <= count; i++) {\n        \n        //v√©rification si l'onduleur est voltronic\n        if (global.get(\"onduleurs.onduleur_\" + i + \".type\") == 'voltronic' ){\n\n            msg.voltronicNum = i;\n            node.send(msg);\n\n        }\n\n    }\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":40,"wires":[["03d1b46d68726112"]]},{"id":"b01cec38f67be502","type":"function","z":"23fac679e003f079","name":"function 66","func":"if (global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'ip') {\n\n    let chemin = global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".chemin\").split(\":\");\n    msg.host = chemin[0];\n    msg.port = chemin[1];\n    \n    node.send([msg, , , ,]);\n\n}\n\nif (msg.voltronicNum == 1 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial') {\n\n    node.send([, msg, , ,]);\n\n}\n\nif (msg.voltronicNum == 2 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial'){\n\n    node.send([,,msg,,]);\n\n}\n\nif (msg.voltronicNum == 3 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial'){\n\n    node.send([,,,msg,]);       \n          \n}\n\nif (msg.voltronicNum == 4 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".ComType\") == 'serial') {\n\n    node.send([,,,,msg]);\n          \n}","outputs":5,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":460,"wires":[[],["d38feb3754bfe16a"],["014f259b95c7699f"],["6eaf61501f158c84"],["8710a130a740b04a"]]},{"id":"4a430c5f47a7c3b0","type":"function","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"Remplace mqtt => onduleur","func":"// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\n\n/********************* si ip *********************/\nfor (let i = 1; i <= count; i++) {\n\n    let dir = global.get(\"parametre.mqtt.DirSmart\") + '/Modification-voltronic/' + i + '/Param';\n    let payload = '';\n\n\n    /*-------------------------------------------------*/\n    //parametre 01\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '01') {\n\n        msg.voltronicNum = i;\n\n        //option remplace\n        msg.payload = (msg.payload == \"UTI\") ? new Buffer([80,79,80,48,48,194,72,13]) :\n                  (msg.payload == \"SOL\") ? new Buffer([80,79,80,48,49,210,105,13]) :\n                  (msg.payload == \"SBU\") ? new Buffer([80,79,80,48,50,226,11,13]) :\n                  'Erreur';\n\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 02\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '02') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"010\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,49,48,77,185,13]) :\n                (msg.payload == \"020\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,50,48,24,234,13]) :\n                (msg.payload == \"030\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,51,48,43,219,13]) :\n                (msg.payload == \"040\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,52,48,178,76,13]) :\n                (msg.payload == \"050\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,53,48,129,125,13]) :\n                (msg.payload == \"060\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,54,48,212,46,13]) :\n                (msg.payload == \"070\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,55,48,231,31,13]) :\n                (msg.payload == \"080\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,78,67,72,71,67,48,56,48,247,33,13]) :\n                (msg.payload == \"010\") ? new Buffer([77,78,67,72,71,67,48,48,49,48,18,59,13]) :\n                (msg.payload == \"020\") ? new Buffer([77,78,67,72,71,67,48,48,50,48,71,104,13]) :\n                (msg.payload == \"030\") ? new Buffer([77,78,67,72,71,67,48,48,51,48,116,89,13]) :\n                (msg.payload == \"040\") ? new Buffer([77,78,67,72,71,67,48,48,52,48,237,206,13]) :\n                (msg.payload == \"050\") ? new Buffer([77,78,67,72,71,67,48,48,53,48,222,255,13]) :\n                (msg.payload == \"060\") ? new Buffer([77,78,67,72,71,67,48,48,54,48,139,172,13]) :\n                (msg.payload == \"070\") ? new Buffer([77,78,67,72,71,67,48,48,55,48,184,157,13]) :\n                (msg.payload == \"080\") ? new Buffer([77,78,67,72,71,67,48,48,56,48,168,163,13]) :\n                (msg.payload == \"090\") ? new Buffer([77,78,67,72,71,67,48,48,57,48,155,146,13]) :\n                (msg.payload == \"100\") ? new Buffer([77,78,67,72,71,67,48,49,48,48,22,58,13]) :\n                (msg.payload == \"110\") ? new Buffer([77,78,67,72,71,67,48,49,49,48,37,11,13]) :\n                (msg.payload == \"120\") ? new Buffer([77,78,67,72,71,67,48,49,50,48,112,88,13]) :\n                (msg.payload == \"130\") ? new Buffer([77,78,67,72,71,67,48,48,49,51,48,106,115,13]) :\n                                'Erreur';\n\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 05\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '05') {\n    \n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"AGn\") ? new Buffer([80,66,84,48,48,39,14,13]) :\n                (msg.payload == \"FLd\") ? new Buffer([80,66,84,48,49,55,47,13]) :\n                (msg.payload == \"USE\") ? new Buffer([80,66,84,48,50,7,76,13]) :\n                (msg.payload == \"PYL\") ? new Buffer([80,66,84,48,51,23,109,13]) :\n                (msg.payload == \"uEC\") ? new Buffer([80,66,84,48,52,103,138,13]) :\n                (msg.payload == \"SOL\") ? new Buffer([80,66,84,48,53,119,171,13]) :\n                (msg.payload == \"LIb\") ? new Buffer([80,66,84,48,54,71,200,13]) :\n                (msg.payload == \"LIc\") ? new Buffer([80,66,84,48,55,87,233,13]) :\n                'Erreur';\n\n    }\n\n\n    /*-------------------------------------------------*/\n    //parametre 11\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '11') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"02\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,85,67,72,71,67,48,48,50,181,209,13]) :\n                (msg.payload == \"10\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,85,67,72,71,67,48,49,48,166,162,13]) :\n                (msg.payload == \"20\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,85,67,72,71,67,48,50,48,243,241,13]) :\n                (msg.payload == \"30\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,85,67,72,71,67,48,51,48,192,192,13]) :\n                (msg.payload == \"50\" && global.get(i + \"qpgs1\") == false) ? new Buffer([77,85,67,72,71,67,48,53,48,106,102,13]) :\n                (msg.payload == \"02\" ) ? new Buffer([77,85,67,72,71,67,48,48,48,50,86,13,13]) :\n                (msg.payload == \"10\" ) ? new Buffer([77,85,67,72,71,67,48,48,49,48,69,126,13]) :\n                (msg.payload == \"20\" ) ? new Buffer([77,85,67,72,71,67,48,48,50,48,16,45,13]) :\n                (msg.payload == \"30\" ) ? new Buffer([77,85,67,72,71,67,48,48,51,48,35,28,13]) :\n                (msg.payload == \"40\" ) ? new Buffer([77,85,67,72,71,67,48,48,52,48,186,139,13]) :\n                (msg.payload == \"50\" ) ? new Buffer([77,85,67,72,71,67,48,48,53,48,137,186,13]) :\n                (msg.payload == \"60\" ) ? new Buffer([77,85,67,72,71,67,48,48,54,48,220,233,13]) :\n                (msg.payload == \"70\" ) ? new Buffer([77,85,67,72,71,67,48,48,55,48,239,216,13]) :\n                (msg.payload == \"80\" ) ? new Buffer([77,85,67,72,71,67,48,48,56,48,255,230,13]) :\n                (msg.payload == \"90\" ) ? new Buffer([77,85,67,72,71,67,48,48,57,48,204,215,13]) :\n                (msg.payload == \"100\" ) ? new Buffer([77,85,67,72,71,67,48,49,48,48,65,127,13]) :\n                (msg.payload == \"110\" ) ? new Buffer([77,85,67,72,71,67,48,49,49,48,114,78,13]) :\n                (msg.payload == \"120\" ) ? new Buffer([77,85,67,72,71,67,48,49,50,48,39,29,13]) :\n                'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 12\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '12') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"22.0\") ? new Buffer([80,66,67,86,50,50,46,48,115,210,13]) :\n                (msg.payload == \"22.5\") ? new Buffer([80,66,67,86,50,50,46,53,35,119,13]) :\n                (msg.payload == \"23.0\") ? new Buffer([80,66,67,86,50,51,46,48,68,226,13]) :\n                (msg.payload == \"23.5\") ? new Buffer([80,66,67,86,50,51,46,53,20,71,13]) :\n                (msg.payload == \"24.0\") ? new Buffer([80,66,67,86,50,52,46,48,193,114,13]) :\n                (msg.payload == \"24.5\") ? new Buffer([80,66,67,86,50,52,46,53,145,215,13]) :\n                (msg.payload == \"25.0\") ? new Buffer([80,66,67,86,50,53,46,48,246,66,13]) :\n                (msg.payload == \"25.5\") ? new Buffer([80,66,67,86,50,53,46,53,166,231,13]) :\n                (msg.payload == \"44.0\") ? new Buffer([80,66,67,86,52,52,46,48,230,235,13]) :\n                (msg.payload == \"45.0\") ? new Buffer([80,66,67,86,52,53,46,48,209,219,13]) :\n                (msg.payload == \"46.0\") ? new Buffer([80,66,67,86,52,54,46,48,136,139,13]) :\n                (msg.payload == \"47.0\") ? new Buffer([80,66,67,86,52,55,46,48,191,187,13]) :\n                (msg.payload == \"48.0\") ? new Buffer([80,66,67,86,52,56,46,48,147,138,13]) :\n                (msg.payload == \"49.0\") ? new Buffer([80,66,67,86,52,57,46,48,164,186,13]) :\n                (msg.payload == \"50.0\") ? new Buffer([80,66,67,86,53,48,46,48,76,159,13]) :\n                (msg.payload == \"51.0\") ? new Buffer([80,66,67,86,53,49,46,48,123,175,13]) :\n                msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 13\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '13') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"24.0\") ? new Buffer([80,66,68,86,50,52,46,48,147,48]) :\n                (msg.payload == \"24.5\") ? new Buffer([80,66,68,86,50,52,46,53,89,150,13]) :\n                (msg.payload == \"25.0\") ? new Buffer([80,66,68,86,50,53,46,48,62,3,13]) :\n                (msg.payload == \"25.5\") ? new Buffer([80,66,68,86,50,53,46,53,110,166,13]) :\n                (msg.payload == \"26.0\") ? new Buffer([80,66,68,86,50,54,46,48,103,83,13]) :\n                (msg.payload == \"26.5\") ? new Buffer([80,66,68,86,50,54,46,53,55,246,13]) :\n                (msg.payload == \"27.0\") ? new Buffer([80,66,68,86,50,55,46,48,80,99,13]) :\n                (msg.payload == \"27.5\") ? new Buffer([80,66,68,86,50,55,46,53,198,13]) :\n                (msg.payload == \"28.0\") ? new Buffer([80,66,68,86,50,56,46,48,124,82,13]) :\n                (msg.payload == \"28.5\") ? new Buffer([80,66,68,86,50,56,46,53,44,247,13]) :\n                (msg.payload == \"29.0\") ? new Buffer([80,66,68,86,50,57,46,48,75,98,13]) :\n                (msg.payload == \"48.0\") ? new Buffer([80,66,68,86,52,56,46,48,91,203,13]) :\n                (msg.payload == \"49.0\") ? new Buffer([80,66,68,86,52,57,46,48,108,251,13]) :\n                (msg.payload == \"50.0\") ? new Buffer([80,66,68,86,53,48,46,48,132,222,13]) :\n                (msg.payload == \"51.0\") ? new Buffer([80,66,68,86,53,49,46,48,179,238,13]) :\n                (msg.payload == \"52.0\") ? new Buffer([80,66,68,86,53,50,46,48,234,190,13]) :\n                (msg.payload == \"53.0\") ? new Buffer([80,66,68,86,53,51,46,48,221,142,13]) :\n                (msg.payload == \"54.0\") ? new Buffer([80,66,68,86,53,52,46,48,88,30,13]) :\n                (msg.payload == \"55.0\") ? new Buffer([80,66,68,86,53,53,46,48,111,46,13]) :\n                (msg.payload == \"56.0\") ? new Buffer([80,66,68,86,53,54,46,48,54,126,13]) :\n                (msg.payload == \"57.0\") ? new Buffer([80,66,68,86,53,55,46,48,20,224]) :\n                (msg.payload == \"58.0\") ? new Buffer([80,66,68,86,53,56,46,48,45,127,13]) :\n                msg.payload;\n    }\n\n\n    /*-------------------------------------------------*/\n    //parametre 16\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '16') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"CUE\") ? new Buffer([80,67,80,48,48,141,122,13]) :\n                (msg.payload == \"CSO\") ? new Buffer([80,67,80,48,49,157,91,13]) :\n                (msg.payload == \"SNU\") ? new Buffer([80,67,80,48,50,173,56,13]) :\n                (msg.payload == \"OSO\") ? new Buffer([80,67,80,48,51,189,25,13]) :\n                msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 26\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '26') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"24.0\") ? new Buffer([80,67,86,86,50,52,46,48,32,150,13]) :\n                    (msg.payload == \"24.1\") ? new Buffer([80,67,86,86,50,52,46,49,48,183,13]) :\n                    (msg.payload == \"24.2\") ? new Buffer([80,67,86,86,50,52,46,50,212,13]) :\n                    (msg.payload == \"24.3\") ? new Buffer([80,67,86,86,50,52,46,51,16,245,13]) :\n                    (msg.payload == \"24.4\") ? new Buffer([80,67,86,86,50,52,46,52,96,18,13]) :\n                    (msg.payload == \"24.5\") ? new Buffer([80,67,86,86,50,52,46,53,112,51,13]) :\n                    (msg.payload == \"24.6\") ? new Buffer([80,67,86,86,50,52,46,54,64,80,13]) :\n                    (msg.payload == \"24.7\") ? new Buffer([80,67,86,86,50,52,46,55,80,113,13]) :\n                    (msg.payload == \"24.8\") ? new Buffer([80,67,86,86,50,52,46,56,161,158,13]) :\n                    (msg.payload == \"24.9\") ? new Buffer([80,67,86,86,50,52,46,57,177,191,13]) :\n                    (msg.payload == \"25.0\") ? new Buffer([80,67,86,86,50,53,46,48,23,166,13]) :\n                    (msg.payload == \"25.1\") ? new Buffer([80,67,86,86,50,53,46,49,120,112]) :\n                    (msg.payload == \"25.2\") ? new Buffer([80,67,86,86,50,53,46,50,55,228,13]) :\n                    (msg.payload == \"25.3\") ? new Buffer([80,67,86,86,50,53,46,51,39,197,13]) :\n                    (msg.payload == \"25.4\") ? new Buffer([80,67,86,86,50,53,46,52,87,34,13]) :\n                    (msg.payload == \"25.5\") ? new Buffer([80,67,86,86,50,53,46,53,71,3,13]) :\n                    (msg.payload == \"25.6\") ? new Buffer([80,67,86,86,50,53,46,54,119,96,13]) :\n                    (msg.payload == \"25.7\") ? new Buffer([80,67,86,86,50,53,46,55,103,65,13]) :\n                    (msg.payload == \"25.8\") ? new Buffer([80,67,86,86,50,53,46,56,150,174,13]) :\n                    (msg.payload == \"25.9\") ? new Buffer([80,67,86,86,50,53,46,57,134,143,13]) :\n                    (msg.payload == \"26.0\") ? new Buffer([80,67,86,86,50,54,46,48,78,246,13]) :\n                    (msg.payload == \"26.1\") ? new Buffer([80,67,86,86,50,54,46,49,94,215,13]) :\n                    (msg.payload == \"26.2\") ? new Buffer([80,67,86,86,50,54,46,50,110,180,13]) :\n                    (msg.payload == \"26.3\") ? new Buffer([80,67,86,86,50,54,46,51,126,149,13]) :\n                    (msg.payload == \"26.4\") ? new Buffer([80,67,86,86,50,54,46,52,231,32]) :\n                    (msg.payload == \"26.5\") ? new Buffer([80,67,86,86,50,54,46,53,30,83,13]) :\n                    (msg.payload == \"26.6\") ? new Buffer([80,67,86,86,50,54,46,54,46,48,13]) :\n                    (msg.payload == \"26.7\") ? new Buffer([80,67,86,86,50,54,46,55,62,17,13]) :\n                    (msg.payload == \"26.8\") ? new Buffer([80,67,86,86,50,54,46,56,207,254,13]) :\n                    (msg.payload == \"26.9\") ? new Buffer([80,67,86,86,50,54,46,57,223,223,13]) :\n                    (msg.payload == \"27.0\") ? new Buffer([80,67,86,86,50,55,46,48,121,198,13]) :\n                    (msg.payload == \"27.1\") ? new Buffer([80,67,86,86,50,55,46,49,105,231,13]) :\n                    (msg.payload == \"27.2\") ? new Buffer([80,67,86,86,50,55,46,50,89,132,13]) :\n                    (msg.payload == \"27.3\") ? new Buffer([80,67,86,86,50,55,46,51,73,165,13]) :\n                    (msg.payload == \"27.4\") ? new Buffer([80,67,86,86,50,55,46,52,57,66,13]) :\n                    (msg.payload == \"27.5\") ? new Buffer([80,67,86,86,50,55,46,53,41,99,13]) :\n                    (msg.payload == \"27.6\") ? new Buffer([80,67,86,86,50,55,46,54,25,0,13]) :\n                    (msg.payload == \"27.7\") ? new Buffer([80,67,86,86,50,55,46,55,146,16]) :\n                    (msg.payload == \"27.8\") ? new Buffer([80,67,86,86,50,55,46,56,248,206,13]) :\n                    (msg.payload == \"27.9\") ? new Buffer([80,67,86,86,50,55,46,57,232,239,13]) :\n                    (msg.payload == \"28.0\") ? new Buffer([80,67,86,86,50,56,46,48,85,247,13]) :\n                    (msg.payload == \"28.1\") ? new Buffer([80,67,86,86,50,56,46,49,69,214,13]) :\n                    (msg.payload == \"28.2\") ? new Buffer([80,67,86,86,50,56,46,50,117,181,13]) :\n                    (msg.payload == \"28.3\") ? new Buffer([80,67,86,86,50,56,46,51,101,148,13]) :\n                    (msg.payload == \"28.4\") ? new Buffer([80,67,86,86,50,56,46,52,21,115,13]) :\n                    (msg.payload == \"28.5\") ? new Buffer([80,67,86,86,50,56,46,53,85,32]) :\n                    (msg.payload == \"28.6\") ? new Buffer([80,67,86,86,50,56,46,54,53,49,13]) :\n                    (msg.payload == \"28.7\") ? new Buffer([80,67,86,86,50,56,46,55,37,16,13]) :\n                    (msg.payload == \"28.8\") ? new Buffer([80,67,86,86,50,56,46,56,212,255,13]) :\n                    (msg.payload == \"28.9\") ? new Buffer([80,67,86,86,50,56,46,57,196,222,13]) :\n                    (msg.payload == \"29.0\") ? new Buffer([80,67,86,86,50,57,46,48,98,199,13]) :\n                    (msg.payload == \"29.1\") ? new Buffer([80,67,86,86,50,57,46,49,114,230,13]) :\n                    (msg.payload == \"29.2\") ? new Buffer([80,67,86,86,50,57,46,50,66,133,13]) :\n                    (msg.payload == \"29.3\") ? new Buffer([80,67,86,86,50,57,46,51,82,164,13]) :\n                    (msg.payload == \"29.4\") ? new Buffer([80,67,86,86,50,57,46,52,34,67,13]) :\n                    (msg.payload == \"29.5\") ? new Buffer([80,67,86,86,50,57,46,53,50,98,13]) :\n                    (msg.payload == \"29.6\") ? new Buffer([80,67,86,86,50,57,46,54,32,16]) :\n                    (msg.payload == \"29.7\") ? new Buffer([80,67,86,86,50,57,46,55,18,32,13]) :\n                    (msg.payload == \"29.8\") ? new Buffer([80,67,86,86,50,57,46,56,227,207,13]) :\n                    (msg.payload == \"29.9\") ? new Buffer([80,67,86,86,50,57,46,57,243,238,13]) :\n                    (msg.payload == \"30.0\") ? new Buffer([80,67,86,86,51,48,46,48,138,226,13]) :\n                    (msg.payload == \"30.1\") ? new Buffer([80,67,86,86,51,48,46,49,154,195,13]) :\n                    (msg.payload == \"30.2\") ? new Buffer([80,67,86,86,51,48,46,50,170,160,13]) :\n                    (msg.payload == \"30.3\") ? new Buffer([80,67,86,86,51,48,46,51,186,129,13]) :\n                    (msg.payload == \"30.4\") ? new Buffer([80,67,86,86,51,48,46,52,202,102,13]) :\n                    (msg.payload == \"30.5\") ? new Buffer([80,67,86,86,51,48,46,53,218,71,13]) :\n                    (msg.payload == \"30.6\") ? new Buffer([80,67,86,86,51,48,46,54,234,36,13]) :\n                    (msg.payload == \"30.7\") ? new Buffer([80,67,86,86,51,48,46,55,250,5,13]) :\n                    (msg.payload == \"30.8\") ? new Buffer([80,67,86,86,51,48,46,56,190,160]) :\n                    (msg.payload == \"30.9\") ? new Buffer([80,67,86,86,51,48,46,57,27,203,13]) :\n                    (msg.payload == \"31.0\") ? new Buffer([80,67,86,86,51,49,46,48,189,210,13]) :\n                    (msg.payload == \"31.1\") ? new Buffer([80,67,86,86,51,49,46,49,173,243,13]) :\n                    (msg.payload == \"31.2\") ? new Buffer([80,67,86,86,51,49,46,50,157,144,13]) :\n                    (msg.payload == \"31.3\") ? new Buffer([80,67,86,86,51,49,46,51,141,177,13]) :\n                    (msg.payload == \"31.4\") ? new Buffer([80,67,86,86,51,49,46,52,253,86,13]) :\n                    (msg.payload == \"31.5\") ? new Buffer([80,67,86,86,51,49,46,53,237,119,13]) :\n                    (msg.payload == \"24.0\") ? new Buffer([80,67,86,86,50,52,46,48,32,150,13]) :\n                    (msg.payload == \"24.1\") ? new Buffer([80,67,86,86,50,52,46,49,48,183,13]) :\n                    (msg.payload == \"24.2\") ? new Buffer([80,67,86,86,50,52,46,50,212,13]) :\n                    (msg.payload == \"24.3\") ? new Buffer([80,67,86,86,50,52,46,51,16,245,13]) :\n                    (msg.payload == \"24.4\") ? new Buffer([80,67,86,86,50,52,46,52,96,18,13]) :\n                    (msg.payload == \"24.5\") ? new Buffer([80,67,86,86,50,52,46,53,112,51,13]) :\n                    (msg.payload == \"24.6\") ? new Buffer([80,67,86,86,50,52,46,54,64,80,13]) :\n                    (msg.payload == \"24.7\") ? new Buffer([80,67,86,86,50,52,46,55,80,113,13]) :\n                    (msg.payload == \"24.8\") ? new Buffer([80,67,86,86,50,52,46,56,161,158,13]) :\n                    (msg.payload == \"24.9\") ? new Buffer([80,67,86,86,50,52,46,57,177,191,13]) :\n                    (msg.payload == \"25.0\") ? new Buffer([80,67,86,86,50,53,46,48,23,166,13]) :\n                    (msg.payload == \"25.1\") ? new Buffer([80,67,86,86,50,53,46,49,120,112]) :\n                    (msg.payload == \"25.2\") ? new Buffer([80,67,86,86,50,53,46,50,55,228,13]) :\n                    (msg.payload == \"25.3\") ? new Buffer([80,67,86,86,50,53,46,51,39,197,13]) :\n                    (msg.payload == \"25.4\") ? new Buffer([80,67,86,86,50,53,46,52,87,34,13]) :\n                    (msg.payload == \"25.5\") ? new Buffer([80,67,86,86,50,53,46,53,71,3,13]) :\n                    (msg.payload == \"25.6\") ? new Buffer([80,67,86,86,50,53,46,54,119,96,13]) :\n                    (msg.payload == \"25.7\") ? new Buffer([80,67,86,86,50,53,46,55,103,65,13]) :\n                    (msg.payload == \"25.8\") ? new Buffer([80,67,86,86,50,53,46,56,150,174,13]) :\n                    (msg.payload == \"25.9\") ? new Buffer([80,67,86,86,50,53,46,57,134,143,13]) :\n                    (msg.payload == \"26.0\") ? new Buffer([80,67,86,86,50,54,46,48,78,246,13]) :\n                    (msg.payload == \"26.1\") ? new Buffer([80,67,86,86,50,54,46,49,94,215,13]) :\n                    (msg.payload == \"26.2\") ? new Buffer([80,67,86,86,50,54,46,50,110,180,13]) :\n                    (msg.payload == \"26.3\") ? new Buffer([80,67,86,86,50,54,46,51,126,149,13]) :\n                    (msg.payload == \"26.4\") ? new Buffer([80,67,86,86,50,54,46,52,231,32]) :\n                    (msg.payload == \"26.5\") ? new Buffer([80,67,86,86,50,54,46,53,30,83,13]) :\n                    (msg.payload == \"26.6\") ? new Buffer([80,67,86,86,50,54,46,54,46,48,13]) :\n                    (msg.payload == \"26.7\") ? new Buffer([80,67,86,86,50,54,46,55,62,17,13]) :\n                    (msg.payload == \"26.8\") ? new Buffer([80,67,86,86,50,54,46,56,207,254,13]) :\n                    (msg.payload == \"26.9\") ? new Buffer([80,67,86,86,50,54,46,57,223,223,13]) :\n                    (msg.payload == \"27.0\") ? new Buffer([80,67,86,86,50,55,46,48,121,198,13]) :\n                    (msg.payload == \"27.1\") ? new Buffer([80,67,86,86,50,55,46,49,105,231,13]) :\n                    (msg.payload == \"27.2\") ? new Buffer([80,67,86,86,50,55,46,50,89,132,13]) :\n                    (msg.payload == \"27.3\") ? new Buffer([80,67,86,86,50,55,46,51,73,165,13]) :\n                    (msg.payload == \"27.4\") ? new Buffer([80,67,86,86,50,55,46,52,57,66,13]) :\n                    (msg.payload == \"27.5\") ? new Buffer([80,67,86,86,50,55,46,53,41,99,13]) :\n                    (msg.payload == \"27.6\") ? new Buffer([80,67,86,86,50,55,46,54,25,0,13]) :\n                    (msg.payload == \"27.7\") ? new Buffer([80,67,86,86,50,55,46,55,146,16]) :\n                    (msg.payload == \"27.8\") ? new Buffer([80,67,86,86,50,55,46,56,248,206,13]) :\n                    (msg.payload == \"27.9\") ? new Buffer([80,67,86,86,50,55,46,57,232,239,13]) :\n                    (msg.payload == \"28.0\") ? new Buffer([80,67,86,86,50,56,46,48,85,247,13]) :\n                    (msg.payload == \"28.1\") ? new Buffer([80,67,86,86,50,56,46,49,69,214,13]) :\n                    (msg.payload == \"28.2\") ? new Buffer([80,67,86,86,50,56,46,50,117,181,13]) :\n                    (msg.payload == \"28.3\") ? new Buffer([80,67,86,86,50,56,46,51,101,148,13]) :\n                    (msg.payload == \"28.4\") ? new Buffer([80,67,86,86,50,56,46,52,21,115,13]) :\n                    (msg.payload == \"28.5\") ? new Buffer([80,67,86,86,50,56,46,53,85,32]) :\n                    (msg.payload == \"28.6\") ? new Buffer([80,67,86,86,50,56,46,54,53,49,13]) :\n                    (msg.payload == \"28.7\") ? new Buffer([80,67,86,86,50,56,46,55,37,16,13]) :\n                    (msg.payload == \"28.8\") ? new Buffer([80,67,86,86,50,56,46,56,212,255,13]) :\n                    (msg.payload == \"28.9\") ? new Buffer([80,67,86,86,50,56,46,57,196,222,13]) :\n                    (msg.payload == \"29.0\") ? new Buffer([80,67,86,86,50,57,46,48,98,199,13]) :\n                    (msg.payload == \"29.1\") ? new Buffer([80,67,86,86,50,57,46,49,114,230,13]) :\n                    (msg.payload == \"29.2\") ? new Buffer([80,67,86,86,50,57,46,50,66,133,13]) :\n                    (msg.payload == \"29.3\") ? new Buffer([80,67,86,86,50,57,46,51,82,164,13]) :\n                    (msg.payload == \"29.4\") ? new Buffer([80,67,86,86,50,57,46,52,34,67,13]) :\n                    (msg.payload == \"29.5\") ? new Buffer([80,67,86,86,50,57,46,53,50,98,13]) :\n                    (msg.payload == \"29.6\") ? new Buffer([80,67,86,86,50,57,46,54,32,16]) :\n                    (msg.payload == \"29.7\") ? new Buffer([80,67,86,86,50,57,46,55,18,32,13]) :\n                    (msg.payload == \"29.8\") ? new Buffer([80,67,86,86,50,57,46,56,227,207,13]) :\n                    (msg.payload == \"29.9\") ? new Buffer([80,67,86,86,50,57,46,57,243,238,13]) :\n                    (msg.payload == \"30.0\") ? new Buffer([80,67,86,86,51,48,46,48,138,226,13]) :\n                    (msg.payload == \"30.1\") ? new Buffer([80,67,86,86,51,48,46,49,154,195,13]) :\n                    (msg.payload == \"30.2\") ? new Buffer([80,67,86,86,51,48,46,50,170,160,13]) :\n                    (msg.payload == \"30.3\") ? new Buffer([80,67,86,86,51,48,46,51,186,129,13]) :\n                    (msg.payload == \"30.4\") ? new Buffer([80,67,86,86,51,48,46,52,202,102,13]) :\n                    (msg.payload == \"30.5\") ? new Buffer([80,67,86,86,51,48,46,53,218,71,13]) :\n                    (msg.payload == \"30.6\") ? new Buffer([80,67,86,86,51,48,46,54,234,36,13]) :\n                    (msg.payload == \"30.7\") ? new Buffer([80,67,86,86,51,48,46,55,250,5,13]) :\n                    (msg.payload == \"30.8\") ? new Buffer([80,67,86,86,51,48,46,56,190,160]) :\n                    (msg.payload == \"30.9\") ? new Buffer([80,67,86,86,51,48,46,57,27,203,13]) :\n                    (msg.payload == \"31.0\") ? new Buffer([80,67,86,86,51,49,46,48,189,210,13]) :\n                    (msg.payload == \"31.1\") ? new Buffer([80,67,86,86,51,49,46,49,173,243,13]) :\n                    (msg.payload == \"31.2\") ? new Buffer([80,67,86,86,51,49,46,50,157,144,13]) :\n                    (msg.payload == \"31.3\") ? new Buffer([80,67,86,86,51,49,46,51,141,177,13]) :\n                    (msg.payload == \"31.4\") ? new Buffer([80,67,86,86,51,49,46,52,253,86,13]) :\n                    (msg.payload == \"31.5\") ? new Buffer([80,67,86,86,51,49,46,53,237,119,13]) :\n                    (msg.payload == \"40.0\") ? new Buffer([80,67,86,86,52,48,46,48,219,207,13]) :\n                    (msg.payload == \"40.1\") ? new Buffer([80,67,86,86,52,48,46,49,203,238,13]) :\n                    (msg.payload == \"40.2\") ? new Buffer([80,67,86,86,52,48,46,50,251,141,13]) :\n                    (msg.payload == \"40.3\") ? new Buffer([80,67,86,86,52,48,46,51,235,172,13]) :\n                    (msg.payload == \"40.4\") ? new Buffer([80,67,86,86,52,48,46,52,155,75,13]) :\n                    (msg.payload == \"40.5\") ? new Buffer([80,67,86,86,52,48,46,53,139,106,13]) :\n                    (msg.payload == \"40.6\") ? new Buffer([80,67,86,86,52,48,46,54,187,9,13]) :\n                    (msg.payload == \"40.7\") ? new Buffer([80,67,86,86,52,48,46,55,171,40,13]) :\n                    (msg.payload == \"40.8\") ? new Buffer([80,67,86,86,52,48,46,56,90,199,13]) :\n                    (msg.payload == \"40.9\") ? new Buffer([80,67,86,86,52,48,46,57,74,230,13]) :\n                    (msg.payload == \"41.0\") ? new Buffer([80,67,86,86,52,49,46,48,236,255,13]) :\n                    (msg.payload == \"41.1\") ? new Buffer([80,67,86,86,52,49,46,49,252,222,13]) :\n                    (msg.payload == \"41.2\") ? new Buffer([80,67,86,86,52,49,46,50,204,189,13]) :\n                    (msg.payload == \"41.3\") ? new Buffer([80,67,86,86,52,49,46,51,220,156,13]) :\n                    (msg.payload == \"41.4\") ? new Buffer([80,67,86,86,52,49,46,52,172,123,13]) :\n                    (msg.payload == \"41.5\") ? new Buffer([80,67,86,86,52,49,46,53,188,90,13]) :\n                    (msg.payload == \"41.6\") ? new Buffer([80,67,86,86,52,49,46,54,140,57,13]) :\n                    (msg.payload == \"41.7\") ? new Buffer([80,67,86,86,52,49,46,55,156,24,13]) :\n                    (msg.payload == \"41.8\") ? new Buffer([80,67,86,86,52,49,46,56,109,247,13]) :\n                    (msg.payload == \"41.9\") ? new Buffer([80,67,86,86,52,49,46,57,125,214,13]) :\n                    (msg.payload == \"42.0\") ? new Buffer([80,67,86,86,52,50,46,48,181,175,13]) :\n                    (msg.payload == \"42.1\") ? new Buffer([80,67,86,86,52,50,46,49,165,142,13]) :\n                    (msg.payload == \"42.2\") ? new Buffer([80,67,86,86,52,50,46,50,149,237,13]) :\n                    (msg.payload == \"42.3\") ? new Buffer([80,67,86,86,52,50,46,51,133,204,13]) :\n                    (msg.payload == \"42.4\") ? new Buffer([80,67,86,86,52,50,46,52,245,43,13]) :\n                    (msg.payload == \"42.5\") ? new Buffer([80,67,86,86,52,50,46,53,229,10,13]) :\n                    (msg.payload == \"42.6\") ? new Buffer([80,67,86,86,52,50,46,54,213,105,13]) :\n                    (msg.payload == \"42.7\") ? new Buffer([80,67,86,86,52,50,46,55,197,72,13]) :\n                    (msg.payload == \"42.8\") ? new Buffer([80,67,86,86,52,50,46,56,52,167,13]) :\n                    (msg.payload == \"42.9\") ? new Buffer([80,67,86,86,52,50,46,57,36,134,13]) :\n                    (msg.payload == \"43.0\") ? new Buffer([80,67,86,86,52,51,46,48,130,159,13]) :\n                    (msg.payload == \"43.1\") ? new Buffer([80,67,86,86,52,51,46,49,146,190,13]) :\n                    (msg.payload == \"43.2\") ? new Buffer([80,67,86,86,52,51,46,50,162,221,13]) :\n                    (msg.payload == \"43.3\") ? new Buffer([80,67,86,86,52,51,46,51,178,252,13]) :\n                    (msg.payload == \"43.4\") ? new Buffer([80,67,86,86,52,51,46,52,194,27,13]) :\n                    (msg.payload == \"43.5\") ? new Buffer([80,67,86,86,52,51,46,53,210,58,13]) :\n                    (msg.payload == \"43.6\") ? new Buffer([80,67,86,86,52,51,46,54,226,89,13]) :\n                    (msg.payload == \"43.7\") ? new Buffer([80,67,86,86,52,51,46,55,242,120,13]) :\n                    (msg.payload == \"43.8\") ? new Buffer([80,67,86,86,52,51,46,56,57,112]) :\n                    (msg.payload == \"43.9\") ? new Buffer([80,67,86,86,52,51,46,57,19,182,13]) :\n                    (msg.payload == \"44.0\") ? new Buffer([80,67,86,86,52,52,46,48,112,240]) :\n                    (msg.payload == \"44.1\") ? new Buffer([80,67,86,86,52,52,46,49,23,46,13]) :\n                    (msg.payload == \"44.2\") ? new Buffer([80,67,86,86,52,52,46,50,39,77,13]) :\n                    (msg.payload == \"44.3\") ? new Buffer([80,67,86,86,52,52,46,51,55,108,13]) :\n                    (msg.payload == \"44.4\") ? new Buffer([80,67,86,86,52,52,46,52,71,139,13]) :\n                    (msg.payload == \"44.5\") ? new Buffer([80,67,86,86,52,52,46,53,87,170,13]) :\n                    (msg.payload == \"44.6\") ? new Buffer([80,67,86,86,52,52,46,54,103,201,13]) :\n                    (msg.payload == \"44.7\") ? new Buffer([80,67,86,86,52,52,46,55,119,232,13]) :\n                    (msg.payload == \"44.8\") ? new Buffer([80,67,86,86,52,52,46,56,134,7,13]) :\n                    (msg.payload == \"44.9\") ? new Buffer([80,67,86,86,52,52,46,57,150,38,13]) :\n                    (msg.payload == \"45.0\") ? new Buffer([80,67,86,86,52,53,46,48,48,63,13]) :\n                    (msg.payload == \"45.1\") ? new Buffer([80,67,86,86,52,53,46,49,32,30,13]) :\n                    (msg.payload == \"45.2\") ? new Buffer([80,67,86,86,52,53,46,50,16,125,13]) :\n                    (msg.payload == \"45.3\") ? new Buffer([80,67,86,86,52,53,46,51,92,13]) :\n                    (msg.payload == \"45.4\") ? new Buffer([80,67,86,86,52,53,46,52,112,187,13]) :\n                    (msg.payload == \"45.5\") ? new Buffer([80,67,86,86,52,53,46,53,96,154,13]) :\n                    (msg.payload == \"45.6\") ? new Buffer([80,67,86,86,52,53,46,54,80,249,13]) :\n                    (msg.payload == \"45.7\") ? new Buffer([80,67,86,86,52,53,46,55,64,216,13]) :\n                    (msg.payload == \"45.8\") ? new Buffer([80,67,86,86,52,53,46,56,177,55,13]) :\n                    (msg.payload == \"45.9\") ? new Buffer([80,67,86,86,52,53,46,57,161,22,13]) :\n                    (msg.payload == \"46.0\") ? new Buffer([80,67,86,86,52,54,46,48,105,111,13]) :\n                    (msg.payload == \"46.1\") ? new Buffer([80,67,86,86,52,54,46,49,121,78,13]) :\n                    (msg.payload == \"46.2\") ? new Buffer([80,67,86,86,52,54,46,50,73,45,13]) :\n                    (msg.payload == \"46.3\") ? new Buffer([80,67,86,86,52,54,46,51,89,12,13]) :\n                    (msg.payload == \"46.4\") ? new Buffer([80,67,86,86,52,54,46,52,41,235,13]) :\n                    (msg.payload == \"46.5\") ? new Buffer([80,67,86,86,52,54,46,53,57,202,13]) :\n                    (msg.payload == \"46.6\") ? new Buffer([80,67,86,86,52,54,46,54,154,144]) :\n                    (msg.payload == \"46.7\") ? new Buffer([80,67,86,86,52,54,46,55,25,136,13]) :\n                    (msg.payload == \"46.8\") ? new Buffer([80,67,86,86,52,54,46,56,232,103,13]) :\n                    (msg.payload == \"46.9\") ? new Buffer([80,67,86,86,52,54,46,57,248,70,13]) :\n                    (msg.payload == \"47.0\") ? new Buffer([80,67,86,86,52,55,46,48,94,95,13]) :\n                    (msg.payload == \"47.1\") ? new Buffer([80,67,86,86,52,55,46,49,78,126,13]) :\n                    (msg.payload == \"47.2\") ? new Buffer([80,67,86,86,52,55,46,50,126,29,13]) :\n                    (msg.payload == \"47.3\") ? new Buffer([80,67,86,86,52,55,46,51,110,60,13]) :\n                    (msg.payload == \"47.4\") ? new Buffer([80,67,86,86,52,55,46,52,30,219,13]) :\n                    (msg.payload == \"47.5\") ? new Buffer([80,67,86,86,52,55,46,53,239,160]) :\n                    (msg.payload == \"47.6\") ? new Buffer([80,67,86,86,52,55,46,54,62,153,13]) :\n                    (msg.payload == \"47.7\") ? new Buffer([80,67,86,86,52,55,46,55,46,184,13]) :\n                    (msg.payload == \"47.8\") ? new Buffer([80,67,86,86,52,55,46,56,223,87,13]) :\n                    (msg.payload == \"47.9\") ? new Buffer([80,67,86,86,52,55,46,57,207,118,13]) :\n                    (msg.payload == \"48.0\") ? new Buffer([80,67,86,86,52,56,46,48,114,110,13]) :\n                    (msg.payload == \"48.1\") ? new Buffer([80,67,86,86,52,56,46,49,98,79,13]) :\n                    (msg.payload == \"48.2\") ? new Buffer([80,67,86,86,52,56,46,50,82,44,13]) :\n                    (msg.payload == \"48.3\") ? new Buffer([80,67,86,86,52,56,46,51,66,13,13]) :\n                    (msg.payload == \"48.4\") ? new Buffer([80,67,86,86,52,56,46,52,50,234,13]) :\n                    (msg.payload == \"48.5\") ? new Buffer([80,67,86,86,52,56,46,53,34,203,13]) :\n                    (msg.payload == \"48.6\") ? new Buffer([80,67,86,86,52,56,46,54,18,168,13]) :\n                    (msg.payload == \"48.7\") ? new Buffer([80,67,86,86,52,56,46,55,40,144]) :\n                    (msg.payload == \"48.8\") ? new Buffer([80,67,86,86,52,56,46,56,243,102,13]) :\n                    (msg.payload == \"48.9\") ? new Buffer([80,67,86,86,52,56,46,57,227,71,13]) :\n                    (msg.payload == \"49.0\") ? new Buffer([80,67,86,86,52,57,46,48,69,94,13]) :\n                    (msg.payload == \"49.1\") ? new Buffer([80,67,86,86,52,57,46,49,85,127,13]) :\n                    (msg.payload == \"49.2\") ? new Buffer([80,67,86,86,52,57,46,50,101,28,13]) :\n                    (msg.payload == \"49.3\") ? new Buffer([80,67,86,86,52,57,46,51,117,61,13]) :\n                    (msg.payload == \"49.4\") ? new Buffer([80,67,86,86,52,57,46,52,93,160]) :\n                    (msg.payload == \"49.5\") ? new Buffer([80,67,86,86,52,57,46,53,21,251,13]) :\n                    (msg.payload == \"49.6\") ? new Buffer([80,67,86,86,52,57,46,54,37,152,13]) :\n                    (msg.payload == \"49.7\") ? new Buffer([80,67,86,86,52,57,46,55,53,185,13]) :\n                    (msg.payload == \"49.8\") ? new Buffer([80,67,86,86,52,57,46,56,196,86,13]) :\n                    (msg.payload == \"49.9\") ? new Buffer([80,67,86,86,52,57,46,57,212,119,13]) :\n                    (msg.payload == \"50.0\") ? new Buffer([80,67,86,86,53,48,46,48,173,123,13]) :\n                    (msg.payload == \"50.1\") ? new Buffer([80,67,86,86,53,48,46,49,189,90,13]) :\n                    (msg.payload == \"50.2\") ? new Buffer([80,67,86,86,53,48,46,50,141,57,13]) :\n                    (msg.payload == \"50.3\") ? new Buffer([80,67,86,86,53,48,46,51,157,24,13]) :\n                    (msg.payload == \"50.4\") ? new Buffer([80,67,86,86,53,48,46,52,237,255,13]) :\n                    (msg.payload == \"50.5\") ? new Buffer([80,67,86,86,53,48,46,53,253,222,13]) :\n                    (msg.payload == \"50.6\") ? new Buffer([80,67,86,86,53,48,46,54,205,189,13]) :\n                    (msg.payload == \"50.7\") ? new Buffer([80,67,86,86,53,48,46,55,221,156,13]) :\n                    (msg.payload == \"50.8\") ? new Buffer([80,67,86,86,53,48,46,56,44,115,13]) :\n                    (msg.payload == \"50.9\") ? new Buffer([80,67,86,86,53,48,46,57,60,82,13]) :\n                    (msg.payload == \"51.0\") ? new Buffer([80,67,86,86,53,49,46,48,154,75,13]) :\n                    (msg.payload == \"51.1\") ? new Buffer([80,67,86,86,53,49,46,49,138,106,13]) :\n                    (msg.payload == \"51.2\") ? new Buffer([80,67,86,86,53,49,46,50,186,9,13]) :\n                    (msg.payload == \"51.3\") ? new Buffer([80,67,86,86,53,49,46,51,170,40,13]) :\n                    (msg.payload == \"51.4\") ? new Buffer([80,67,86,86,53,49,46,52,218,207,13]) :\n                    (msg.payload == \"51.5\") ? new Buffer([80,67,86,86,53,49,46,53,202,238,13]) :\n                    (msg.payload == \"51.6\") ? new Buffer([80,67,86,86,53,49,46,54,250,141,13]) :\n                    (msg.payload == \"51.7\") ? new Buffer([80,67,86,86,53,49,46,55,234,172,13]) :\n                    (msg.payload == \"51.8\") ? new Buffer([80,67,86,86,53,49,46,56,27,67,13]) :\n                    (msg.payload == \"51.9\") ? new Buffer([80,67,86,86,53,49,46,57,182,32]) :\n                    (msg.payload == \"52.0\") ? new Buffer([80,67,86,86,53,50,46,48,195,27,13]) :\n                    (msg.payload == \"52.1\") ? new Buffer([80,67,86,86,53,50,46,49,211,58,13]) :\n                    (msg.payload == \"52.2\") ? new Buffer([80,67,86,86,53,50,46,50,227,89,13]) :\n                    (msg.payload == \"52.3\") ? new Buffer([80,67,86,86,53,50,46,51,243,120,13]) :\n                    (msg.payload == \"52.4\") ? new Buffer([80,67,86,86,53,50,46,52,131,159,13]) :\n                    (msg.payload == \"52.5\") ? new Buffer([80,67,86,86,53,50,46,53,147,190,13]) :\n                    (msg.payload == \"52.6\") ? new Buffer([80,67,86,86,53,50,46,54,163,221,13]) :\n                    (msg.payload == \"52.7\") ? new Buffer([80,67,86,86,53,50,46,55,179,252,13]) :\n                    (msg.payload == \"52.8\") ? new Buffer([80,67,86,86,53,50,46,56,66,19,13]) :\n                    (msg.payload == \"52.9\") ? new Buffer([80,67,86,86,53,50,46,57,82,50,13]) :\n                    (msg.payload == \"53.0\") ? new Buffer([80,67,86,86,53,51,46,48,244,43,13]) :\n                    (msg.payload == \"53.1\") ? new Buffer([80,67,86,86,53,51,46,49,228,10,13]) :\n                    (msg.payload == \"53.2\") ? new Buffer([80,67,86,86,53,51,46,50,212,105,13]) :\n                    (msg.payload == \"53.3\") ? new Buffer([80,67,86,86,53,51,46,51,196,72,13]) :\n                    (msg.payload == \"53.4\") ? new Buffer([80,67,86,86,53,51,46,52,180,175,13]) :\n                    (msg.payload == \"53.5\") ? new Buffer([80,67,86,86,53,51,46,53,164,142,13]) :\n                    (msg.payload == \"53.6\") ? new Buffer([80,67,86,86,53,51,46,54,148,237,13]) :\n                    (msg.payload == \"53.7\") ? new Buffer([80,67,86,86,53,51,46,55,132,204,13]) :\n                    (msg.payload == \"53.8\") ? new Buffer([80,67,86,86,53,51,46,56,117,35,13]) :\n                    (msg.payload == \"53.9\") ? new Buffer([80,67,86,86,53,51,46,57,101,2,13]) :\n                    (msg.payload == \"54.0\") ? new Buffer([80,67,86,86,53,52,46,48,113,187,13]) :\n                    (msg.payload == \"54.1\") ? new Buffer([80,67,86,86,53,52,46,49,97,154,13]) :\n                    (msg.payload == \"54.2\") ? new Buffer([80,67,86,86,53,52,46,50,81,249,13]) :\n                    (msg.payload == \"54.3\") ? new Buffer([80,67,86,86,53,52,46,51,65,216,13]) :\n                    (msg.payload == \"54.4\") ? new Buffer([80,67,86,86,53,52,46,52,49,63,13]) :\n                    (msg.payload == \"54.5\") ? new Buffer([80,67,86,86,53,52,46,53,33,30,13]) :\n                    (msg.payload == \"54.6\") ? new Buffer([80,67,86,86,53,52,46,54,17,125,13]) :\n                    (msg.payload == \"54.7\") ? new Buffer([80,67,86,86,53,52,46,55,21,192]) :\n                    (msg.payload == \"54.8\") ? new Buffer([80,67,86,86,53,52,46,56,240,179,13]) :\n                    (msg.payload == \"54.9\") ? new Buffer([80,67,86,86,53,52,46,57,224,146,13]) :\n                    (msg.payload == \"55.0\") ? new Buffer([80,67,86,86,53,53,46,48,70,139,13]) :\n                    (msg.payload == \"55.1\") ? new Buffer([80,67,86,86,53,53,46,49,86,170,13]) :\n                    (msg.payload == \"55.2\") ? new Buffer([80,67,86,86,53,53,46,50,102,201,13]) :\n                    (msg.payload == \"55.3\") ? new Buffer([80,67,86,86,53,53,46,51,118,232,13]) :\n                    (msg.payload == \"55.4\") ? new Buffer([80,67,86,86,53,53,46,52,96,240]) :\n                    (msg.payload == \"55.5\") ? new Buffer([80,67,86,86,53,53,46,53,22,46,13]) :\n                    (msg.payload == \"55.6\") ? new Buffer([80,67,86,86,53,53,46,54,38,77,13]) :\n                    (msg.payload == \"55.7\") ? new Buffer([80,67,86,86,53,53,46,55,54,108,13]) :\n                    (msg.payload == \"55.8\") ? new Buffer([80,67,86,86,53,53,46,56,199,131,13]) :\n                    (msg.payload == \"55.9\") ? new Buffer([80,67,86,86,53,53,46,57,215,162,13]) :\n                    (msg.payload == \"56.0\") ? new Buffer([80,67,86,86,53,54,46,48,31,219,13]) :\n                    (msg.payload == \"56.1\") ? new Buffer([80,67,86,86,53,54,46,49,255,160]) :\n                    (msg.payload == \"56.2\") ? new Buffer([80,67,86,86,53,54,46,50,63,153,13]) :\n                    (msg.payload == \"56.3\") ? new Buffer([80,67,86,86,53,54,46,51,47,184,13]) :\n                    (msg.payload == \"56.4\") ? new Buffer([80,67,86,86,53,54,46,52,95,95,13]) :\n                    (msg.payload == \"56.5\") ? new Buffer([80,67,86,86,53,54,46,53,79,126,13]) :\n                    (msg.payload == \"56.6\") ? new Buffer([80,67,86,86,53,54,46,54,127,29,13]) :\n                    (msg.payload == \"56.7\") ? new Buffer([80,67,86,86,53,54,46,55,111,60,13]) :\n                    (msg.payload == \"56.8\") ? new Buffer([80,67,86,86,53,54,46,56,158,211,13]) :\n                    (msg.payload == \"56.9\") ? new Buffer([80,67,86,86,53,54,46,57,142,242,13]) :\n                    (msg.payload == \"57.0\") ? new Buffer([80,67,86,86,53,55,46,48,40,235,13]) :\n                    (msg.payload == \"57.1\") ? new Buffer([80,67,86,86,53,55,46,49,56,202,13]) :\n                    (msg.payload == \"57.2\") ? new Buffer([80,67,86,86,53,55,46,50,138,144]) :\n                    (msg.payload == \"57.3\") ? new Buffer([80,67,86,86,53,55,46,51,24,136,13]) :\n                    (msg.payload == \"57.4\") ? new Buffer([80,67,86,86,53,55,46,52,104,111,13]) :\n                    (msg.payload == \"57.5\") ? new Buffer([80,67,86,86,53,55,46,53,120,78,13]) :\n                    (msg.payload == \"57.6\") ? new Buffer([80,67,86,86,53,55,46,54,72,45,13]) :\n                    (msg.payload == \"57.7\") ? new Buffer([80,67,86,86,53,55,46,55,88,12,13]) :\n                    (msg.payload == \"57.8\") ? new Buffer([80,67,86,86,53,55,46,56,169,227,13]) :\n                    (msg.payload == \"57.9\") ? new Buffer([80,67,86,86,53,55,46,57,185,194,13]) :\n                    (msg.payload == \"58.0\") ? new Buffer([80,67,86,86,53,56,46,48,77,160]) :\n                    (msg.payload == \"58.1\") ? new Buffer([80,67,86,86,53,56,46,49,20,251,13]) :\n                    (msg.payload == \"58.2\") ? new Buffer([80,67,86,86,53,56,46,50,36,152,13]) :\n                    (msg.payload == \"58.3\") ? new Buffer([80,67,86,86,53,56,46,51,52,185,13]) :\n                    (msg.payload == \"58.4\") ? new Buffer([80,67,86,86,53,56,46,52,68,94,13]) :\n                    (msg.payload == \"58.5\") ? new Buffer([80,67,86,86,53,56,46,53,84,127,13]) :\n                    (msg.payload == \"58.6\") ? new Buffer([80,67,86,86,53,56,46,54,100,28,13]) :\n                    (msg.payload == \"58.7\") ? new Buffer([80,67,86,86,53,56,46,55,116,61,13]) :\n                    (msg.payload == \"58.8\") ? new Buffer([80,67,86,86,53,56,46,56,133,210,13]) :\n                    (msg.payload == \"58.9\") ? new Buffer([80,67,86,86,53,56,46,57,149,243,13]) :\n                    (msg.payload == \"59.0\") ? new Buffer([80,67,86,86,53,57,46,48,51,234,13]) :\n                    (msg.payload == \"59.1\") ? new Buffer([80,67,86,86,53,57,46,49,35,203,13]) :\n                    (msg.payload == \"59.2\") ? new Buffer([80,67,86,86,53,57,46,50,19,168,13]) :\n                    (msg.payload == \"59.3\") ? new Buffer([80,67,86,86,53,57,46,51,56,144]) :\n                    (msg.payload == \"59.4\") ? new Buffer([80,67,86,86,53,57,46,52,115,110,13]) :\n                    (msg.payload == \"59.5\") ? new Buffer([80,67,86,86,53,57,46,53,99,79,13]) :\n                    (msg.payload == \"59.6\") ? new Buffer([80,67,86,86,53,57,46,54,83,44,13]) :\n                    (msg.payload == \"59.7\") ? new Buffer([80,67,86,86,53,57,46,55,67,13,13]) :\n                    (msg.payload == \"59.8\") ? new Buffer([80,67,86,86,53,57,46,56,178,226,13]) :\n                    (msg.payload == \"59.9\") ? new Buffer([80,67,86,86,53,57,46,57,162,195,13]) :\n                    (msg.payload == \"60.0\") ? new Buffer([80,67,86,86,54,48,46,48,54,167,13]) :\n                    (msg.payload == \"60.1\") ? new Buffer([80,67,86,86,54,48,46,49,38,134,13]) :\n                    (msg.payload == \"60.2\") ? new Buffer([80,67,86,86,54,48,46,50,22,229,13]) :\n                    (msg.payload == \"60.3\") ? new Buffer([80,67,86,86,54,48,46,51,108,64]) :\n                    (msg.payload == \"60.4\") ? new Buffer([80,67,86,86,54,48,46,52,118,35,13]) :\n                    (msg.payload == \"60.5\") ? new Buffer([80,67,86,86,54,48,46,53,102,2,13]) :\n                    (msg.payload == \"60.6\") ? new Buffer([80,67,86,86,54,48,46,54,86,97,13]) :\n                    (msg.payload == \"60.7\") ? new Buffer([80,67,86,86,54,48,46,55,70,64,13]) :\n                    (msg.payload == \"60.8\") ? new Buffer([80,67,86,86,54,48,46,56,183,175,13]) :\n                    (msg.payload == \"60.9\") ? new Buffer([80,67,86,86,54,48,46,57,167,142,13]) :\n                    (msg.payload == \"61.0\") ? new Buffer([80,67,86,86,54,49,46,48,25,112]) :\n                    (msg.payload == \"61.1\") ? new Buffer([80,67,86,86,54,49,46,49,17,182,13]) :\n                    (msg.payload == \"61.2\") ? new Buffer([80,67,86,86,54,49,46,50,33,213,13]) :\n                    (msg.payload == \"61.3\") ? new Buffer([80,67,86,86,54,49,46,51,49,244,13]) :\n                    (msg.payload == \"61.4\") ? new Buffer([80,67,86,86,54,49,46,52,65,19,13]) :\n                    (msg.payload == \"61.5\") ? new Buffer([80,67,86,86,54,49,46,53,81,50,13]) :\n                    (msg.payload == \"61.6\") ? new Buffer([80,67,86,86,54,49,46,54,97,81,13]) :\n                    (msg.payload == \"61.7\") ? new Buffer([80,67,86,86,54,49,46,55,113,112,13]) :\n                    (msg.payload == \"61.8\") ? new Buffer([80,67,86,86,54,49,46,56,128,159,13]) :\n                    (msg.payload == \"61.9\") ? new Buffer([80,67,86,86,54,49,46,57,144,190,13]) :\n                    (msg.payload == \"62.0\") ? new Buffer([80,67,86,86,54,50,46,48,88,199,13]) :\n                    (msg.payload == \"62.1\") ? new Buffer([80,67,86,86,54,50,46,49,72,230,13]) :\n                    (msg.payload == \"62.2\") ? new Buffer([80,67,86,86,54,50,46,50,120,133,13]) :\n                    (msg.payload == \"62.3\") ? new Buffer([80,67,86,86,54,50,46,51,104,164,13]) :\n                    (msg.payload == \"62.4\") ? new Buffer([80,67,86,86,54,50,46,52,24,67,13]) :\n                    (msg.payload == \"62.5\") ? new Buffer([80,67,86,86,54,50,46,53,134,32]) :\n                    (msg.payload == \"62.6\") ? new Buffer([80,67,86,86,54,50,46,54,56,1,13]) :\n                    (msg.payload == \"62.7\") ? new Buffer([80,67,86,86,54,50,46,55,40,32,13]) :\n                    (msg.payload == \"62.8\") ? new Buffer([80,67,86,86,54,50,46,56,217,207,13]) :\n                    (msg.payload == \"62.9\") ? new Buffer([80,67,86,86,54,50,46,57,201,238,13]) :\n                    (msg.payload == \"63.0\") ? new Buffer([80,67,86,86,54,51,46,48,111,247,13]) :\n                    (msg.payload == \"63.1\") ? new Buffer([80,67,86,86,54,51,46,49,127,214,13]) :\n                    (msg.payload == \"63.2\") ? new Buffer([80,67,86,86,54,51,46,50,79,181,13]) :\n                    (msg.payload == \"63.3\") ? new Buffer([80,67,86,86,54,51,46,51,95,148,13]) :\n                    (msg.payload == \"63.4\") ? new Buffer([80,67,86,86,54,51,46,52,47,115,13]) :\n                    (msg.payload == \"63.5\") ? new Buffer([80,67,86,86,54,51,46,53,63,82,13]) :\n                    (msg.payload == \"63.6\") ? new Buffer([80,67,86,86,54,51,46,54,243,16]) :\n                    (msg.payload == \"63.7\") ? new Buffer([80,67,86,86,54,51,46,55,31,16,13]) :\n                    (msg.payload == \"63.8\") ? new Buffer([80,67,86,86,54,51,46,56,238,255,13]) :\n                    (msg.payload == \"63.9\") ? new Buffer([80,67,86,86,54,51,46,57,254,222,13]) :\n                    (msg.payload == \"64.0\") ? new Buffer([80,67,86,86,54,52,46,48,234,103,13]) :\n                    (msg.payload == \"64.1\") ? new Buffer([80,67,86,86,54,52,46,49,250,70,13]) :\n\n\n                msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 27\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '27') {\n\n        msg.voltronicNum = i;\n\n        //option remplace\n        msg.payload = (msg.payload == \"25.0\") ? new Buffer([80,66,70,84,50,53,46,48,241,192,13]) :\n                (msg.payload == \"25.1\") ? new Buffer([80,66,70,84,50,53,46,49,225,225,13]) :\n                (msg.payload == \"25.2\") ? new Buffer([80,66,70,84,50,53,46,50,209,130,13]) :\n                (msg.payload == \"25.3\") ? new Buffer([80,66,70,84,50,53,46,51,193,163,13]) :\n                (msg.payload == \"25.4\") ? new Buffer([80,66,70,84,50,53,46,52,177,68,13]) :\n                (msg.payload == \"25.5\") ? new Buffer([80,66,70,84,50,53,46,53,161,101,13]) :\n                (msg.payload == \"25.6\") ? new Buffer([80,66,70,84,50,53,46,54,145,6,13]) :\n                (msg.payload == \"25.7\") ? new Buffer([80,66,70,84,50,53,46,55,129,39,13]) :\n                (msg.payload == \"25.8\") ? new Buffer([80,66,70,84,50,53,46,56,112,200,13]) :\n                (msg.payload == \"25.9\") ? new Buffer([80,66,70,84,50,53,46,57,96,233,13]) :\n                (msg.payload == \"26.0\") ? new Buffer([80,66,70,84,50,54,46,48,168,144,13]) :\n                (msg.payload == \"26.1\") ? new Buffer([80,66,70,84,50,54,46,49,184,177,13]) :\n                (msg.payload == \"26.2\") ? new Buffer([80,66,70,84,50,54,46,50,136,210,13]) :\n                (msg.payload == \"26.3\") ? new Buffer([80,66,70,84,50,54,46,51,152,243,13]) :\n                (msg.payload == \"26.4\") ? new Buffer([80,66,70,84,50,54,46,52,232,20,13]) :\n                (msg.payload == \"26.5\") ? new Buffer([80,66,70,84,50,54,46,53,248,53,13]) :\n                (msg.payload == \"26.6\") ? new Buffer([80,66,70,84,50,54,46,54,200,86,13]) :\n                (msg.payload == \"26.7\") ? new Buffer([80,66,70,84,50,54,46,55,216,119,13]) :\n                (msg.payload == \"26.8\") ? new Buffer([80,66,70,84,50,54,46,56,41,152,13]) :\n                (msg.payload == \"26.9\") ? new Buffer([80,66,70,84,50,54,46,57,57,185,13]) :\n                (msg.payload == \"27.0\") ? new Buffer([80,66,70,84,50,55,46,48,159,160,13]) :\n                (msg.payload == \"27.1\") ? new Buffer([80,66,70,84,50,55,46,49,143,129,13]) :\n                (msg.payload == \"27.2\") ? new Buffer([80,66,70,84,50,55,46,50,191,226,13]) :\n                (msg.payload == \"27.3\") ? new Buffer([80,66,70,84,50,55,46,51,175,195,13]) :\n                (msg.payload == \"27.4\") ? new Buffer([80,66,70,84,50,55,46,52,223,36,13]) :\n                (msg.payload == \"27.5\") ? new Buffer([80,66,70,84,50,55,46,53,207,5,13]) :\n                (msg.payload == \"27.6\") ? new Buffer([80,66,70,84,50,55,46,54,255,102,13]) :\n                (msg.payload == \"27.7\") ? new Buffer([80,66,70,84,50,55,46,55,239,71,13]) :\n                (msg.payload == \"27.8\") ? new Buffer([80,66,70,84,50,55,46,56,30,168,13]) :\n                (msg.payload == \"27.9\") ? new Buffer([80,66,70,84,50,55,46,57,232,144]) :\n                (msg.payload == \"28.0\") ? new Buffer([80,66,70,84,50,56,46,48,179,145,13]) :\n                (msg.payload == \"28.1\") ? new Buffer([80,66,70,84,50,56,46,49,163,176,13]) :\n                (msg.payload == \"28.2\") ? new Buffer([80,66,70,84,50,56,46,50,147,211,13]) :\n                (msg.payload == \"28.3\") ? new Buffer([80,66,70,84,50,56,46,51,131,242,13]) :\n                (msg.payload == \"28.4\") ? new Buffer([80,66,70,84,50,56,46,52,243,21,13]) :\n                (msg.payload == \"28.5\") ? new Buffer([80,66,70,84,50,56,46,53,227,52,13]) :\n                (msg.payload == \"28.6\") ? new Buffer([80,66,70,84,50,56,46,54,211,87,13]) :\n                (msg.payload == \"28.7\") ? new Buffer([80,66,70,84,50,56,46,55,195,118,13]) :\n                (msg.payload == \"28.8\") ? new Buffer([80,66,70,84,50,56,46,56,50,153,13]) :\n                (msg.payload == \"28.9\") ? new Buffer([80,66,70,84,50,56,46,57,34,184,13]) :\n                (msg.payload == \"29.0\") ? new Buffer([80,66,70,84,50,57,46,48,132,161,13]) :\n                (msg.payload == \"29.1\") ? new Buffer([80,66,70,84,50,57,46,49,148,128,13]) :\n                (msg.payload == \"29.2\") ? new Buffer([80,66,70,84,50,57,46,50,164,227,13]) :\n                (msg.payload == \"29.3\") ? new Buffer([80,66,70,84,50,57,46,51,180,194,13]) :\n                (msg.payload == \"29.4\") ? new Buffer([80,66,70,84,50,57,46,52,196,37,13]) :\n                (msg.payload == \"29.5\") ? new Buffer([80,66,70,84,50,57,46,53,212,4,13]) :\n                (msg.payload == \"29.6\") ? new Buffer([80,66,70,84,50,57,46,54,228,103,13]) :\n                (msg.payload == \"29.7\") ? new Buffer([80,66,70,84,50,57,46,55,244,70,13]) :\n                (msg.payload == \"29.8\") ? new Buffer([80,66,70,84,50,57,46,56,90,144]) :\n                (msg.payload == \"29.9\") ? new Buffer([80,66,70,84,50,57,46,57,21,136,13]) :\n                (msg.payload == \"30.0\") ? new Buffer([80,66,70,84,51,48,46,48,108,132,13]) :\n                (msg.payload == \"30.1\") ? new Buffer([80,66,70,84,51,48,46,49,124,165,13]) :\n                (msg.payload == \"30.2\") ? new Buffer([80,66,70,84,51,48,46,50,76,198,13]) :\n                (msg.payload == \"30.3\") ? new Buffer([80,66,70,84,51,48,46,51,92,231,13]) :\n                (msg.payload == \"30.4\") ? new Buffer([80,66,70,84,51,48,46,52,44,0,13]) :\n                (msg.payload == \"30.5\") ? new Buffer([80,66,70,84,51,48,46,53,60,33,13]) :\n                (msg.payload == \"30.6\") ? new Buffer([80,66,70,84,51,48,46,54,196,32]) :\n                (msg.payload == \"30.7\") ? new Buffer([80,66,70,84,51,48,46,55,28,99,13]) :\n                (msg.payload == \"30.8\") ? new Buffer([80,66,70,84,51,48,46,56,237,140,13]) :\n                (msg.payload == \"30.9\") ? new Buffer([80,66,70,84,51,48,46,57,253,173,13]) :\n                (msg.payload == \"31.0\") ? new Buffer([80,66,70,84,51,49,46,48,91,180,13]) :\n                (msg.payload == \"31.1\") ? new Buffer([80,66,70,84,51,49,46,49,75,149,13]) :\n                (msg.payload == \"31.2\") ? new Buffer([80,66,70,84,51,49,46,50,123,246,13]) :\n                (msg.payload == \"31.3\") ? new Buffer([80,66,70,84,51,49,46,51,107,215,13]) :\n                (msg.payload == \"31.4\") ? new Buffer([80,66,70,84,51,49,46,52,27,48,13]) :\n                (msg.payload == \"31.5\") ? new Buffer([80,66,70,84,51,49,46,53,177,16]) :\n                (msg.payload == \"48.0\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 48, 148, 8, 13]) :\n                (msg.payload == \"48.1\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 49, 132, 41, 13]) :\n                (msg.payload == \"48.2\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 50, 180, 74, 13]) :\n                (msg.payload == \"48.3\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 51, 164, 107, 13]) :\n                (msg.payload == \"48.4\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 52, 212, 140, 13]) :\n                (msg.payload == \"48.5\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 53, 196, 173, 13]) :\n                (msg.payload == \"48.6\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 54, 244, 206, 13]) :\n                (msg.payload == \"48.7\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 55, 228, 239, 13]) :\n                (msg.payload == \"48.8\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 56, 21, 0, 13]) :\n                (msg.payload == \"48.9\") ? new Buffer([80, 66, 70, 84, 52, 56, 46, 57, 82, 16]) :\n                (msg.payload == \"49.0\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 48, 163, 56, 13]) :\n                (msg.payload == \"49.1\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 49, 179, 25, 13]) :\n                (msg.payload == \"49.2\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 50, 131, 122, 13]) :\n                (msg.payload == \"49.3\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 51, 147, 91, 13]) :\n                (msg.payload == \"49.4\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 52, 227, 188, 13]) :\n                (msg.payload == \"49.5\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 53, 243, 157, 13]) :\n                (msg.payload == \"49.6\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 54, 195, 254, 13]) :\n                (msg.payload == \"49.7\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 55, 211, 223, 13]) :\n                (msg.payload == \"49.8\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 56, 34, 48, 13]) :\n                (msg.payload == \"49.9\") ? new Buffer([80, 66, 70, 84, 52, 57, 46, 57, 50, 17, 13]) :\n                (msg.payload == \"50.0\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 48, 75, 29, 13]) :\n                (msg.payload == \"50.1\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 49, 91, 60, 13]) :\n                (msg.payload == \"50.2\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 50, 107, 95, 13]) :\n                (msg.payload == \"50.3\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 51, 123, 126, 13]) :\n                (msg.payload == \"50.4\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 52, 185, 144]) :\n                (msg.payload == \"50.5\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 53, 27, 184, 13]) :\n                (msg.payload == \"50.6\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 54, 43, 219, 13]) :\n                (msg.payload == \"50.7\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 55, 59, 250, 13]) :\n                (msg.payload == \"50.8\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 56, 202, 21, 13]) :\n                (msg.payload == \"50.9\") ? new Buffer([80, 66, 70, 84, 53, 48, 46, 57, 218, 52, 13]) :\n                (msg.payload == \"51.0\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 48, 124, 45, 13]) :\n                (msg.payload == \"51.1\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 49, 108, 12, 13]) :\n                (msg.payload == \"51.2\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 50, 92, 111, 13]) :\n                (msg.payload == \"51.3\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 51, 76, 78, 13]) :\n                (msg.payload == \"51.4\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 52, 60, 169, 13]) :\n                (msg.payload == \"51.5\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 53, 44, 136, 13]) :\n                (msg.payload == \"51.6\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 54, 28, 235, 13]) :\n                (msg.payload == \"51.7\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 55, 204, 160]) :\n                (msg.payload == \"51.8\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 56, 253, 37, 13]) :\n                (msg.payload == \"51.9\") ? new Buffer([80, 66, 70, 84, 53, 49, 46, 57, 237, 4, 13]) :\n                (msg.payload == \"52.0\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 48, 37, 125, 13]) :\n                (msg.payload == \"52.1\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 49, 53, 92, 13]) :\n                (msg.payload == \"52.2\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 50, 83, 240]) :\n                (msg.payload == \"52.3\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 51, 21, 30, 13]) :\n                (msg.payload == \"52.4\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 52, 101, 249, 13]) :\n                (msg.payload == \"52.5\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 53, 117, 216, 13]) :\n                (msg.payload == \"52.6\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 54, 69, 187, 13]) :\n                (msg.payload == \"52.7\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 55, 85, 154, 13]) :\n                (msg.payload == \"52.8\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 56, 164, 117, 13]) :\n                (msg.payload == \"52.9\") ? new Buffer([80, 66, 70, 84, 53, 50, 46, 57, 180, 84, 13]) :\n                (msg.payload == \"53.0\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 48, 18, 77, 13]) :\n                (msg.payload == \"53.1\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 49, 38, 192]) :\n                (msg.payload == \"53.2\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 50, 50, 15, 13]) :\n                (msg.payload == \"53.3\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 51, 34, 46, 13]) :\n                (msg.payload == \"53.4\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 52, 82, 201, 13]) :\n                (msg.payload == \"53.5\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 53, 66, 232, 13]) :\n                (msg.payload == \"53.6\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 54, 114, 139, 13]) :\n                (msg.payload == \"53.7\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 55, 98, 170, 13]) :\n                (msg.payload == \"53.8\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 56, 147, 69, 13]) :\n                (msg.payload == \"53.9\") ? new Buffer([80, 66, 70, 84, 53, 51, 46, 57, 131, 100, 13]) :\n                (msg.payload == \"54.0\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 48, 151, 221, 13]) :\n                (msg.payload == \"54.1\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 49, 135, 252, 13]) :\n                (msg.payload == \"54.2\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 50, 183, 159, 13]) :\n                (msg.payload == \"54.3\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 51, 167, 190, 13]) :\n                (msg.payload == \"54.4\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 52, 215, 89, 13]) :\n                (msg.payload == \"54.5\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 53, 199, 120, 13]) :\n                (msg.payload == \"54.6\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 54, 247, 27, 13]) :\n                (msg.payload == \"54.7\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 55, 231, 58, 13]) :\n                (msg.payload == \"54.8\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 56, 22, 213, 13]) :\n                (msg.payload == \"54.9\") ? new Buffer([80, 66, 70, 84, 53, 52, 46, 57, 111, 64]) :\n                (msg.payload == \"55.0\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 48, 160, 237, 13]) :\n                (msg.payload == \"55.1\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 49, 176, 204, 13]) :\n                (msg.payload == \"55.2\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 50, 128, 175, 13]) :\n                (msg.payload == \"55.3\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 51, 144, 142, 13]) :\n                (msg.payload == \"55.4\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 52, 224, 105, 13]) :\n                (msg.payload == \"55.5\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 53, 240, 72, 13]) :\n                (msg.payload == \"55.6\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 54, 192, 43, 13]) :\n                (msg.payload == \"55.7\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 55, 208, 10, 13]) :\n                (msg.payload == \"55.8\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 56, 33, 229, 13]) :\n                (msg.payload == \"55.9\") ? new Buffer([80, 66, 70, 84, 53, 53, 46, 57, 49, 196, 13]) :\n                (msg.payload == \"56.0\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 48, 249, 189, 13]) :\n                (msg.payload == \"56.1\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 49, 233, 156, 13]) :\n                (msg.payload == \"56.2\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 50, 217, 255, 13]) :\n                (msg.payload == \"56.3\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 51, 201, 222, 13]) :\n                (msg.payload == \"56.4\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 52, 185, 57, 13]) :\n                (msg.payload == \"56.5\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 53, 169, 24, 13]) :\n                (msg.payload == \"56.6\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 54, 153, 123, 13]) :\n                (msg.payload == \"56.7\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 55, 137, 90, 13]) :\n                (msg.payload == \"56.8\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 56, 120, 181, 13]) :\n                (msg.payload == \"56.9\") ? new Buffer([80, 66, 70, 84, 53, 54, 46, 57, 104, 148, 13]) :\n                (msg.payload == \"57.0\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 48, 206, 141, 13]) :\n                (msg.payload == \"57.1\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 49, 222, 172, 13]) :\n                (msg.payload == \"57.2\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 50, 238, 207, 13]) :\n                (msg.payload == \"57.3\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 51, 254, 238, 13]) :\n                (msg.payload == \"57.4\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 52, 142, 9, 13]) :\n                (msg.payload == \"57.5\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 53, 158, 40, 13]) :\n                (msg.payload == \"57.6\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 54, 174, 75, 13]) :\n                (msg.payload == \"57.7\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 55, 190, 106, 13]) :\n                (msg.payload == \"57.8\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 56, 79, 133, 13]) :\n                (msg.payload == \"57.9\") ? new Buffer([80, 66, 70, 84, 53, 55, 46, 57, 95, 164, 13]) :\n                (msg.payload == \"58.0\") ? new Buffer([80, 66, 70, 84, 53, 56, 46, 48, 226, 188, 13]) :\n                msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 29\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '29') {\n\n        msg.voltronicNum = i;\n        \n        //option remplace\n        msg.payload = (msg.payload == \"21.0\") ? new Buffer([80,83,68,86,50,49,46,48,109,217,13]) :\n                (msg.payload == \"21.1\") ? new Buffer([80,83,68,86,50,49,46,49,125,248,13]) :\n                (msg.payload == \"21.2\") ? new Buffer([80,83,68,86,50,49,46,50,77,155,13]) :\n                (msg.payload == \"21.3\") ? new Buffer([80,83,68,86,50,49,46,51,93,186,13]) :\n                (msg.payload == \"21.4\") ? new Buffer([80,83,68,86,50,49,46,52,45,93,13]) :\n                (msg.payload == \"21.5\") ? new Buffer([80,83,68,86,50,49,46,53,61,124,13]) :\n                (msg.payload == \"21.6\") ? new Buffer([80,83,68,86,50,49,46,54,209,240]) :\n                (msg.payload == \"21.7\") ? new Buffer([80,83,68,86,50,49,46,55,29,62,13]) :\n                (msg.payload == \"21.8\") ? new Buffer([80,83,68,86,50,49,46,56,236,209,13]) :\n                (msg.payload == \"21.9\") ? new Buffer([80,83,68,86,50,49,46,57,252,240,13]) :\n                (msg.payload == \"22.0\") ? new Buffer([80,83,68,86,50,50,46,48,52,137,13]) :\n                (msg.payload == \"22.1\") ? new Buffer([80,83,68,86,50,50,46,49,36,168,13]) :\n                (msg.payload == \"22.2\") ? new Buffer([80,83,68,86,50,50,46,50,20,203,13]) :\n                (msg.payload == \"22.3\") ? new Buffer([80,83,68,86,50,50,46,51,78,160]) :\n                (msg.payload == \"22.4\") ? new Buffer([80,83,68,86,50,50,46,52,116,13,13]) :\n                (msg.payload == \"22.5\") ? new Buffer([80,83,68,86,50,50,46,53,100,44,13]) :\n                (msg.payload == \"22.6\") ? new Buffer([80,83,68,86,50,50,46,54,84,79,13]) :\n                (msg.payload == \"22.7\") ? new Buffer([80,83,68,86,50,50,46,55,68,110,13]) :\n                (msg.payload == \"22.8\") ? new Buffer([80,83,68,86,50,50,46,56,181,129,13]) :\n                (msg.payload == \"22.9\") ? new Buffer([80,83,68,86,50,50,46,57,165,160,13]) :\n                (msg.payload == \"23.0\") ? new Buffer([80,83,68,86,50,51,46,48,59,144]) :\n                (msg.payload == \"23.1\") ? new Buffer([80,83,68,86,50,51,46,49,19,152,13]) :\n                (msg.payload == \"23.2\") ? new Buffer([80,83,68,86,50,51,46,50,35,251,13]) :\n                (msg.payload == \"23.3\") ? new Buffer([80,83,68,86,50,51,46,51,51,218,13]) :\n                (msg.payload == \"23.4\") ? new Buffer([80,83,68,86,50,51,46,52,67,61,13]) :\n                (msg.payload == \"23.5\") ? new Buffer([80,83,68,86,50,51,46,53,83,28,13]) :\n                (msg.payload == \"23.6\") ? new Buffer([80,83,68,86,50,51,46,54,99,127,13]) :\n                (msg.payload == \"23.7\") ? new Buffer([80,83,68,86,50,51,46,55,115,94,13]) :\n                (msg.payload == \"23.8\") ? new Buffer([80,83,68,86,50,51,46,56,130,177,13]) :\n                (msg.payload == \"23.9\") ? new Buffer([80,83,68,86,50,51,46,57,146,144,13]) :\n                (msg.payload == \"24.0\") ? new Buffer([80,83,68,86,50,52,46,48,134,41,13]) :\n                (msg.payload == \"42.0\") ? new Buffer([80,83,68,86,52,50,46,48,19,16,13]) :\n                (msg.payload == \"42.1\") ? new Buffer([80,83,68,86,52,50,46,49,51,16]) :\n                (msg.payload == \"42.2\") ? new Buffer([80,83,68,86,52,50,46,50,51,82,13]) :\n                (msg.payload == \"42.3\") ? new Buffer([80,83,68,86,52,50,46,51,35,115,13]) :\n                (msg.payload == \"42.4\") ? new Buffer([80,83,68,86,52,50,46,52,83,148,13]) :\n                (msg.payload == \"42.5\") ? new Buffer([80,83,68,86,52,50,46,53,67,181,13]) :\n                (msg.payload == \"42.6\") ? new Buffer([80,83,68,86,52,50,46,54,115,214,13]) :\n                (msg.payload == \"42.7\") ? new Buffer([80,83,68,86,52,50,46,55,99,247,13]) :\n                (msg.payload == \"42.8\") ? new Buffer([80,83,68,86,52,50,46,56,146,24,13]) :\n                (msg.payload == \"42.9\") ? new Buffer([80,83,68,86,52,50,46,57,130,57,13]) :\n                (msg.payload == \"43.0\") ? new Buffer([80,83,68,86,52,51,46,48,36,32,13]) :\n                (msg.payload == \"43.1\") ? new Buffer([80,83,68,86,52,51,46,49,52,1,13]) :\n                (msg.payload == \"43.2\") ? new Buffer([80,83,68,86,52,51,46,50,70,32]) :\n                (msg.payload == \"43.3\") ? new Buffer([80,83,68,86,52,51,46,51,20,67,13]) :\n                (msg.payload == \"43.4\") ? new Buffer([80,83,68,86,52,51,46,52,100,164,13]) :\n                (msg.payload == \"43.5\") ? new Buffer([80,83,68,86,52,51,46,53,116,133,13]) :\n                (msg.payload == \"43.6\") ? new Buffer([80,83,68,86,52,51,46,54,68,230,13]) :\n                (msg.payload == \"43.7\") ? new Buffer([80,83,68,86,52,51,46,55,84,199,13]) :\n                (msg.payload == \"43.8\") ? new Buffer([80,83,68,86,52,51,46,56,165,40,13]) :\n                (msg.payload == \"43.9\") ? new Buffer([80,83,68,86,52,51,46,57,181,9,13]) :\n                (msg.payload == \"44.0\") ? new Buffer([80,83,68,86,52,52,46,48,161,176,13]) :\n                (msg.payload == \"44.1\") ? new Buffer([80,83,68,86,52,52,46,49,177,145,13]) :\n                (msg.payload == \"44.2\") ? new Buffer([80,83,68,86,52,52,46,50,129,242,13]) :\n                (msg.payload == \"44.3\") ? new Buffer([80,83,68,86,52,52,46,51,145,211,13]) :\n                (msg.payload == \"44.4\") ? new Buffer([80,83,68,86,52,52,46,52,225,52,13]) :\n                (msg.payload == \"44.5\") ? new Buffer([80,83,68,86,52,52,46,53,241,21,13]) :\n                (msg.payload == \"44.6\") ? new Buffer([80,83,68,86,52,52,46,54,193,118,13]) :\n                (msg.payload == \"44.7\") ? new Buffer([80,83,68,86,52,52,46,55,209,87,13]) :\n                (msg.payload == \"44.8\") ? new Buffer([80,83,68,86,52,52,46,56,32,184,13]) :\n                (msg.payload == \"44.9\") ? new Buffer([80,83,68,86,52,52,46,57,48,153,13]) :\n                (msg.payload == \"45.0\") ? new Buffer([80,83,68,86,52,53,46,48,150,128,13]) :\n                (msg.payload == \"45.1\") ? new Buffer([80,83,68,86,52,53,46,49,134,161,13]) :\n                (msg.payload == \"45.2\") ? new Buffer([80,83,68,86,52,53,46,50,182,194,13]) :\n                (msg.payload == \"45.3\") ? new Buffer([80,83,68,86,52,53,46,51,166,227,13]) :\n                (msg.payload == \"45.4\") ? new Buffer([80,83,68,86,52,53,46,52,214,4,13]) :\n                (msg.payload == \"45.5\") ? new Buffer([80,83,68,86,52,53,46,53,198,37,13]) :\n                (msg.payload == \"45.6\") ? new Buffer([80,83,68,86,52,53,46,54,246,70,13]) :\n                (msg.payload == \"45.7\") ? new Buffer([80,83,68,86,52,53,46,55,230,103,13]) :\n                (msg.payload == \"45.8\") ? new Buffer([80,83,68,86,52,53,46,56,23,136,13]) :\n                (msg.payload == \"45.9\") ? new Buffer([80,83,68,86,52,53,46,57,122,144]) :\n                (msg.payload == \"46.0\") ? new Buffer([80,83,68,86,52,54,46,48,207,208,13]) :\n                (msg.payload == \"46.1\") ? new Buffer([80,83,68,86,52,54,46,49,223,241,13]) :\n                (msg.payload == \"46.2\") ? new Buffer([80,83,68,86,52,54,46,50,239,146,13]) :\n                (msg.payload == \"46.3\") ? new Buffer([80,83,68,86,52,54,46,51,255,179,13]) :\n                (msg.payload == \"46.4\") ? new Buffer([80,83,68,86,52,54,46,52,143,84,13]) :\n                (msg.payload == \"46.5\") ? new Buffer([80,83,68,86,52,54,46,53,159,117,13]) :\n                (msg.payload == \"46.6\") ? new Buffer([80,83,68,86,52,54,46,54,175,22,13]) :\n                (msg.payload == \"46.7\") ? new Buffer([80,83,68,86,52,54,46,55,191,55,13]) :\n                (msg.payload == \"46.8\") ? new Buffer([80,83,68,86,52,54,46,56,78,216,13]) :\n                (msg.payload == \"46.9\") ? new Buffer([80,83,68,86,52,54,46,57,94,249,13]) :\n                (msg.payload == \"47.0\") ? new Buffer([80,83,68,86,52,55,46,48,248,224,13]) :\n                (msg.payload == \"47.1\") ? new Buffer([80,83,68,86,52,55,46,49,232,193,13]) :\n                (msg.payload == \"47.2\") ? new Buffer([80,83,68,86,52,55,46,50,216,162,13]) :\n                (msg.payload == \"47.3\") ? new Buffer([80,83,68,86,52,55,46,51,200,131,13]) :\n                (msg.payload == \"47.4\") ? new Buffer([80,83,68,86,52,55,46,52,184,100,13]) :\n                (msg.payload == \"47.5\") ? new Buffer([80,83,68,86,52,55,46,53,168,69,13]) :\n                (msg.payload == \"47.6\") ? new Buffer([80,83,68,86,52,55,46,54,152,38,13]) :\n                (msg.payload == \"47.7\") ? new Buffer([80,83,68,86,52,55,46,55,136,7,13]) :\n                (msg.payload == \"47.8\") ? new Buffer([80,83,68,86,52,55,46,56,121,232,13]) :\n                (msg.payload == \"47.9\") ? new Buffer([80,83,68,86,52,55,46,57,105,201,13]) :\n                (msg.payload == \"48.0\") ? new Buffer([80,83,68,86,52,56,46,48,212,209,13]) :\n                'Erreur';\n    }\n\n\n}\nnode.send(msg);","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":1040,"wires":[["1b601085884ce90b","35f0b0ecfdf45c73"]]},{"id":"0f8ef052cd286465","type":"function","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"Transformation des parametres","func":"if (msg.type == \"command\") {\n    node.send(msg);\n}\n\n//Si valeur est dif√©rent de NAK\nif (msg.payload != \"NAK\") {\n\n    /*--------------------------------------------------*/\n    //QPIRI Parametre\n    /*--------------------------------------------------*/\n    if (msg.type == \"qpiri\") {\n\n\n        /***********qmod **************/\n        let dir = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/qpiri_';\n\n        /*-------------------------------------------------*/\n        //parametre 01\n        /*-------------------------------------------------*/\n        if (msg.topic == dir + '16') {\n\n            let str = msg.payload;\n\n            //option remplace\n            msg.payload = (msg.payload == 0) ? msg.payload = \"UTI\" :\n                (msg.payload == 1) ? msg.payload = \"SOL\" :\n                    (msg.payload == 2) ? msg.payload = \"SBU\" :\n                        msg.payload;\n            node.send(msg);\n\n            /*-------------------------------------------------*/\n            //parametre 05\n            /*-------------------------------------------------*/\n        } else if (msg.topic == dir + '12') {\n\n            let str = msg.payload;\n\n            //option remplace\n            msg.payload = (msg.payload == 0) ? msg.payload = \"AGM\" :\n                (msg.payload == 1) ? msg.payload = \"Flooded\" :\n                    (msg.payload == 2) ? msg.payload = \"User\" :\n                        (msg.payload == 3) ? msg.payload = \"Pylon\" :\n                            (msg.payload == 5) ? msg.payload = \"Weco\" :\n                                (msg.payload == 6) ? msg.payload = \"Soltaro\" :\n                                    (msg.payload == 8) ? msg.payload = \"Lib\" :\n                                        (msg.payload == 9) ? msg.payload = \"Lic\" :\n                                            msg.payload;\n            node.send(msg);\n\n\n            /*-------------------------------------------------*/\n            //parametre 11\n            /*-------------------------------------------------*/\n        } else if (msg.topic == dir + '13') {\n\n            let count = msg.payload.length;\n            global.set('onduleurs.onduleur_' + msg.voltronicNum + '.param11_count', count)\n            //option remplace\n\n            node.send(msg);\n\n\n            /*-------------------------------------------------*/\n            //parametre 16\n            /*-------------------------------------------------*/\n        } else if (msg.topic == dir + '17') {\n\n            let str = msg.payload;\n\n            //option remplace\n            msg.payload = (msg.payload == 0) ? msg.payload = \"CUE\" :\n                (msg.payload == 1) ? msg.payload = \"CSO\" :\n                    (msg.payload == 2) ? msg.payload = \"SNU\" :\n                        (msg.payload == 3) ? msg.payload = \"OSO\" :\n                            msg.payload;\n\n            node.send(msg);\n\n\n        } else {\n\n            msg.payload = msg.payload;\n            msg.type = msg.type;\n            msg.topic = msg.topic;\n            node.send(msg);\n        }\n\n        /*--------------------------------------------------*/\n        //QMOD Mode solaire\n        /*--------------------------------------------------*/\n    } else if (msg.type == \"qmod\") {\n\n        /***********qmod **************/\n        let dir = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/qmod_';\n\n\n        /*-------------------------------------------------*/\n        //solar mode\n        /*-------------------------------------------------*/\n        if (msg.topic == dir + '0') {\n\n\n\n            //option remplace\n            msg.payload = (msg.payload == \"B\") ? msg.payload = \"solaire\" :\n                (msg.payload == \"L\") ? msg.payload = \"edf\" :\n                    (msg.payload == \"F\") ? msg.payload = \"Fault\" :\n                        (msg.payload == \"D\") ? msg.payload = \"Shutdown\" :\n                            (msg.payload == \"S\") ? msg.payload = \"Standby\" :\n                                (msg.payload == \"P\") ? msg.payload = \"Power\" :\n                                    msg.payload;\n\n            node.send(msg);\n\n\n\n        } else {\n\n            msg.payload = msg.payload;\n            msg.type = msg.type;\n            msg.topic = msg.topic;\n            node.send(msg);\n        }\n\n        /*--------------------------------------------------*/\n        // ‚ö†Ô∏è BLOC LED SUPPRIM√â - Passait de 130 lignes\n        /*--------------------------------------------------*/\n\n    } else if (msg.type == \"date\") {\n\n        /***********date **************/\n        let dir = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/date_';\n\n\n        /*-------------------------------------------------*/\n        //date\n        /*-------------------------------------------------*/\n        if (msg.topic == dir + '0') {\n\n            const valeurdate = msg.payload; // Ex. \"086137255\"\n\n            // Extraire les valeurs\n            const annee = parseInt(valeurdate.slice(0, 4), 10);\n            const mois = parseInt(valeurdate.slice(4, 6), 10);\n            const jour = parseInt(valeurdate.slice(6, 8), 10);\n            const heure = parseInt(valeurdate.slice(8, 10), 10);\n            const minute = parseInt(valeurdate.slice(10, 12), 10);\n            const seconde = parseInt(valeurdate.slice(12, 14), 10);\n\n            // Cr√©er l'objet JSON\n            msg.payload = {\n                \"date_temps\": jour + \"-\" + mois + \"-\" + annee + \" \" + heure + \":\" + minute + \":\" + seconde,\n                \"date\": jour + \"-\" + mois + \"-\" + annee,\n                \"temps\": heure + \":\" + minute + \":\" + seconde,\n                \"annee\": annee,\n                \"mois\": mois,\n                \"jour\": jour,\n                \"heure\": heure,\n                \"minute\": minute,\n                \"seconde\": seconde,\n\n            }\n\n            // Envoyer le message\n            node.send(msg);\n\n            //message date seul\n            let topic = msg.topic\n\n            msg.payload = jour + \"-\" + mois + \"-\" + annee;\n            msg.topic = topic + \"_date\"\n            node.send(msg);\n\n            //message heure seul\n            msg.payload = heure + \":\" + minute + \":\" + seconde;\n            msg.topic = topic + \"_heure\"\n            node.send(msg);\n\n\n\n\n\n        }\n\n        /*--------------------------------------------------*/\n        //QPIXS\n        /*--------------------------------------------------*/\n    } else if (msg.type == \"qpiws\") {\n\n        /***********qpiws **************/\n        let dir = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/qpiws_';\n\n\n        /*-------------------------------------------------*/\n        //Code erreur\n        /*-------------------------------------------------*/\n        if (msg.topic == dir + '0') {\n\n\n            msg.payload = msg.payload.split(''); //s√©paration de la valeur en tableau\n            let topic = msg.topic; // r√©cupere le topic \n\n            //garde l'erreur sous forme de tableau\n            let erreurtab = msg.payload;\n\n            //Cr√©ation d'un objet vide\n            let erreursObj = {}; //\n\n            //D√©finir chaque erreur\n            erreursObj[\"PV loss\"] = msg.payload[0] == 1;\n            erreursObj[\"Inverter fault\"] = msg.payload[1] == 1;\n            erreursObj[\"Bus Over\"] = msg.payload[2] == 1;\n            erreursObj[\"Bus Under\"] = msg.payload[3] == 1;\n            erreursObj[\"Bus Soft Fail\"] = msg.payload[4] == 1;\n            erreursObj[\"LINE_FAIL\"] = msg.payload[5] == 1;\n            erreursObj[\"OPVShort\"] = msg.payload[6] == 1;\n            erreursObj[\"Inverter voltage too low\"] = msg.payload[7] == 1;\n            erreursObj[\"Inverter voltage too high\"] = msg.payload[8] == 1;\n            erreursObj[\"Over temperature\"] = msg.payload[9] == 1;\n            erreursObj[\"Fan locked\"] = msg.payload[10] == 1;\n            erreursObj[\"Battery voltage high\"] = msg.payload[11] == 1;\n            erreursObj[\"Battery low alarm\"] = msg.payload[12] == 1;\n            erreursObj[\"Reserved_1\"] = msg.payload[13] == 1;\n            erreursObj[\"Battery under shutdown\"] = msg.payload[14] == 1;\n            erreursObj[\"Battery derating\"] = msg.payload[15] == 1;\n            erreursObj[\"Over load\"] = msg.payload[16] == 1;\n            erreursObj[\"Eeprom fault\"] = msg.payload[17] == 1;\n            erreursObj[\"Inverter Over Current\"] = msg.payload[18] == 1;\n            erreursObj[\"Inverter Soft Fail\"] = msg.payload[19] == 1;\n            erreursObj[\"Self Test Fail\"] = msg.payload[20] == 1;\n            erreursObj[\"OP DC Voltage Over\"] = msg.payload[21] == 1;\n            erreursObj[\"Bat Open\"] = msg.payload[22] == 1;\n            erreursObj[\"Current Sensor Fail\"] = msg.payload[23] == 1;\n            erreursObj[\"Reserved_2\"] = msg.payload[24] == 1;\n            erreursObj[\"Reserved_3\"] = msg.payload[25] == 1;\n            erreursObj[\"Reserved_4\"] = msg.payload[26] == 1;\n            erreursObj[\"Reserved_5\"] = msg.payload[27] == 1;\n            erreursObj[\"Reserved_6\"] = msg.payload[28] == 1;\n            erreursObj[\"Reserved_7\"] = msg.payload[29] == 1;\n            erreursObj[\"Reserved_8\"] = msg.payload[30] == 1;\n            erreursObj[\"Battery weak\"] = msg.payload[31] == 1;\n            erreursObj[\"Reserved_9\"] = msg.payload[32] == 1;\n            erreursObj[\"Reserved_10\"] = msg.payload[33] == 1;\n            erreursObj[\"Reserved_11\"] = msg.payload[34] == 1;\n            erreursObj[\"Battery equalization\"] = msg.payload[35] == 1;\n\n            // Cr√©ation d'un tableau d'erreurs pour affichage\n            let erreurs = Object.keys(erreursObj).filter(key => erreursObj[key]);\n\n            // Si erreur on les affiches\n            if (erreurs.length > 0) {\n                msg.payload = erreurs.join(\", \");\n\n                //sinon il y a aucune erreur\n            } else {\n                msg.payload = \"Aucune erreur\";\n            }\n\n            node.send(msg);\n\n            //on fait un json pour les attributs\n            msg.topic = topic + \"_attrib\"\n            msg.payload = erreursObj;\n            node.send(msg);\n\n            //ici on envoie sous forme de tableau\n            msg.payload = erreurtab;\n            msg.topic = topic + \"_code\"\n            node.send(msg);\n\n\n\n        }\n\n\n\n        /*--------------------------------------------------*/\n        //QPGS v√©rification multi onduleur\n        /*--------------------------------------------------*/\n    } else if (msg.type.slice(0, -1) == \"qpgs\") {\n\n        // Chemin du qpgs\n        let dir = global.get(\"parametre.mqtt.DirSmart\") + '/' + global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".type\") + '_' + msg.voltronicNum + '/qpgs';\n\n        //bouble de 8 onduleurs\n        for (let i = 1; i <= 8; i++) {\n\n            //qpgsx_0. si onduleur existe\n            if (msg.topic == dir + i + '_0') {\n\n                //si existe est 1, sinon 0\n                if (msg.payload == 1) {\n\n                    node.send(msg)\n                    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + '.qpgs_' + i, true); //ajout XqpgsX (numonduleur + qpgs + numQPGS) existe\n\n\n                } else if (msg.topic == dir + '1_0') {\n\n                    node.send(msg)\n                    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + '.qpgs_' + i, true); //ajout XqpgsX (numonduleur + qpgs + numQPGS) existe\n\n                } else {\n                    node.send(msg)\n                    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + '.qpgs_' + i, false); //ajout XqpgsX (numonduleur + qpgs + numQPGS) existe\n\n                }\n\n                //qpgsX_2 mode solaire\n            } else if (msg.topic == dir + i + '_2') {\n\n                //option remplace\n                msg.payload = (msg.payload == \"B\") ? msg.payload = \"solaire\" :\n                    (msg.payload == \"L\") ? msg.payload = \"edf\" :\n                        (msg.payload == \"F\") ? msg.payload = \"Fault\" :\n                            (msg.payload == \"D\") ? msg.payload = \"Shutdown\" :\n                                (msg.payload == \"S\") ? msg.payload = \"Standby\" :\n                                    (msg.payload == \"P\") ? msg.payload = \"Power\" :\n                                        msg.payload;\n\n                node.send(msg);\n\n                //Autre valeur si bon onduleur\n            } else if (msg.topic.slice(0, -2) == dir + i) {\n\n                node.send(msg)\n\n            }\n\n\n        }\n\n        //on envoie les autres valeurs\n    } else {\n\n        msg.payload = msg.payload;\n        msg.type = msg.type;\n        msg.topic = msg.topic;\n        node.send(msg);\n    }\n\n    //si qpigs2 est egal √† nak\n} else if (msg.type == \"qpigs2\" && msg.payload == \"NAK\") {\n\n    //ajout NAK au global a suppr\n    //global.set(msg.type, msg.payload);\n\n    //futur config\n    global.set('onduleurs.onduleur_' + msg.voltronicNum + '.' + msg.type, msg.payload);\n    msg.payload = msg.payload;\n    msg.type = msg.type;\n    msg.topic = msg.topic;\n    node.send(msg);\n\n    // si qpgs1 est √©gal √† nak\n} else if (msg.type == \"qpgs1\" && msg.payload == \"NAK\") {\n\n    //ajout NAK au global\n    global.set(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_1\", false);\n\n    //sinon on fait rien\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":820,"wires":[["1f82fe719a9f5c56"]]},{"id":"35f0b0ecfdf45c73","type":"debug","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"debug 106","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1010,"y":1040,"wires":[]},{"id":"3b2067bc6f66ea6f","type":"function","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"debug","func":"\nlet debug = global.get(\"parametre.config.debug\"); ;\n\nif(debug == true){\n\n    var now = new Date();\n\n    var annee   = now.getFullYear();\n    var mois    = now.getMonth() + 1;\n    var jour    = now.getDate();\n    var heure   = now.getHours();\n    var minute  = now.getMinutes();\n    var seconde = now.getSeconds();\n\n    \n    \n    let date = jour + '/' + mois + '/' + annee + ', ' + heure + ':' + minute + ':' + seconde;\n\n    //msg.payload = date + ', ' + msg.topic + ', voltronic_' + msg.voltronicNum  + ', ' + msg.payload;\n    msg.payload = msg.topic + ', voltronic_' + msg.voltronicNum  + ', ' + msg.payload;\n    node.log(msg.payload);\n\n\n  \n\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":740,"wires":[[]]},{"id":"40a3c6d2dc446b56","type":"link in","z":"23fac679e003f079","name":"To-serial-in","links":["1b601085884ce90b","963af7f967767a27","6544a153845b273e"],"x":65,"y":460,"wires":[["b01cec38f67be502"]]},{"id":"3b47f0fb176cb423","type":"mqtt in","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"mqtt in dynamique","topic":"","qos":"2","datatype":"auto-detect","broker":"2f656901c2de4368","nl":false,"rap":true,"rh":0,"inputs":1,"x":510,"y":1040,"wires":[["2c30668d470b346d"]]},{"id":"02baa04c535d3b8b","type":"inject","z":"23fac679e003f079","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":1120,"wires":[["9b3c16fbb7384228"]]},{"id":"9b3c16fbb7384228","type":"function","z":"23fac679e003f079","name":"Test une commande","func":"// Commande POP00; Buffer = 80,79,80,48,48,194,72,13\n// Commande POP01; Buffer = 80,79,80,48,49,210,105,13\n// Commande POP02; Buffer = 80,79,80,48,50,226,11,13\n\n\n\nlet command = \"POP02\"; //Commande\n\n// Encode la commande en HEX\nlet commandHex = Buffer.from(command).toString('hex'); \n\nmsg.payload = Buffer.from(command, \"hex\");\nnode.send(msg);\n\n//Utilise la funtion de conversion crc16 Xmodem\nmsg.payload = crc16(command).toString(16); \nnode.send(msg);\n\n// Commande en hex + calcul crc et ajoute le retour chariot a la fin (0D = 13)\nmsg.payload = commandHex + crc16(command).toString(16) + \"0D\"; \n\n\n// Transformation de la chaine de caractere en Buffer\nmsg.payload = Buffer.from(msg.payload, \"hex\");\nnode.send(msg);\n\n//Fonction de calcul crc16 XModem\nfunction crc16(str, crc = 0, xorout = 0) {\n    for(let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return crc ^ xorout;\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":1120,"wires":[["9feb44127bd89992"]]},{"id":"9feb44127bd89992","type":"debug","z":"23fac679e003f079","name":"debug 181","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1010,"y":1120,"wires":[]},{"id":"2c30668d470b346d","type":"function","z":"23fac679e003f079","g":"507284d7df5c5d3a","name":"Futur fonction parametre ","func":"\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\n\n/********************* si ip *********************/\nfor (let i = 1; i <= count; i++) {\n\n    let dir = global.get(\"parametre.mqtt.DirSmart\") + '/Modification-voltronic/' + i + '/Param';\n    //let payload = '';\n    \n\n    /*-------------------------------------------------*/\n    //parametre 01\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '01') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"POP\";\n        //option remplace\n        msg.option = (msg.payload == \"UTI\") ? \"00\" :\n                     (msg.payload == \"SOL\") ? \"01\" :\n                     (msg.payload == \"SBU\") ? \"02\" :\n                     'Erreur';\n        msg.payload =  msg.option;\n        \n    }\n\n    /*-------------------------------------------------*/\n    //parametre 02\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '02') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"MNCHGC\";\n        //option remplace\n        msg.option =   (global.get(\"onduleurs.onduleur_\" + i + \".qpgs_1\") == false) ? msg.payload :\n                        \"0\" + msg.payload;\n\n    }\n    /*-------------------------------------------------*/\n    //parametre 05\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '05') {\n    \n        msg.voltronicNum = i;\n        \n        msg.command = \"PBT\";\n        //option remplace\n        msg.option = (msg.payload == \"AGM\") ? \"00\" :\n                    (msg.payload == \"Flooded\") ? \"01\" :\n                    (msg.payload == \"User\") ? \"02\" :\n                    (msg.payload == \"Pylon\") ? \"03\" :\n                    (msg.payload == \"Weco\") ? \"05\" :\n                    (msg.payload == \"Soltaro\") ? \"06\" :\n                    (msg.payload == \"Lib\") ? \"08\" :\n                    (msg.payload == \"Lic\") ? \"09\" :\n                    'Erreur';\n        msg.payload = msg.option;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 11\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '11') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"MUCHGC\";\n        //option remplace\n        if (global.get(\"onduleurs.onduleur_\" + i + \".qpgs_1\") === \"NAK\"){\n            msg.option =  msg.payload;\n        }else{\n            msg.option =  \"0\" + msg.payload;\n        }\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 12\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '12') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBCV\";\n        //option remplace\n\n        let payload = msg.payload.toString();\n        // V√©rifier si la longueur de la cha√Æne est 2 (par exemple \"49\")\n        if (payload.length === 2) {\n            // Ajouter \".0\" √† la fin de la cha√Æne\n            msg.option = payload + \".0\";\n        } else {\n            // Si ce n'est pas une valeur de deux caract√®res, on laisse tel quel\n            msg.option = payload;\n        }\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 13\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '13') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBDV\";\n        \n        //option remplace\n        let payload = msg.payload.toString();\n        // V√©rifier si la longueur de la cha√Æne est 2 (par exemple \"49\")\n        if (payload.length === 2) {\n            // Ajouter \".0\" √† la fin de la cha√Æne\n            msg.option = payload + \".0\";\n        } else {\n            // Si ce n'est pas une valeur de deux caract√®res, on laisse tel quel\n            msg.option = payload;\n        }\n        \n    }\n\n    /*-------------------------------------------------*/\n    //parametre 16\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '16') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PCP\";\n        //option remplace\n        msg.option = (msg.payload == \"CSO\") ? \"01\" :\n                    (msg.payload == \"SNU\") ? \"02\" :\n                    (msg.payload == \"OSO\") ? \"03\" :\n                    'Erreur';\n        msg.payload = msg.option;\n\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 26\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '26') {\n\n        \n        //option remplace\n        msg.voltronicNum = i;\n        \n        msg.command = \"PCVV\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 27\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '27') {\n\n        msg.voltronicNum = i;\n\n        msg.command = \"PBFT\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 29\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '29') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PSDV\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre Date\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + 'Date') {\n\n        msg.voltronicNum = i;\n        const now = new Date();\n\n        const year = String(now.getFullYear()).slice(-2); // Derniers 2 chiffres de l'ann√©e\n        const month = String(now.getMonth() + 1).padStart(2, '0'); // Mois (0-11 donc +1)\n        const day = String(now.getDate()).padStart(2, '0'); // Jour\n        const hours = String(now.getHours()).padStart(2, '0'); // Heures\n        const minutes = String(now.getMinutes()).padStart(2, '0'); // Minutes\n        const seconds = String(now.getSeconds()).padStart(2, '0'); // Secondes\n\n        msg.command = \"DAT\";\n        msg.option = year + month + day + hours + minutes + seconds ;\n        \n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre  Set battery re-charge capacity\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + 'qdop8') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBCC\";\n\n        msg.payload = msg.payload.toString();\n\n        if (msg.payload.length === 1) {\n            // Si 1 caract√®re, ajoute deux 00 devant\n            msg.payload = \"00\" + msg.payload;\n        } else if (msg.payload.length === 2) {\n            // Si 2 caract√®res,  un 0 devant\n            msg.payload = \"0\" + msg.payload;\n        }\n        //option remplace\n        msg.option = msg.payload;\n\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre Set battery re-discharge capacity\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + 'qdop9') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBDC\";\n        msg.payload = msg.payload.toString();\n\n        if (msg.payload.length === 1) {\n            // Si 1 caract√®re, ajoute deux 00 devant\n            msg.payload = \"00\" + msg.payload;\n        } else if (msg.payload.length === 2) {\n            // Si 2 caract√®res,  un 0 devant\n            msg.payload = \"0\" + msg.payload;\n        }\n        //option remplace\n        msg.option = msg.payload;\n        \n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre Set battery re-discharge capacity\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + 'qdop10') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PSDC\";\n        \n        msg.payload = msg.payload.toString();\n\n        if (msg.payload.length === 1) {\n            // Si 1 caract√®re, ajoute deux 00 devant\n            msg.payload = \"00\" + msg.payload;\n        } else if (msg.payload.length === 2) {\n            // Si 2 caract√®res,  un 0 devant\n            msg.payload = \"0\" + msg.payload;\n        }\n        //option remplace\n        msg.option = msg.payload;\n\n    }\n\n    /*-------------------------------------------------*/\n    //Autre (commande manuel)\n    /*-------------------------------------------------*/\n\n    if (msg.topic == dir + 'Com') {\n\n        msg.voltronicNum = i;\n        msg.topic = \"command\";\n        msg.command = msg.payload;\n        msg.option = '';\n    }\n}\n\n\nlet command = msg.command + msg.option ; //Commande a envoyer\nmsg.payload = command;\n\n// Encode la commande en HEX\nlet commandHex = Buffer.from(command).toString('hex'); \n\n// Commande en hex + calcul crc et ajoute le retour chariot a la fin\nmsg.payload = commandHex + crc16(command).toString(16) + \"0D\"; \n\n// Transformation de la chaine de caractere en Buffer\n//msg.topic = \"false\";\nmsg.payload = Buffer.from(msg.payload, \"hex\");\nnode.send(msg);\n\n/****************************************** */\n//Evoyer un QPIRI, QDOP ou un QLED pour rafraichir les valeurs\n/****************************************** */\n// Liste des commandes LED\nconst commandesLED = [\"PLEDE\", \"PLEDB\", \"PLEDM\", \"PLEDC1\", \"PLEDC2\"];\nconst commandesQDOP = [\"PBCC\", \"PBDC\", \"PSDC\"];\n\n// Sauvegarde du voltronicNum\nlet voltronicNumLocal = msg.voltronicNum;\n\n// D√©terminer le topic et la commande √† envoyer\nlet topicRefresh, commandToSend;\n\nif (commandesLED.includes(msg.command)) {\n    topicRefresh = \"qled\";\n    commandToSend = \"QLED\";\n} else if (commandesQDOP.includes(msg.command)) {\n    topicRefresh = \"qdop\";\n    commandToSend = \"QDOP\"; \n} else {\n    topicRefresh = \"qpiri\";\n    commandToSend = \"QPIRI\"; \n}\n\n// Timer 1 seconde pour envoyer le message\nsetTimeout(() => {\n    // Calcul CRC correct sur la commande ASCII\n    let commandHex = Buffer.from(commandToSend).toString('hex'); \n    msg.payload = commandHex + crc16(command).toString(16) + \"0D\"; \n    msg.topic = topicRefresh;\n    msg.payload = Buffer.from(msg.payload, \"hex\");\n\n    node.send(msg);\n}, 1000);\n\n\n\n\n\n//Fonction de calcul crc16 XModem\nfunction crc16(str, crc = 0, xorout = 0) {\n    for(let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return crc ^ xorout;\n}\n\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":1000,"wires":[["1b601085884ce90b","35f0b0ecfdf45c73"]]},{"id":"51cd001b037a10fa","type":"function","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"V√©rification","func":"\nif (msg.payload == undefined) {\n    msg.payload = \"[warning] La valeur r√©cup√©r√©e sur l'onduleur n¬∞\" + msg.voltronicNum + \" n'est pas au bon format. Si l'erreur persiste, v√©rifiez votre c√¢blage.\";\n    \n    node.send([msg,msg]);\n\n}else{\n    \n    let premierCaractere = msg.payload[0];\n\n    if (premierCaractere == \"(\"){\n        msg.pass = msg.topic + \"_pass\"\n        node.send([msg,]);\n    }else{\n        msg.payload = \"[warning] L'onduleur n¬∞\" + msg.voltronicNum + \" ne r√©cup√®re pas le bon format, v√©rifiez votre c√¢blage.\";\n        if (msg.topic == \"qpig\") {\n            msg.topic = \"erreur\";\n            node.send([,msg ]);\n        \n        }\n    }\n\n}\n\nif (msg.status == \"ERR_TIMEOUT\") {\n    node.warn(\"[Error] Votre communication sur l'onduleur n¬∞ \" + msg.voltronicNum + \" est en timeOut. Augmentez votre intervalle de temps de communication.\");\n    return null;\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":780,"wires":[["3b2067bc6f66ea6f","cc8cf2352fce7583","aee9639d9e60f5e8","560db185d5319340"],["2c3ddb001437c672"]]},{"id":"2c3ddb001437c672","type":"debug","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"erreur","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":400,"y":860,"wires":[]},{"id":"2b05956ffa6b4a84","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"Requete","func":"/* QPIGS */\nif (msg.pass === \"date_pass\") {\n    msg.topic = \"qpig\";\n    msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QMOD */\nif (msg.pass === \"qpig_pass\") {\n    msg.topic = \"qmod\";\n    msg.payload = createMessage(\"QMOD\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QDI */\nif (msg.pass === \"qmod_pass\") {\n    msg.topic = \"qdi\";\n    msg.payload = createMessage(\"QDI\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QPIWS */\nif (msg.pass === \"qdi_pass\") {\n    msg.topic = \"qpiws\";\n    msg.payload = createMessage(\"QPIWS\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QFLAG */\nlet compteurQFLAG = flow.get(\"compteurQFLAG_\" + msg.voltronicNum) || 0;\n\nif (msg.pass === \"qpiws_pass\") {\n    compteurQFLAG++;\n    flow.set(\"compteurQFLAG_\" + msg.voltronicNum, compteurQFLAG);\n\n    if (compteurQFLAG >= 10) {\n        flow.set(\"compteurQFLAG_\" + msg.voltronicNum, 0);\n        msg.topic = \"qflag\";\n        msg.payload = createMessage(\"QFLAG\", msg.voltronicNum);\n        node.send(msg);\n    } else {\n        msg.pass = \"qflag_pass\";\n    }\n}\n\n/* QPIRI - Parametre */\nlet compteurQPIRI = flow.get(\"compteurQPIRI_\" + msg.voltronicNum) || 0;\n\nif (msg.pass === \"qflag_pass\") {\n    compteurQPIRI++;\n    flow.set(\"compteurQPIRI_\" + msg.voltronicNum, compteurQPIRI);\n\n    if (compteurQPIRI >= 10) {\n        flow.set(\"compteurQPIRI_\" + msg.voltronicNum, 0);\n        msg.topic = \"qpiri\";\n        msg.payload = createMessage(\"QPIRI\", msg.voltronicNum);\n        node.send(msg);\n    } else {\n        msg.pass = \"qpiri_pass\";\n    }\n}\n\n/* QMUCHGCR - Parametre */\nif (msg.pass === \"qpiri_pass\") {\n    let compteurQMCHGCR = flow.get(\"compteurQMCHGCR_\" + msg.voltronicNum) || 0;\n    \n    compteurQMCHGCR++;\n    flow.set(\"compteurQMCHGCR_\" + msg.voltronicNum, compteurQMCHGCR);\n\n    if (compteurQMCHGCR >= 10) {\n        flow.set(\"compteurQMCHGCR_\" + msg.voltronicNum, 0);\n\n        if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qmchgcr') !== \"NAK\") {\n            msg.topic = \"qmchgcr\";\n            msg.payload = createMessage(\"QMUCHGCR\", msg.voltronicNum);\n            node.send(msg);\n        } else if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qmchgcr') === \"NAK\") {\n            msg.topic = \"qmchgcr\";\n            msg.payload = createMessage(\"QMCHGCR\", msg.voltronicNum);\n            node.send(msg);\n        } else {\n            msg.pass = \"qmchgcr_pass\";\n        }\n    } else {\n        msg.pass = \"qmchgcr_pass\";\n    }\n}\n\n/* QDOP - Parametre */\nif (msg.pass === \"qmchgcr_pass\") {\n    let compteurQDOP = flow.get(\"compteurQDOP_\" + msg.voltronicNum) || 0;\n\n    if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qdop') !== \"NAK\") {\n        compteurQDOP++;\n        flow.set(\"compteurQDOP_\" + msg.voltronicNum, compteurQDOP);\n\n        if (compteurQDOP >= 10) {\n            flow.set(\"compteurQDOP_\" + msg.voltronicNum, 0);\n            msg.topic = \"qdop\";\n            msg.payload = createMessage(\"QDOP\", msg.voltronicNum);\n            node.send(msg);\n        } else {\n            msg.pass = \"qdop_pass\";\n        }\n    } else {\n        msg.pass = \"qdop_pass\";\n    }\n}\n\n/* ==================== √âNERGIES RAPIDES (Jour uniquement) ==================== */\n\n/* QED - √ânergie PV du jour */\nif (msg.pass === \"qdop_pass\") {\n    let compteurQED = flow.get(\"compteurQED_\" + msg.voltronicNum) || 0;\n    \n    compteurQED++;\n    flow.set(\"compteurQED_\" + msg.voltronicNum, compteurQED);\n    \n    // Lire QED toutes les 30 secondes (1 cycle)\n    if (compteurQED >= 1) {\n        flow.set(\"compteurQED_\" + msg.voltronicNum, 0);\n        \n        // G√©n√©rer date actuelle pour QED\n        const now = new Date();\n        const year = now.getFullYear().toString();\n        const month = (now.getMonth() + 1).toString().padStart(2, '0');\n        const day = now.getDate().toString().padStart(2, '0');\n        const dateStr = year + month + day;\n        \n        msg.topic = \"qed\";\n        msg.payload = createMessage(\"QED\" + dateStr, msg.voltronicNum);\n        msg.energieDate = dateStr;\n        node.send(msg);\n    } else {\n        msg.pass = \"qed_pass\";\n    }\n}\n\n/* QLD - √ânergie Load du jour */\nif (msg.pass === \"qed_pass\") {\n    let compteurQLD = flow.get(\"compteurQLD_\" + msg.voltronicNum) || 0;\n    \n    compteurQLD++;\n    flow.set(\"compteurQLD_\" + msg.voltronicNum, compteurQLD);\n    \n    // Lire QLD toutes les 30 secondes (1 cycle)\n    if (compteurQLD >= 1) {\n        flow.set(\"compteurQLD_\" + msg.voltronicNum, 0);\n        \n        const now = new Date();\n        const year = now.getFullYear().toString();\n        const month = (now.getMonth() + 1).toString().padStart(2, '0');\n        const day = now.getDate().toString().padStart(2, '0');\n        const dateStr = year + month + day;\n        \n        msg.topic = \"qld\";\n        msg.payload = createMessage(\"QLD\" + dateStr, msg.voltronicNum);\n        msg.energieDate = dateStr;\n        node.send(msg);\n    } else {\n        msg.pass = \"qld_pass\";\n    }\n}\n\n/* ==================== FIN √âNERGIES ==================== */\n// ‚ö†Ô∏è Mois, Ann√©e et Total sont lus au d√©marrage uniquement\n\n// Si full version on envoie aussi les commandes\nif (global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".full\") === false) {\n\n    if (msg.pass === \"qld_pass\") {\n        msg.topic = \"qpig\";\n        msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n        node.send(msg);\n    }\n\n} else {\n\n    /* QBEQI */\n    if (msg.pass === \"qld_pass\") {\n        msg.topic = \"qbeqi\";\n        msg.payload = createMessage(\"QBEQI\", msg.voltronicNum);\n        node.send(msg);\n    }\n\n    /* QPIGS2 - PV2 */\n    if (msg.pass === \"qbeqi_pass\") {\n        if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qpigs2') !== \"NAK\") {\n            msg.topic = \"qpigs2\";\n            msg.payload = createMessage(\"QPIGS2\", msg.voltronicNum);\n            node.send(msg);\n        } else {\n            msg.pass = \"qpigs2_pass\";\n        }\n    }\n\n    /* QT - Date */\n    // ‚ö†Ô∏è MODIFI√â: QLED supprim√©, passage direct de qpigs2_pass √† date\n    if (msg.pass === \"qpigs2_pass\") {\n        msg.topic = \"date\";\n        msg.payload = createMessage(\"QT\", msg.voltronicNum);\n        node.send(msg);\n    }\n\n}\n\nfunction createMessage(command, voltronicNum) {\n    // Encode la commande en HEX et ajoute le CRC\n    let commandHex = Buffer.from(command).toString('hex');\n    let crc = crc16(command).toString(16); // Calcul du CRC16\n    let messageHex = commandHex + crc + \"0D\"; // Ajout du CRC et du retour chariot\n    return Buffer.from(messageHex, \"hex\");\n}\n\n// Fonction de calcul CRC16 XModem\nfunction crc16(str, crc = 0, xorout = 0) {\n    for (let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return crc ^ xorout;\n}\n\nconst interval = 30000; // Utilise 2 minute par d√©faut\n\n// R√©cup√©rer le temps actuel\nconst currentTime = Date.now();\n\n// V√©rifier le temps de la derni√®re ex√©cution\nlet lastSent = flow.get(\"lastSentOnduleur\" + msg.voltronicNum) || 0;\n\n// Si le temps est supp√©rieur, envoie le message\nif (currentTime - lastSent >= interval) {\n    msg.payload = \"Alerte : Pas de mise √† jour re√ßue depuis plus de 2 minutes ! \" + msg.voltronicNum;\n    msg.topic = \"erreur\";\n    node.send([, msg]);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":60,"wires":[["6544a153845b273e"]]},{"id":"e0e8dda3858d970d","type":"link in","z":"23fac679e003f079","g":"c315db128200ad39","name":"retour requete","links":["560db185d5319340"],"x":615,"y":120,"wires":[["d14faaffe9623ee2"]]},{"id":"560db185d5319340","type":"link out","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"vers nouvel requete","mode":"link","links":["e0e8dda3858d970d"],"x":355,"y":700,"wires":[]},{"id":"b72693f388145808","type":"inject","z":"23fac679e003f079","g":"c315db128200ad39","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"pass","v":"date_pass","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"30","topic":"","payload":"","payloadType":"date","x":690,"y":40,"wires":[["e7d8b9a3ef633c6f"]]},{"id":"6544a153845b273e","type":"link out","z":"23fac679e003f079","g":"c315db128200ad39","name":"To-serial-ou","mode":"link","links":["40a3c6d2dc446b56"],"x":1085,"y":60,"wires":[]},{"id":"d14faaffe9623ee2","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"Temps d'attente","func":"// intervalle choisie par utilisateur\nlet interval = global.get(\"parametre.config.interval\"); // en secondes\nlet delayMs = interval * 1000;\n\n// temps de la derni√®re valeur\nlet lastTs = global.get(\"derniereValeur.timestamp_\" + msg.voltronicNum) || 0;\nlet now = Date.now();\n\n// on stop si la derniere valeur est trop rescente pour eviter plusieur boucle\nif ((now - lastTs) < delayMs) {\n    node.warn(\"Voltronic_\" + msg.voltronicNum + \" : Attente impos√©e pour √©viter une surcharge de requ√™tes.\");\n    return null;\n}\n\n// Mettre √† jour le le temps de la derni√®re valeur\nglobal.set(\"derniereValeur.timestamp_\" + msg.voltronicNum, now);\n\n// gestion ancienne valeur\nlet ancienneValeur = flow.get(\"ancienneValeur_\" + msg.voltronicNum);\n\nif (ancienneValeur !== msg.pass) {\n\n    // MAJ ancienne valeur\n    flow.set(\"ancienneValeur_\" + msg.voltronicNum, msg.pass);\n\n    // MAJ du timestamp interne\n    flow.set(\"dernierMessageTemps_\" + msg.voltronicNum, now);\n\n    // Reset de l'alerte\n    flow.set(\"alerteEnvoyee_\" + msg.voltronicNum, false);\n\n    // on enveoie si le delai est bon\n    setTimeout(() => {\n\n        // Mise √† jour de la date juste avant l'envoi\n        flow.set(\"dernierMessageTemps_\" + msg.voltronicNum, Date.now());\n\n        // Envoi du message\n        node.send(msg);\n\n    }, delayMs);\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":120,"wires":[["2b05956ffa6b4a84"]]},{"id":"d38feb3754bfe16a","type":"delay","z":"23fac679e003f079","g":"20319798fb911621","name":"1 msg / 0.5 [s]","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":480,"y":400,"wires":[["e1e94763050c5990"]]},{"id":"014f259b95c7699f","type":"delay","z":"23fac679e003f079","g":"20319798fb911621","name":"1 msg / 0.5 [s]","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":480,"y":460,"wires":[["f73f8d60181cb3ab"]]},{"id":"6eaf61501f158c84","type":"delay","z":"23fac679e003f079","g":"20319798fb911621","name":"1 msg / 0.5 [s]","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":480,"y":520,"wires":[["a136e3043da3957f"]]},{"id":"8710a130a740b04a","type":"delay","z":"23fac679e003f079","g":"20319798fb911621","name":"1 msg / 0.5 [s]","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":480,"y":580,"wires":[["27a565eacdb5c7fa"]]},{"id":"e7d8b9a3ef633c6f","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"true","func":"// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\");\n\nfor (let i = 1; i <= count; i++) {\n    //v√©rification si l'onduleur est voltronic\n    if (global.get(\"onduleurs.onduleur_\" + i + \".type\") == 'voltronic') {\n        msg.voltronicNum = i;\n        flow.set(\"dernierMessageTemps_\" + msg.voltronicNum, Date.now());\n        node.send(msg);\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":40,"wires":[["2b05956ffa6b4a84"]]},{"id":"b76bdfb2968680e4","type":"inject","z":"23fac679e003f079","g":"c315db128200ad39","name":"sans rep","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"30","crontab":"","once":true,"onceDelay":"60","topic":"","payload":"","payloadType":"date","x":680,"y":80,"wires":[["3dc894e5057e376a"]]},{"id":"3dc894e5057e376a","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"watchd","func":"// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\");\n\nfor (let i = 1; i <= count; i++) {\n    //v√©rification si l'onduleur est voltronic\n    if (global.get(\"onduleurs.onduleur_\" + i + \".type\") == 'voltronic') {\n        msg.voltronicNum = i;\n\n        // V√©rifier si la date a √©t√© mise √† jour\n        let tempsEcoule = Date.now() - flow.get(\"dernierMessageTemps_\" + msg.voltronicNum);\n\n        // V√©rifier si plus de 10 secondes se sont √©coul√©es et si l'alerte n'a pas d√©j√† √©t√© envoy√©e\n        if (tempsEcoule >= 10000) {\n            // Si 10 secondes se sont √©coul√©es et que la date n'a pas chang√©, envoyer un message\n            msg.pass = \"date_pass\";\n\n            flow.set(\"ancienneValeur_\" + msg.voltronicNum, msg.pass);\n            node.send(msg);\n        }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":80,"wires":[["2b05956ffa6b4a84","314bda3f05581f75"]]},{"id":"314bda3f05581f75","type":"debug","z":"23fac679e003f079","g":"c315db128200ad39","name":"debug 205","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"pass","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":120,"wires":[]},{"id":"62bfa1620ae32998","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"ancien Requete","func":"/* QPIGS */\n\nif (msg.pass === \"date_pass\") {\n    msg.topic = \"qpig\";\n    msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QMOD */\nif (msg.pass === \"qpig_pass\") {\n    msg.topic = \"qmod\";\n    msg.payload = createMessage(\"QMOD\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QPIWS */\nif (msg.pass === \"qmod_pass\") {\n    msg.topic = \"qpiws\";\n    msg.payload = createMessage(\"QPIWS\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QFLAG */\nif (msg.pass === \"qpiws_pass\") {\n    msg.topic = \"qflag\";\n    msg.payload = createMessage(\"QFLAG\", msg.voltronicNum); \n    node.send(msg);\n}\n\n/* QPIRI - Parametre */\nif (msg.pass === \"qflag_pass\") {\n    msg.topic = \"qpiri\";\n    msg.payload = createMessage(\"QPIRI\", msg.voltronicNum);\n    node.send(msg);\n}\n\n//si full version on envoie aussi les commandes\nif ( global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".full\") === false ){\n\n    if (msg.pass === \"qpiri_pass\") {\n        msg.topic = \"qpig\";\n        msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n        node.send(msg);\n    }\n\n} else {\n\n    /* QBEQI */\n    if (msg.pass === \"qpiri_pass\") {\n        msg.topic = \"qbeqi\";\n        msg.payload = createMessage(\"QBEQI\", msg.voltronicNum);\n        node.send(msg);\n    }\n\n    /* QPIGS2 - PV2 */\n    if (msg.pass === \"qbeqi_pass\") {\n        if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qpigs2') !== \"NAK\") {\n            msg.topic = \"qpigs2\";\n            msg.payload = createMessage(\"QPIGS2\", msg.voltronicNum);\n            node.send(msg);\n        } else {\n            msg.pass = \"qpigs2_pass\";\n        }\n    }\n\n    /* QLED Led */\n    if (msg.pass === \"qpigs2_pass\") {\n        if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qled') !== \"NAK\") {\n            msg.topic = \"qled\";\n            msg.payload = createMessage(\"QLED\", msg.voltronicNum);\n            node.send(msg);\n        } else {\n            msg.pass = \"qled_pass\";\n        }\n    }\n\n    /* QT - Date */\n    if (msg.pass === \"qled_pass\") {\n\n        if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qled') !== \"NAK\") {\n\n            msg.topic = \"date\";\n            msg.payload = createMessage(\"QT\", msg.voltronicNum);\n            node.send(msg);\n\n        } else {\n      \n            msg.topic = \"qpig\";\n            msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n            node.send(msg);\n            \n        }\n\n    }\n\n}\n\n\n\n/*\nif (msg.pass === \"date_pass\") {\n    msg.topic = \"qpig\";\n    msg.payload = createMessage(\"QPIGS\", msg.voltronicNum); \n    node.send(msg);\n}\n\nif (msg.pass === \"qpig_pass\") {\n    msg.topic = \"qmod\";\n    msg.payload = createMessage(\"QMOD\", msg.voltronicNum); \n    node.send(msg);\n}\n\nif (msg.pass === \"qmod_pass\") {\n    msg.topic = \"qpiws\";\n    msg.payload = createMessage(\"QPIWS\", msg.voltronicNum); \n    node.send(msg);\n}\n\nif (msg.pass === \"qpiws_pass\") {\n    msg.topic = \"qbeqi\";\n    msg.payload = createMessage(\"QBEQI\", msg.voltronicNum);\n    node.send(msg);\n}\n\nif (msg.pass === \"qbeqi_pass\") {\n    msg.topic = \"qflag\";\n    msg.payload = createMessage(\"QFLAG\", msg.voltronicNum); \n    node.send(msg);\n}\n\nif (msg.pass === \"qflag_pass\") {\n    msg.topic = \"qpiri\";\n    msg.payload = createMessage(\"QPIRI\", msg.voltronicNum);\n    node.send(msg);\n}\n\nif (msg.pass === \"qpiri_pass\") {\n    if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qpigs2') !== \"NAK\") {\n        msg.topic = \"qpigs2\";\n        msg.payload = createMessage(\"QPIGS2\", msg.voltronicNum);\n        node.send(msg);\n    } else {\n        msg.pass = \"qpigs2_pass\";\n    }\n}\n\nif (msg.pass === \"qpigs2_pass\") {\n    if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qled') !== \"NAK\") {\n        msg.topic = \"qled\";\n        msg.payload = createMessage(\"QLED\", msg.voltronicNum);\n        node.send(msg);\n    } else {\n        msg.pass = \"qled_pass\";\n    }\n}\n\nif (msg.pass === \"qled_pass\") {\n    if (global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qled') !== \"NAK\") {\n        msg.topic = \"date\";\n        msg.payload = createMessage(\"QT\", msg.voltronicNum);\n        node.send(msg);\n    } else {\n        msg.pass = \"date_pass\";\n    }\n}\n\n*/\nfunction createMessage(command, voltronicNum) {\n    // Encode la commande en HEX et ajoute le CRC\n    let commandHex = Buffer.from(command).toString('hex');\n    let crc = crc16(command).toString(16); // Calcul du CRC16\n    let messageHex = commandHex + crc + \"0D\"; // Ajout du CRC et du retour chariot\n    return Buffer.from(messageHex, \"hex\");\n}\n\n// Fonction de calcul CRC16 XModem\nfunction crc16(str, crc = 0, xorout = 0) {\n    for (let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return crc ^ xorout;\n}\n\n    /*\n    if (msg.pass === msg.topic) {\n        if ( global.get('onduleurs.onduleur_' + msg.voltronicNum + '.qpgs') != false ){\n        \n        let seconde = tempIntervalRequete * 11;\n        for (let i = 2; i <= 8; i++) {\n            setTimeout(function () {\n                msg.topic = \"qpgs\" + i;\n                msg.payload =   (i == 1 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_1\") == true) ? new Buffer([81,80,71,83,49,47,251,13]) :\n                                (i == 2 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_2\") == true) ? new Buffer([81,80,71,83,50,31,152,13]) :\n                                (i == 3 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_3\") == true) ? new Buffer([81,80,71,83,51,15,185,13]) :\n                                (i == 4 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_4\") == true) ? new Buffer([81,80,71,83,52,127,94,13]) :\n                                (i == 5 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_5\") == true) ? new Buffer([81,80,71,83,53,111,127,13]) :\n                                (i == 6 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_6\") == true) ? new Buffer([81,80,71,83,54,95,28,13]) :\n                                (i == 7 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_7\") == true) ? new Buffer([81,80,71,83,55,79,61,13]) :\n                                (i == 8 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_8\") == true) ? new Buffer([81,80,71,83,56,190,210,13]) :\n                                (i == 9 && global.get(\"onduleurs.onduleur_\" + msg.voltronicNum + \".qpgs_9\") == true) ? new Buffer([81,80,71,83,57,174,243,13]) :\n                            'erreur';\n                    if (msg.payload != 'erreur'){\n\n                        node.send(msg);\n                        \n                    }\n\n            }, seconde+i*1100 );\n        }\n\n        }\n    }*/\n\n\n\n\n\n\n\n    const interval = 30000; // Utilise 2 minute par d√©faut\n\n\n    // R√©cup√©rer le temps actuel\n    const currentTime = Date.now();\n\n    // V√©rifier le temps de la derni√®re ex√©cution\n    let lastSent = flow.get(\"lastSentOnduleur\" + msg.voltronicNum) || 0;\n\n    // Si le temps est supp√©rieur, envoie le message\n    if (currentTime - lastSent >= interval) {\n\n                msg.payload = \"Alerte : Pas de mise √† jour re√ßue depuis plus de 2 minutes ! \" + msg.voltronicNum;\n                msg.topic = \"erreur\"\n                node.send([, msg]);\n\n\n    }\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":20,"wires":[[]]},{"id":"f0bc5109d49ccdbd","type":"function","z":"23fac679e003f079","g":"c315db128200ad39","name":"Ancien Temps d'attente","func":"// R√©cup√©rer la valeur pr√©c√©dente stock√©e dans un contexte global\nlet ancienneValeur = flow.get(\"ancienneValeur_\" + msg.voltronicNum);\n\n// Variable pour v√©rifier si un message a √©t√© re√ßu r√©cemment\nlet dernierMessageTemps = flow.get(\"dernierMessageTemps\") || Date.now();\n\nif (ancienneValeur !== msg.pass){\n\n    // Si c'est diff√©rent, mettre √† jour l'ancienne valeur et envoyer le message\n    flow.set(\"ancienneValeur_\" + msg.voltronicNum, msg.pass);\n\n    // Mettre √† jour l'heure du dernier message\n    flow.set(\"dernierMessageTemps_\" + msg.voltronicNum, Date.now());\n\n    // R√©initialiser la variable d'alerte\n    flow.set(\"alerteEnvoyee\", false);\n\n    setTimeout(function () {\n        // Mise √† jour de l'heure du dernier message avant envoi\n        flow.set(\"dernierMessageTemps_\" + msg.voltronicNum, Date.now());\n\n        // Envoyer le message\n        node.send(msg);\n\n    }, global.get(\"parametre.config.interval\") * 1000);  // intervalle en secondes\n\n}\n\n/*\nAttente\n\n    // D√©lai de 10 secondes pour v√©rifier si la date a √©t√© mise √† jour\n    setTimeout(function () {\n        // V√©rifier si la date a √©t√© mise √† jour\n        let tempsEcoule = Date.now() - flow.get(\"dernierMessageTemps_\" + msg.voltronicNum);\n\n        // V√©rifier si plus de 10 secondes se sont √©coul√©es et si l'alerte n'a pas d√©j√† √©t√© envoy√©e\n        if (tempsEcoule >= 9000 && !flow.get(\"alerteEnvoyee\")) {\n            // Si 10 secondes se sont √©coul√©es et que la date n'a pas chang√©, envoyer un message\n            node.send(msg);\n\n            // Marquer l'alerte comme envoy√©e pour ne pas renvoyer plusieurs fois\n            flow.set(\"alerteEnvoyee\", true);\n        } \n    }, global.get(\"parametre.config.interval\") * 1000 + 10000); // 10 secondes\n\n*/\n\n/*\nancienne \n\n// R√©cup√©rer la valeur pr√©c√©dente stock√©e dans un contexte global\nlet ancienneValeur = flow.get(\"ancienneValeur\");\n\n// Variable pour v√©rifier si un message a √©t√© re√ßu r√©cemment\nlet dernierMessageTemps = flow.get(\"dernierMessageTemps\") || Date.now();\n\n// V√©rifier si la valeur actuelle est diff√©rente de l'ancienne\nif (msg.payload !== ancienneValeur) {\n    // Si c'est diff√©rent, mettre √† jour l'ancienne valeur et envoyer le message\n    flow.set(\"ancienneValeur\", msg.payload);\n\n    // Mettre √† jour l'heure du dernier message\n    flow.set(\"dernierMessageTemps\", Date.now());\n\n    setTimeout(function () {\n        // Mise √† jour de l'heure du dernier message avant envoi\n        flow.set(\"dernierMessageTemps\", Date.now());\n\n        // Envoyer le message\n        node.send(msg);\n        \n    }, global.get(\"parametre.config.interval\") * 1000);  // intervalle en secondes\n\n}\n*/\n/*\nsetTimeout(function () {\n    node.send(msg);\n}, global.get(\"parametre.config.interval\") * 1000);\n\n*/\n\n\n/*function runScript() {\n    // R√©cup√©rer l'intervalle global\n    const interval = global.get(\"parametre.config.interval\") * 1000 || 1000; // Utilise 7 secondes par d√©faut\n\n    // R√©cup√©rer le temps actuel\n    const currentTime = Date.now();\n\n    // V√©rifier le temps de la derni√®re ex√©cution\n    let lastSent = context.get(\"lastSent\" + msg.voltronicNum) || 0;\n\n    // Si 7 secondes se sont √©coul√©es, envoie le message\n    if (currentTime - lastSent >= interval) {\n        context.set(\"lastSent\" + msg.voltronicNum, currentTime); // Met √† jour le temps de derni√®re ex√©cution\n        node.send(msg);  // Envoie le message\n    }else {\n        // Si le temps n'est pas encore √©coul√©, red√©marre le script apr√®s 1,5 seconde\n        setTimeout(runScript, global.get(\"parametre.config.interval\") * 1500);\n       \n    }\n\n    // Sinon, retourne null pour ne rien envoyer\n    return null;\n}\n\n// Appel initial du script\nrunScript();\n*/\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":160,"wires":[[]]},{"id":"507ec00ee8a2ec38","type":"inject","z":"23fac679e003f079","g":"334bc0f1b0993a0a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"voltronicNum","v":"1","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"qdop","payload":"(1 3 0 0 00.0 42.4 999 40 020 060 015 015 00 23 46.0 000 020T}","payloadType":"str","x":150,"y":720,"wires":[["aee9639d9e60f5e8"]]},{"id":"8044ac963c7fd2b1","type":"function","z":"23fac679e003f079","name":"Futur fonction parametre ","func":"\n// nombre d'entr√©e onduleur\nlet count = global.get(\"countUSBOnduleur\")\n\n/********************* si ip *********************/\nfor (let i = 1; i <= count; i++) {\n\n    let dir = global.get(\"parametre.mqtt.DirSmart\") + '/Modification-voltronic/' + i + '/Param';\n    //let payload = '';\n    \n\n    /*-------------------------------------------------*/\n    //parametre 01\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '01') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"POP\";\n        //option remplace\n        msg.option = (msg.payload == \"UTI\") ? \"00\" :\n                     (msg.payload == \"SOL\") ? \"01\" :\n                     (msg.payload == \"SBU\") ? \"02\" :\n                     'Erreur';\n        msg.payload =  msg.option;\n        \n    }\n\n    /*-------------------------------------------------*/\n    //parametre 02\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '02') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"MNCHGC\";\n        //option remplace\n        msg.option =   (global.get(\"onduleurs.onduleur_\" + i + \".qpgs_1\") == false) ? msg.payload :\n                        \"0\" + msg.payload;\n\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 05\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '05') {\n    \n        msg.voltronicNum = i;\n        \n        msg.command = \"PBT\";\n        //option remplace\n        msg.option = (msg.payload == \"AGM\") ? \"00\" :\n                    (msg.payload == \"Flooded\") ? \"01\" :\n                    (msg.payload == \"User\") ? \"02\" :\n                    (msg.payload == \"Pylon\") ? \"03\" :\n                    (msg.payload == \"Weco\") ? \"05\" :\n                    (msg.payload == \"Soltaro\") ? \"06\" :\n                    (msg.payload == \"Lib\") ? \"08\" :\n                    (msg.payload == \"Lic\") ? \"09\" :\n                    'Erreur';\n        msg.payload = msg.option;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 11 - ‚úÖ MUCHGC + 4 chiffres (0100, 0040...)\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '11') {\n        msg.voltronicNum = i;\n\n        msg.command = \"MUCHGC\";\n\n        // Nettoie 'A' et convertit\n        let cleanAmp = msg.payload.toString().replace(/[A]/gi, '');\n        let amp = parseInt(cleanAmp).toString();\n\n        // TOUJOURS 4 chiffres (MUCHGC0100)\n        msg.option = \"0\" + amp.padStart(3, '0');\n\n        node.status({\n            fill: \"yellow\",\n            shape: \"ring\",\n            text: `MUCHGC${msg.option}`\n        });\n    }\n\n\n    /*-------------------------------------------------*/\n    //parametre 12\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '12') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBCV\";\n        //option remplace\n\n        let payload = msg.payload.toString();\n        // V√©rifier si la longueur de la cha√Æne est 2 (par exemple \"49\")\n        if (payload.length === 2) {\n            // Ajouter \".0\" √† la fin de la cha√Æne\n            msg.option = payload + \".0\";\n        } else {\n            // Si ce n'est pas une valeur de deux caract√®res, on laisse tel quel\n            msg.option = payload;\n        }\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 13\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '13') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PBDV\";\n        \n        //option remplace\n        let payload = msg.payload.toString();\n        // V√©rifier si la longueur de la cha√Æne est 2 (par exemple \"49\")\n        if (payload.length === 2) {\n            // Ajouter \".0\" √† la fin de la cha√Æne\n            msg.option = payload + \".0\";\n        } else {\n            // Si ce n'est pas une valeur de deux caract√®res, on laisse tel quel\n            msg.option = payload;\n        }\n        \n    }\n\n    /*-------------------------------------------------*/\n    //parametre 16\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '16') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PCP\";\n        //option remplace\n        msg.option = (msg.payload == \"CSO\") ? \"01\" :\n                    (msg.payload == \"SNU\") ? \"02\" :\n                    (msg.payload == \"OSO\") ? \"03\" :\n                    'Erreur';\n        msg.payload = msg.option;\n\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 26\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '26') {\n\n        \n        //option remplace\n        msg.voltronicNum = i;\n        \n        msg.command = \"PCVV\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 27\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '27') {\n\n        msg.voltronicNum = i;\n\n        msg.command = \"PBFT\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //parametre 29\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '29') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PSDV\";\n        //option remplace\n        msg.option = msg.payload;\n    }\n\n    /*-------------------------------------------------*/\n    //Parametre 91 Led Enable or Disable\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '91' || msg.topic == dir + '96' || msg.topic == dir + '97' || msg.topic == dir + '98') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDE\";\n        //option remplace\n         msg.option = (msg.payload == \"ON\") ? \"1\" :\n                    (msg.payload == \"OFF\") ? \"0\" :\n                    'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 92 Luminosit√© Led\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '92') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDB\";\n        //option remplace\n         msg.option = (msg.payload == \"Faible\") ? \"0\" :\n                    (msg.payload == \"Moyen\") ? \"1\" :\n                    (msg.payload == \"Haut\") ? \"2\" :\n                    'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 93 Vitesse Led\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '93') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDB\";\n        //option remplace\n         msg.option = (msg.payload == \"Faible\") ? \"0\" :\n                    (msg.payload == \"Moyen\") ? \"1\" :\n                    (msg.payload == \"Rapide\") ? \"2\" :\n                    'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 94 Effet Led\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '94') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDM\";\n        //option remplace\n        msg.option = (msg.payload == \"Circulaire\") ? \"0\" :\n                    (msg.payload == \"Roue\") ? \"1\" :\n                    (msg.payload == \"Chasing\") ? \"2\" :\n                    (msg.payload == \"Fixe\") ? \"3\" :\n                    'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 95 Effet Led DATA\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '95') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDM\";\n        //option remplace\n        msg.option = (msg.payload == \"Puissance PV\") ? \"0\" :\n                    (msg.payload == \"SoC Batterie\") ? \"1\" :\n                    (msg.payload == \"Pourcentage de charge\") ? \"2\" :\n                    (msg.payload == \"Source\") ? \"3\" :\n                    (msg.payload == \"Charge Decharge\") ? \"4\" :\n                    'Erreur';\n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 96 Led RVB\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '96RVB') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDC1\";\n        //option remplace\n        \n        function formatNumber(num) {\n            return String(num).padStart(3, '0');\n        }\n\n        // V√©rifie si msg.payload est une cha√Æne et la convertit en tableau de nombres\n        if (typeof msg.payload === 'string') {\n            msg.payload = msg.payload.split(',').map(Number);\n        }\n\n        // V√©rifie que msg.payload est un tableau avant d'appliquer map\n        if (Array.isArray(msg.payload)) {\n            msg.option = msg.payload.map(formatNumber).join('');\n        } \n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 97 Led RVB\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '97RVB') {\n\n        msg.voltronicNum = i;\n        \n        msg.command = \"PLEDC2\";\n        //option remplace\n         function formatNumber(num) {\n            return String(num).padStart(3, '0');\n        }\n\n        // V√©rifie si msg.payload est une cha√Æne et la convertit en tableau de nombres\n        if (typeof msg.payload === 'string') {\n            msg.payload = msg.payload.split(',').map(Number);\n        }\n\n        // V√©rifie que msg.payload est un tableau avant d'appliquer map\n        if (Array.isArray(msg.payload)) {\n            msg.option = msg.payload.map(formatNumber).join('');\n        } \n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre 98 Led RVB\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + '98RVB') {\n\n         function formatNumber(num) {\n            return String(num).padStart(3, '0');\n        }\n\n        // V√©rifie si msg.payload est une cha√Æne et la convertit en tableau de nombres\n        if (typeof msg.payload === 'string') {\n            msg.payload = msg.payload.split(',').map(Number);\n        }\n\n        // V√©rifie que msg.payload est un tableau avant d'appliquer map\n        if (Array.isArray(msg.payload)) {\n            msg.option = msg.payload.map(formatNumber).join('');\n        } \n    }\n\n    /*-------------------------------------------------*/\n    //Param√®tre Date\n    /*-------------------------------------------------*/\n    if (msg.topic == dir + 'Date') {\n\n        msg.voltronicNum = i;\n        const now = new Date();\n\n        const year = String(now.getFullYear()).slice(-2); // Derniers 2 chiffres de l'ann√©e\n        const month = String(now.getMonth() + 1).padStart(2, '0'); // Mois (0-11 donc +1)\n        const day = String(now.getDate()).padStart(2, '0'); // Jour\n        const hours = String(now.getHours()).padStart(2, '0'); // Heures\n        const minutes = String(now.getMinutes()).padStart(2, '0'); // Minutes\n        const seconds = String(now.getSeconds()).padStart(2, '0'); // Secondes\n\n        msg.command = \"DAT\";\n        msg.option = year + month + day + hours + minutes + seconds ;\n        \n    }\n\n    /*-------------------------------------------------*/\n    //Autre (commande manuel)\n    /*-------------------------------------------------*/\n\n    if (msg.topic == dir + 'Com') {\n\n        msg.voltronicNum = i;\n        msg.topic = \"command\";\n        msg.command = msg.payload;\n        msg.option = '';\n    }\n}\n\n\nlet command = msg.command + msg.option ; //Commande a envoyer\nmsg.payload = command;\n\n// Encode la commande en HEX\nlet commandHex = Buffer.from(command).toString('hex'); \n\n// Commande en hex + calcul crc et ajoute le retour chariot a la fin\nmsg.payload = commandHex + crc16(command).toString(16) + \"0D\"; \n\n// Transformation de la chaine de caractere en Buffer\n//msg.topic = \"false\";\nmsg.payload = Buffer.from(msg.payload, \"hex\");\nnode.send(msg);\n\n/****************************************** */\n//Evoyer un QPIRI ou un QLED pour rafraichir\n/****************************************** */\n// Liste des commandes LED\nconst commandesLED = [\"PLEDE\", \"PLEDB\", \"PLEDM\", \"PLEDC1\", \"PLEDC2\"];\n\n// Sauvegarde du voltronicNum\nlet voltronicNumLocal = msg.voltronicNum;\n\n// D√©terminer le topic et la commande √† envoyer\nlet topicRefresh, commandToSend;\n\nif (commandesLED.includes(msg.command)) {\n    topicRefresh = \"qled\";\n    commandToSend = \"QLED\"; // QLED pur, pas de num√©ro ajout√©\n} else {\n    topicRefresh = \"qpiri\";\n    commandToSend = \"QPIRI\"; // QPIRI pur\n}\n\n// Timer 1 seconde pour envoyer le message\nsetTimeout(() => {\n    // Calcul CRC correct sur la commande ASCII\n    let commandHex = Buffer.from(commandToSend).toString('hex'); \n    msg.payload = commandHex + crc16(command).toString(16) + \"0D\"; \n    msg.topic = topicRefresh;\n    msg.payload = Buffer.from(msg.payload, \"hex\");\n\n    node.send(msg);\n}, 1000);\n\n\n\n\n\n//Fonction de calcul crc16 XModem\nfunction crc16(str, crc = 0, xorout = 0) {\n    for(let i = 0, t; i < str.length; i++, crc &= 0xFFFF) {\n        t = (crc >> 8) ^ str.charCodeAt(i);\n        t ^= t >> 4;\n        crc = (crc << 8) ^ (t << 12) ^ (t << 5) ^ t;\n    }\n    return crc ^ xorout;\n}\n\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":1220,"wires":[[]]}]